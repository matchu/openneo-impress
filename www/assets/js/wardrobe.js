var View={},Partial={},main_wardrobe,ITEMS_SERVER="items.impress.openneo.net";if(document.location.hostname.substr(0,5)=="beta.")ITEMS_SERVER="beta."+ITEMS_SERVER;ITEMS_SERVER="http://"+ITEMS_SERVER;window.log=window.SWFLog=$.noop;
function arraysMatch(c,m){var k;if(!$.isArray(c)||!$.isArray(m))return c==m;k=[];if(!c[0]||!m[0])return false;if(c.length!=m.length)return false;for(var g=0;g<c.length;g++){key=typeof c[g]+"~"+c[g];if(k[key])k[key]++;else k[key]=1}for(g=0;g<m.length;g++){key=typeof m[g]+"~"+m[g];if(k[key])if(k[key]==0)return false;else k[key]--;else return false}return true}Array.prototype.map=function(c){return $.map(this,function(m){return m[c]})};function DeepObject(){}
DeepObject.prototype.deepGet=function(){var c=this;$.each(arguments,function(){c=c[this];if(typeof c=="undefined")return false});return c};DeepObject.prototype.deepSet=function(){var c=$.proxy(Array.prototype.pop,"apply"),m=c(arguments);c=c(arguments);var k=this;$.each(arguments,function(){if(typeof k[this]=="undefined")k[this]={};k=k[this]});k[c]=m};
function Wardrobe(){function c(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function m(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b]}function k(a){m.apply(this,[a]);c.apply(this)}function g(a){m.apply(this,[a])}function p(a){var b=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(e){return this.assets_by_body_id[e.body_id]||[]};this.hasAssetsFitting=function(e){return typeof b.assets_by_body_id[e.body_id]!=
"undefined"&&b.assets_by_body_id[e.body_id].length>0};this.couldNotLoadAssetsFitting=function(e){return typeof b.assets_by_body_id[e.body_id]!="undefined"&&b.assets_by_body_id[e.body_id].length==0};this.update=function(e){for(var f in e)if(e.hasOwnProperty(f)&&f!="id")b[f]=e[f];c.apply(this);this.loaded=true};p.cache[a]=this}function q(a){this.name=a}function r(){}function u(a){var b=this,e=false;this.id=a;this.assets=[];this.loadAssets=function(f){e?f(b):$.getJSON("/biology_assets.json?parent_id="+
b.id,function(o){b.assets=$.map(o,function(w){return new k(w)});e=true;f(b)})};u.cache[a]=this}function v(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(b,e){a.loaded?b(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(f){if(f){for(var o in f)if(f.hasOwnProperty(o))a[o]=f[o];for(f=0;f<a.pet_state_ids.length;f++)a.pet_states.push(u.find(a.pet_state_ids[f]));v.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=
true;b(a)}else e(a)})};this.loadItemAssets=function(b,e){for(var f=[],o=0;o<b.length;o++){var w=b[o];p.find(w).hasAssetsFitting(a)||f.push(w)}f.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:f},function(n){$.each(n,function(){var x=p.find(this.parent_id),A=new g(this);if(typeof x.assets_by_body_id[a.body_id]=="undefined")x.assets_by_body_id[a.body_id]=[];x.assets_by_body_id[a.body_id].push(A)});for(var y=0,j=b.length;y<j;y++){n=p.find(b[y]);n.hasAssetsFitting(a)||(n.assets_by_body_id[a.body_id]=
[])}e()}):e()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(b){for(var e=0;e<this.pet_states.length;e++)if(this.pet_states[e]==b)return true;return false}}function d(){var a=this;this.events={};this.bind=function(b,e){if(typeof this.events[b]=="undefined")this.events[b]=[];this.events[b].push(e)};this.events.trigger=function(b){var e;if(a.events[b]){e=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[b],
function(){this.apply(a,e)})}}}var h=this;p.find=function(a){var b=p.cache[a];b||(b=new p(a));return b};var t=[];p.loadByIds=function(a,b){var e=[],f=[],o=$.map(a,function(w){var n=p.find(w);if(!n.load_started){e.push(w);n.load_started=true}n.loaded||f.push(w);return n});if(e.length)$.getJSON("/objects.json",{ids:e},function(w){var n,y,j,x=[];$.each(w,function(){x.push(+this.id);p.find(this.id).update(this)});for(var A=0;A<t.length;A++){n=t[A];w=n[0];y=n[1];n=n[2];j=true;for(var z=0;z<y.length;z++)if($.inArray(y[z],
x)==-1){j=false;break}j&&n(w)}b(o)});else f.length?t.push([o,f,b]):b(o);return o};var l=ITEMS_SERVER+"/index.js?callback=?";p.loadByQuery=function(a,b,e,f){$.getJSON(l,{q:a,per_page:21,page:b},function(o){var w=[],n,y;if(o.items){for(var j=0;j<o.items.length;j++){y=o.items[j];n=p.find(y.id);n.update(y);w.push(n)}e(w,o.total_pages)}else o.error&&f(o.error)})};p.cache={};q.loadAll=function(a){$.getJSON(ITEMS_SERVER+"/item_zone_sets.js?callback=?",function(b){for(var e=0,f=b.length;e<f;e++)q.all.push(new q(b[e]));
a(q.all)})};q.all=[];r.loadAll=function(a){$.getJSON("/pet_attributes.json",function(b){a(b)})};u.find=function(a){var b=u.cache[a];b||(b=new u(a));return b};u.cache={};v.cache_by_color_and_species=new DeepObject;v.findOrCreateByColorAndSpecies=function(a,b){var e=v.cache_by_color_and_species.deepGet(a,b);if(!e){e=new v;e.color_id=a;e.species_id=b}return e};d.Outfit=function(){function a(){var j=[],x=n.items.concat(n.pet_state.assets);$.each(x,function(){j=j.concat(this.restricted_zones)});return j}
function b(j){n.events.trigger("updateItems",j)}function e(j){n.events.trigger("updatePetState",j)}function f(j){if(!n.pet_state||!j.ownsPetState(n.pet_state))n.setPetStateById();n.events.trigger("petTypeLoaded",j);w()}function o(j){n.events.trigger("petTypeNotFound",j)}function w(j){n.pet_type&&n.pet_type.loaded&&y.length&&n.pet_type.loadItemAssets(y,function(){var x,A,z,E,B,F=[],G=[];if(j){x=j.getAssetsFitting(n.pet_type).map("zone_id");A=x.length;for(var C=0;C<n.items.length;C++){z=n.items[C];
E=z.getAssetsFitting(n.pet_type).map("zone_id");B=true;if(z!=j)for(var D=0;D<A;D++)if($.inArray(x[D],E)!=-1){B=false;break}if(B){F.push(z);G.push(z.id)}}n.items=F;y=G;n.events.trigger("updateItems",n.items)}n.events.trigger("updateItemAssets")})}var n=this,y=[];this.items=[];this.addItem=function(j){if($.inArray(j,n.items)==-1){this.items.push(j);y.push(j.id);w(j);n.events.trigger("updateItems",this.items)}};this.getVisibleAssets=function(){for(var j=this.pet_state.assets,x=a(),A=[],z=0;z<n.items.length;z++)j=
j.concat(n.items[z].getAssetsFitting(n.pet_type));$.each(j,function(){$.inArray(this.zone_id,x)==-1&&A.push(this)});return A};this.removeItem=function(j){var x=$.inArray(j,this.items);if(x!=-1){this.items.splice(x,1);j=$.inArray(j.id,y);y.splice(j,1);n.events.trigger("updateItems",this.items)}};this.setPetStateById=function(j){if(!j&&this.pet_type)j=this.pet_type.pet_state_ids[0];if(j){this.pet_state=u.find(j);this.pet_state.loadAssets(e)}};this.setPetTypeByColorAndSpecies=function(j,x){this.pet_type=
v.findOrCreateByColorAndSpecies(j,x);n.events.trigger("updatePetType",this.pet_type);this.pet_type.load(f,o)};this.setItemsByIds=function(j){if(j)y=j;if(j&&j.length)this.items=p.loadByIds(j,b);else{this.items=[];b(this.items)}w()}};d.Closet=function(){function a(f){b.events.trigger("updateItems",f)}var b=this,e=[];this.items=[];this.addItem=function(f){if($.inArray(f,b.items)==-1){this.items.push(f);e.push(f.id);b.events.trigger("updateItems",this.items)}};this.removeItem=function(f){var o=$.inArray(f,
this.items);if(o!=-1){this.items.splice(o,1);f=$.inArray(f.id,e);e.splice(f,1);b.events.trigger("updateItems",this.items)}};this.setItemsByIds=function(f){if(f&&f.length){e=f;this.items=p.loadByIds(f,a)}else{e=f;this.items=[];a(this.items)}}};d.BasePet=function(){var a=this;this.setName=function(b){a.name=b;a.events.trigger("updateName",b)}};d.PetAttributes=function(){function a(e){b.events.trigger("update",e)}var b=this;this.load=function(){r.loadAll(a)}};d.ItemZoneSets=function(){function a(e){b.events.trigger("update",
e)}var b=this;this.load=function(){q.loadAll(a)}};d.Search=function(){function a(e){b.events.trigger("error",e)}var b=this;this.request={};this.setItemsByQuery=function(e,f){b.request={query:e,page:f};b.events.trigger("updateRequest",b.request);if(e&&f){p.loadByQuery(e,f,function(o,w){b.events.trigger("updateItems",o);b.events.trigger("updatePagination",f,w)},a);b.events.trigger("startRequest")}else{b.events.trigger("updateItems",[]);b.events.trigger("updatePagination",0,0)}}};var i;for(var s in d)if(d.hasOwnProperty(s)){i=
s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();h[i]=new d[s];d.apply(h[i])}this.initialize=function(){var a;for(var b in h.views)if(h.views.hasOwnProperty(b)){a=h.views[b];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){h.views={};$.each(a,function(b){h.views[b]=new this(h)})}}
Partial.ItemSet=function(c,m){function k(d){return function(h){for(var t,l=0;l<q.length;l++){t=q[l];in_set=$.inArray(t,h)!=-1;$("li.object-"+t.id).toggleClass(d,in_set).data("item",t).data(d,in_set).children("ul").children("li.control-set-for-"+d).remove().end()[d=="worn"?"prepend":"append"](Partial.ItemSet.CONTROL_SETS[d][in_set].clone())}}}function g(d){for(var h,t,l=0,i=d.length;l<i;l++){h=d[l];t=h.couldNotLoadAssetsFitting(c.outfit.pet_type);$("li.object-"+h.id).toggleClass("no-assets",t)}}var p=
$(m),q=[],r,u,v;Partial.ItemSet.setWardrobe(c);r=k("closeted");v=k("worn");u=function(d){v(d);g(d)};this.setItems=function(d){var h,t;q=d;p.children().remove();for(var l=0;l<q.length;l++){d=q[l];h=$("<li/>",{"class":"object object-"+d.id});img=$("<img/>",{src:d.thumbnail_url,alt:d.description,title:d.description});t=$("<ul/>");h.append(img).append(t).append(d.name).appendTo(p)}r(c.closet.items);u(c.outfit.items)};c.outfit.bind("updateItemAssets",function(){g(c.outfit.items)});c.outfit.bind("updateItems",
u);c.closet.bind("updateItems",r)};Partial.ItemSet.CONTROL_SETS={};
Partial.ItemSet.setWardrobe=function(c){for(var m,k,g,p,q,r={},u=0;u<2;u++){m=u==0?"worn":"closeted";k=u==0?["Unwear","Wear"]:["Uncloset","Closet"];Partial.ItemSet.CONTROL_SETS[m]={};for(var v=0;v<2;v++){g=v==0;q="control-set control-set-for-"+m;p="control-set-"+(g?"":"not-")+m;q+=" "+p;Partial.ItemSet.CONTROL_SETS[m][g]=$("<a/>",{href:"#",text:k[g?0:1]}).wrap("<li/>").parent().attr("class",q);(function(d,h){$("li."+p+" a").live("click",function(t){var l=$(this).closest(".object").data("item");r[d][!h](l);
t.preventDefault()})})(m,g)}}r.closeted={};r.closeted[true]=$.proxy(c.closet,"addItem");r.closeted[false]=function(d){c.outfit.removeItem(d);c.closet.removeItem(d)};r.worn={};r.worn[true]=function(d){c.closet.addItem(d);c.outfit.addItem(d)};r.worn[false]=$.proxy(c.outfit,"removeItem");Partial.ItemSet.setWardrobe=$.noop};
if(document.location.search.substr(0,6)=="?debug")View.Console=function(c){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var m=["updateItems","updateItemAssets","updatePetType","updatePetState"],k=0;k<m.length;k++)(function(g){c.outfit.bind(g,function(p){log(g,p)})})(m[k]);c.outfit.bind("petTypeNotFound",function(g){log(g.toString()+" not found")})};
View.Closet=function(c){var m=new Partial.ItemSet(c,"#preview-closet ul");c.closet.bind("updateItems",$.proxy(m,"setItems"))};
View.Hash=function(c){function m(){var d=(document.location.hash||document.location.search).substr(1);if(d!=p){var h={},t=d.split("&");q=true;for(var l=0;l<t.length;l++){var i=t[l].split("="),s=decodeURIComponent(i[0]);if(i=decodeURIComponent(i[1]))if(u[s]==r.INTEGER)h[s]=+i;else if(u[s]==r.STRING)h[s]=decodeURIComponent(i).replace(/\+/g," ");else if(s.substr(s.length-2)=="[]"){s=s.substr(0,s.length-2);if(u[s]==r.INTEGER_ARRAY){if(typeof h[s]=="undefined")h[s]=[];h[s].push(+i)}}}if(h.color!==g.color||
h.species!==g.species)c.outfit.setPetTypeByColorAndSpecies(h.color,h.species);if(h.closet)arraysMatch(h.closet,g.closet)||c.closet.setItemsByIds(h.closet.slice(0));else arraysMatch(h.objects,g.closet)||c.closet.setItemsByIds(h.objects.slice(0));arraysMatch(h.objects,g.objects)||c.outfit.setItemsByIds(h.objects.slice(0));h.name!=g.name&&h.name&&c.base_pet.setName(h.name);h.state!=g.state&&c.outfit.setPetStateById(h.state);if(h.search!=g.search||h.search_page!=g.search_page)c.search.setItemsByQuery(h.search,
h.search_page);g=h;q=false;p=d}}function k(d){var h;if(!q){for(var t in d)if(d.hasOwnProperty(t)){h=d[t];if(h===undefined)delete g[t];else g[t]=d[t]}p=d=$.param(g).replace(/%5B%5D/g,"[]");document.location.hash="#"+d;v()}}var g={},p,q=false,r={INTEGER:1,STRING:2,INTEGER_ARRAY:3},u={closet:r.INTEGER_ARRAY,color:r.INTEGER,name:r.STRING,objects:r.INTEGER_ARRAY,search:r.STRING,search_page:r.INTEGER,species:r.INTEGER,state:r.INTEGER},v;this.initialize=function(){m();setInterval(m,100);v()};c.outfit.bind("updateItems",
function(d){d=d.map("id");var h={};if(!arraysMatch(d,g.objects))h.objects=d;h.closet=arraysMatch(d,g.closet)||arraysMatch(d,g.objects)?undefined:c.closet.items.map("id");if(h.objects||h.closet)k(h)});c.outfit.bind("updatePetType",function(d){if(d.color_id!=g.color||d.species_id!=g.species)k({color:d.color_id,species:d.species_id,state:undefined})});c.outfit.bind("petTypeNotFound",function(){window.history.back()});c.outfit.bind("updatePetState",function(d){var h=c.outfit.pet_type;if(d.id!=g.state&&
h&&(g.state||d.id!=h.pet_state_ids[0]))k({state:d.id})});c.search.bind("updateRequest",function(d){if(d.page!=g.search_page||d.query!=g.search)k({search_page:d.page,search:d.query})});(function(){function d(f){if(typeof addthis_share!="undefined"){addthis_share.url=f;i.replaceWith(i.clone());addthis.button(l)}}function h(){if(!b&&!e){b=true;BitlyClient.shorten(a,"BitlyCB."+t)}}var t="shortenResponse",l="#share-button",i=$(l),s=i.parent(),a,b=false,e=false;v=function(){var f=window.location;a=f.protocol+
"//"+f.host+f.pathname+f.hash;d(a);e=false};BitlyCB[t]=function(f){var o,w;for(w in f.results){o="http://outfits.openneo.net/"+f.results[w].hash;break}d(o);b=false;e=true};s.mouseover(h);i.focus(h)})()};
View.Preview=function(c){function m(){var p;if(g)return false;if(k&&k.setAssets){p=c.outfit.getVisibleAssets();k.setAssets(p)}else g=true}$("#preview");var k,g=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){k=document.getElementById("preview-swf");if(g){g=false;m()}};c.outfit.bind("updateItems",m);c.outfit.bind("updateItemAssets",
m);c.outfit.bind("updatePetState",m)};
View.PetStateForm=function(c){function m(q){if(q){g.children("li.selected").removeClass("selected");$(p+"[value="+q.id+"]").attr("checked","checked").parent().addClass("selected")}}var k=$("#pet-state-form"),g=k.children("ul"),p="#pet-state-form input[name=pet_state_id]";$(p).live("click",function(){c.outfit.setPetStateById(+this.value)});c.outfit.bind("petTypeLoaded",function(q){q=q.pet_state_ids;var r,u,v,d;g.children().remove();if(q.length==1)k.hide();else{k.show();for(r=0;r<q.length;r++){u="pet-state-radio-"+
r;v=$("<li/>");d=$("<input/>",{id:u,name:"pet_state_id",type:"radio",value:q[r]});u=$("<label/>",{"for":u,text:r+1});r==0&&d.attr("checked","checked");d.appendTo(v);u.appendTo(v);v.appendTo(g)}m(c.outfit.pet_state)}});c.outfit.bind("updatePetState",m)};
View.PetTypeForm=function(c){function m(p){g&&p&&$.each(k,function(q){k[q].val(p[q+"_id"])})}var k={},g=false;$("#pet-type-form").submit(function(p){p.preventDefault();c.outfit.setPetTypeByColorAndSpecies(+k.color.val(),+k.species.val())}).children("select").each(function(){k[this.name]=$(this)});this.initialize=function(){c.pet_attributes.load()};c.pet_attributes.bind("update",function(p){$.each(p,function(q){var r=k[q];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(r)})});
g=true;m(c.outfit.pet_type)});c.outfit.bind("updatePetType",m);c.outfit.bind("petTypeNotFound",function(){$("#pet-type-not-found").show("normal").delay(3E3).hide("fast")})};
View.Search=function(c){function m(i,s){return function(a){var b=$("<select/>",{"class":"search-helper","data-search-filter":i}),e=$("span.search-helper[data-search-filter="+i+"]");a=s(a);for(var f=0,o=a.length;f<o;f++)$("<option/>",{text:a[f].name}).appendTo(b);e.replaceWith(function(){return b.clone().fadeIn("fast")})}}function k(i){return i.species}var g=$("#preview-search-form"),p=new Partial.ItemSet(c,"#preview-search-form ul"),q=g.find("input[name=query]"),r=$("#preview-search-form-clear"),
u=$("#preview-search-form-error"),v=$("#preview-search-form-help"),d=$("#preview-search-form-loading"),h=$("#preview-search-form-no-results"),t=h.children("span"),l={INNER_WINDOW:4,OUTER_WINDOW:1,GAP_TEXT:"&hellip;",PREV_TEXT:"&larr; Previous",NEXT_TEXT:"Next &rarr;",PAGE_EL:$("<a/>",{href:"#"}),CURRENT_EL:$("<span/>",{"class":"current"}),EL_ID:"#preview-search-form-pagination"};l.EL=$(l.EL_ID);l.GAP_EL=$("<span/>",{"class":"gap",html:l.GAP_TEXT});l.PREV_EL=$("<a/>",{href:"#",rel:"prev",html:l.PREV_TEXT});
l.NEXT_EL=$("<a/>",{href:"#",rel:"next",html:l.NEXT_TEXT});$(l.EL_ID+" a").live("click",function(i){i.preventDefault();i=$(this).data("page");c.search.setItemsByQuery(q.val(),i)});this.initialize=$.proxy(c.item_zone_sets,"load");g.submit(function(i){i.preventDefault();c.search.setItemsByQuery(q.val(),1)});r.click(function(i){i.preventDefault();q.val("");g.submit()});c.search.bind("startRequest",function(){d.delay(1E3).show("slow")});c.search.bind("updateItems",function(i){d.stop(true,true).hide();
p.setItems(i);if(c.search.request.query)i.length||h.show();else v.show()});c.search.bind("updateRequest",function(i){u.hide("fast");v.hide();h.hide();q.val(i.query||"");t.text(i.query);r.toggle(!!i.query)});c.search.bind("updatePagination",function(i,s){var a=i-l.INNER_WINDOW,b=i+l.INNER_WINDOW,e,f,o=1;if(b>s){a-=b-s;b=s}if(a<1){b+=1-a;a=1;if(b>s)b=s}a=[2+l.OUTER_WINDOW,a];b=[b+1,s-l.OUTER_WINDOW];e=a[1]-a[0]>1;f=b[1]-b[0]>1;l.EL.children().remove();for(i>1&&l.PREV_EL.clone().data("page",i-1).appendTo(l.EL);o<=
s;)if(e&&o>=a[0]&&o<a[1]){l.GAP_EL.clone().appendTo(l.EL);o=a[1]}else if(f&&o>=b[0]&&o<b[1]){l.GAP_EL.clone().appendTo(l.EL);o=b[1]}else{o==i?l.CURRENT_EL.clone().text(o).appendTo(l.EL):l.PAGE_EL.clone().text(o).data("page",o).appendTo(l.EL);o++}i<s&&l.NEXT_EL.clone().data("page",i+1).appendTo(l.EL)});c.search.bind("error",function(i){d.stop(true,true).hide();u.text(i).show("normal")});v.find("dt").each(function(){var i=$(this);i.children().length||i.wrapInner($("<a/>",{href:"#"}))}).children("span:not(.search-helper)").each(function(){var i=
$(this);i.replaceWith($("<a/>",{href:"#",text:i.text()}))});v.find("dt a").live("click",function(i){var s=$(this),a=s.parent().children();i.preventDefault();i=a.length?a.map(function(){return this[$(this).is("select")?"value":"innerText"]}).get().join(""):s.text();q.val(i);g.submit()});$("select.search-helper").live("change",function(){var i=$(this),s=i.attr("data-search-filter");$("select.search-helper[data-search-filter="+s+"]").val(i.val())});c.item_zone_sets.bind("update",m("type",function(i){return i}));
c.pet_attributes.bind("update",m("species",k));c.pet_attributes.bind("update",m("only",k))};View.Title=function(c){c.base_pet.bind("updateName",function(m){$("#title").text("Planning "+m+"'s outfit")})};$.ajaxSetup({error:function(){$.jGrowl("There was an error loading that last resource. Oops. Please try again!")}});main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
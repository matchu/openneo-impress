Array.prototype.removeValue=function(n){n=$.inArray(n,this);n!=-1&&this.splice(n,1)};Array.prototype.clone=function(){return this.splice(0)};Array.prototype.toInt=function(){return $.map(this,function(n){return parseInt(n)})};
var MainWardrobe=new (function(){function n(e){function f(c,i){h.push(c+"="+encodeURIComponent(i))}var h=[];$.each(e,function(c,i){$.isArray(i)?$.each(i,function(){f(c+"[]",this)}):f(c,i)});return h.join("&")}function r(e,f,h,c){f=f?n(f):"";var i=e+"?"+f;if($.inArray(i,r.requestsLoading)==-1){r.requestsLoading.push(i);$.ajax($.extend(c,{url:e,data:f,dataType:"json",success:h,complete:function(){r.requestsLoading.removeValue(i)}}))}}function y(e){var f;f=o.pet_type.body_id;e.id=parseInt(e.id);e.parent_id=
parseInt(e.parent_id);for(var h in e)this[h]=e[h];this.constructor.cache[this.id]=this;(e=this.constructor.cache_by_body_and_parent_id[f])||(e=this.constructor.cache_by_body_and_parent_id[f]={});(f=e[this.parent_id])||(f=e[this.parent_id]=[]);f.push(this)}function w(e){this.inheritsFrom=y;this.inheritsFrom(e);this.is_body_specific=this.is_body_specific=="1";this.getObject=function(){return k.find(this.parent_id)}}function x(e){this.inheritsFrom=y;this.inheritsFrom(e)}function k(e,f){this.is_placeholder=
f?true:false;this.addToCloset=function(){var c=s.getObjectIds();c.push(this.id);j.set("closet",c)};this.addToOutfit=function(){this.isCloseted()||this.addToCloset();var c=o.getObjectIds();c.push(this.id);j.set("objects",c);o.removeObjectsConflictingWith(this)};this.getAssetsByBodyId=function(c){c=w.cache_by_body_and_parent_id[c];var i;if(c)i=c[this.id];return i?$.extend(true,[],i):[]};this.hasAssetsWithBodyId=function(c){return this.getAssetsByBodyId(c).length>0};this.isAvailable=function(){return!this.isUnavailable()};
this.isCloseted=function(){return $.inArray(this.id,s.getObjectIds())!=-1};this.isUnavailable=function(){return $.inArray(this.id,s.unavailable_object_ids)!=-1};this.isWorn=function(){return this.isAvailable()&&$.inArray(this.id,o.getObjectIds())!=-1};this.removeFromCloset=function(){this.removeFromOutfit();var c=s.getObjectIds();c.removeValue(this.id);j.set("closet",c)};this.removeFromOutfit=function(){var c=o.getObjectIds();c.removeValue(this.id);j.set("objects",c)};e.id=parseInt(e.id);for(var h in e)this[h]=
e[h];k.cache[this.id]=this}r.requestsLoading=[];$.each([w,x],function(){this.cache={};this.find=function(e){e=parseInt(e);return this.cache[e]};this.cache_by_body_and_parent_id={}});k.cache={};k.find=function(e){e=parseInt(e);var f=k.cache[e];f||(f=new k({id:e},true));return f};var s=new (function(){this.unavailable_object_ids=[];this.setUnavailableObjectIds=function(e){this.unavailable_object_ids=e.toInt();m.updateObjectStatuses()};this.clearObjectStatuses=function(){this.unavailable_object_ids=
[]};this.getObjectIds=function(){return j.get("closet")?j.get("closet").toInt():[]};this.getObjects=function(){return $.map(j.get("closet"),function(e){return k.find(e)})};this.initialize=function(){j.get("objects")&&!j.get("closet")&&j.set("closet",j.get("objects"));this.update()};this.update=function(){var e=j.get("closet");if(e){e=$.grep(j.get("closet"),function(f){return k.find(f).is_placeholder});if(e.length){s.clearObjectStatuses();r("/objects.json",{ids:e},function(f){$.each(f,function(){object=
new k(this)});m.modules.closet.update()})}}}}),j=new (function(){function e(){return(document.location.hash||document.location.search).substr(1)}function f(){i={};var a=e(),d=a.split("&");$.each(d,function(){var g=this.split("="),l=decodeURIComponent(g[0]);g=decodeURIComponent(g[1]);var p=l.match(/(.+)\[\]/);if(p){i[p[1]]||(i[p[1]]=[]);i[p[1]].push(g)}else i[l]=g});b=a}function h(a,d){i[a]=d}function c(){document.location.hash=n(i)}var i=null,b;this.get=function(a){i||f();return i[a]};this.set=function(a,
d){typeof a=="object"?$.each(a,h):h(a,d);c()};setInterval(function(){if(e()!=b){f();o.update();s.update()}},100)}),o=new (function(){function e(b,a){$.each(b,function(){new a(this)})}function f(){if(!c.pet_type)return false;var b=x.cache_by_body_and_parent_id[c.pet_type.body_id],a,d=j.get("state");if(b)a=b[d];if(a){c.biology_assets=a;c.setRestrictedZones();m.Outfit.update()}else r("/biology_assets.json",{parent_id:d},function(g){c.biology_assets=g;e(g,x);c.setRestrictedZones();m.Outfit.update()})}
function h(){var b=j.get("species"),a=j.get("color"),d;if(!c.pet_type||b!=c.pet_type.species_id||a!=c.pet_type.color_id){m.Outfit.hideBiologyAssets();r("/pet_types.json",{"for":"wardrobe",species_id:b,color_id:a},function(g){var l=j.get("state");if(g){c.pet_type&&g.body_id!=c.pet_type.body_id&&m.Outfit.removeBodySpecificAssets();g.species_id=b;g.color_id=a;c.pet_type=g;(l=!l||$.inArray(parseInt(l),g.pet_state_ids)==-1)&&j.set("state",g.pet_state_ids[0]);f();m.modules.pet_state.update();c.updateObjects()}else{d=
{title:"Pet not found!"};if(!c.pet_type){d.close=function(){window.location="/"};d.modal=true}m.error("We haven't seen this pet type before. If it's out there, please help us out by <a href='http://beta.impress.openneo.net/pet_types/needed'>helping us find it</a>! Thanks!",d);m.Outfit.showBiologyAssets();if(c.pet_type){j.set({color:c.pet_type.color_id,species:c.pet_type.species_id});m.modules.pet_type.update()}}})}else c.updateObjects()}var c=this,i=[];this.biology_assets=[];this.pet_type=null;this.restricted_zones=
[];this.getAssets=function(){var b=c.biology_assets;$.each(this.getObjectIds(),function(){var a=k.find(this);b=b.concat(a.getAssetsByBodyId(c.pet_type.body_id))});return b};this.getObjectIds=function(){var b=j.get("objects");return b?b.toInt():[]};this.getObjects=function(){return $.map(this.getObjectIds(),function(b){return k.find(b)})};this.removeObjectsConflictingWith=function(b){i.push(b)};this.removeObjectsConflictingWithQueue=function(){$.each(i,function(){var b=this,a=this.getAssetsByBodyId(c.pet_type.body_id);
$.each(a,function(){var d=this;$.each(c.getObjects(),function(){var g;if(b.id!=this.id){g=this.getAssetsByBodyId(c.pet_type.body_id);for(var l in g)g[l].zone_id==d.zone_id&&this.removeFromOutfit()}})})});i=[]};this.setRestrictedZones=function(){var b=this.getObjects().concat(c.biology_assets);this.restricted_zones=[];$.each(b,function(){var a;a=0;if(this.zones_restrict)for(;(a=this.zones_restrict.indexOf("1",a))!=-1;){a=a+1;c.restricted_zones.push(a);a=a}})};this.updateObjects=function(){function b(){var d=
$.grep(a.clone(),function(g){return!k.find(g).hasAssetsWithBodyId(c.pet_type.body_id)});c.setRestrictedZones();c.removeObjectsConflictingWithQueue();s.setUnavailableObjectIds(d);m.Outfit.update()}var a=$.grep(this.getObjectIds(),function(d){return!k.find(d).hasAssetsWithBodyId(c.pet_type.body_id)});a.length?r("/object_assets.json",{parent_ids:a,body_id:c.pet_type.body_id},function(d){e(d,w);b()}):b()};this.updatePetState=function(b){j.set("state",b);f()};this.initialize=this.update=function(){h();
f()}}),B=new (function(){var e=[];this.getObjects=function(){return e};$("#search-form").submit(function(f){f.preventDefault();$("#search-module-error").hide();r("/objects.json",{search:$("#search-form-query").val()},function(h){e=[];$.each(h,function(){e.push(new k(this))});m.modules.search.update()},{error:function(h){$("#search-module-error").text(h.responseText).show();e=[];m.modules.search.update()}})})}),m=this.View=new (function(){function e(b,a){this.afterUpdate=function(){};this.object_owner=
a;this.objects_wrapper_query=b;this.update=function(){var d=$(this.objects_wrapper_query).html("");$.each(this.object_owner.getObjects(),function(){var g=$("<li></li>").attr({id:"object-"+this.id,"class":"object"}).data("object_id",this.id);$("<img />").attr({src:this.thumbnail_url,alt:"",height:80,width:80}).appendTo(g);g.append("<span>"+this.name+"</span>").wrapInner("<div></div>").appendTo(d)});h.updateObjectStatuses();this.afterUpdate()}}function f(){var b={top:null,left:null},a=$(window);available=
{height:a.height()-c.bottom.outerHeight(),width:a.width()-c.right.outerWidth()};$.each(c,function(){this.css(b)});c.right.css("height",null);c.bottom.width(available.width);$("#toolbar-float").css("right",c.right.outerWidth());available.height>available.width?$("#outfit-preview").css({height:available.width,left:null,width:available.width,top:(available.height-available.width)/2}):$("#outfit-preview").css({height:available.height,left:(available.width-available.height)/2,width:available.height,top:null});
h.Outfit.Watermark.update_position();$("#object-description").css({bottom:c.bottom.outerHeight(),right:c.right.outerWidth()})}var h=this;this.Outfit=new (function(){var b=false;this.hideBiologyAssets=function(){};this.removeBodySpecificAssets=function(){$(".body-specific-asset").remove()};this.showBiologyAssets=function(){$(".biology-asset").show()};this.initialize=function(){swfobject.embedSWF("/assets/swf/preview.swf","outfit-preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",
{swf_assets_path:"/assets"},{wmode:"transparent"})};this.setFlashIsReady=function(){if(b){b=false;h.Outfit.update()}};this.update=function(){var a;if(b)return false;a=$("#outfit-preview-swf").get(0);if(a.setAssets){var d=$.grep(o.getAssets(),function(g){return $.inArray(parseInt(g.zone_id),o.restricted_zones)==-1});a.setAssets(d)}else b=true;this.Watermark.update()};this.Watermark=new (function(){var a=this,d,g={r:[0,0.2],e:[0,0.7],s:[0.5,0.2],t:[0.5,0.7],m:[0.25,0.45]},l=false;this.update=function(){function p(){for(var q=
$("#"+d+"s"),t="",v=0;v<25;v++)t+=String.fromCharCode(Math.random()*26+97);q.length&&q.remove();for(var u in g){q=$("."+d+u);if(q.length)q.attr("class",t+u);else{q=$("<div>The Wardrobe</div>");q.attr("class",t+u).appendTo(document.body)}}d=t;a.update_position()}l?p():$(function(){p();l=true})};this.update_position=function(){function p(){var q=$("#outfit-preview"),t=q.height(),v=q.width(),u=q.offset(),z="";$.each(g,function(C,A){z+="."+d+C+" {opacity: .1; filter:alpha(opacity=30);position: absolute;left: "+
(v*A[0]+u.left)+"px;top: "+(t*A[1]+u.top)+"px;width: "+v/2+"px;color: #fff;font-weight: bold;text-align: center;text-shadow: #000 1px 1px;z-index: 100;}"});$('<style type="text/css">'+z+"</style>").attr("id",d+"s").appendTo("head");$("#outfit-preview").css("zIndex",1)}l?p():$(function(){p();l=true})}})});this.modules=[];this.modules.closet=new e("#closet-module-objects",s);this.modules.pet_state=new (function(){this.update=function(){var b=$("#pet-state-list").html(""),a=0;$.each(o.pet_type.pet_state_ids,
function(){var d=this;$("<a/>",{href:"#",text:"State #"+ ++a,click:function(g){g.preventDefault();o.updatePetState(d)}}).wrap("<li/>").parent().appendTo(b)})}});this.modules.pet_type=new (function(){function b(a){return $("#pet-type-form-"+a)}this.update=function(){$.each(["color","species"],function(){var a=j.get(this);b(this).children("option").each(function(){var d=$(this);d.val()==a&&d.attr("selected","selected")})})};r("/pet_attributes.json",null,function(a){$.each(a,function(d,g){var l=b(d);
$.each(g,function(){$('<option value="'+this.id+'">'+this.name+"</option>").appendTo(l)})});h.modules.pet_type.update();$("#pet-type-form").css("visibility","visible")});$("#pet-type-form").submit(function(a){a.preventDefault();var d={};$.each(["species","color"],function(){d[this]=$("#pet-type-form-"+this+" option:selected").val()});j.set(d);o.update()})});this.modules.search=new e("#search-module-objects",B);this.modules.search.afterUpdate=function(){var b=this.object_owner.getObjects(),a=$(this.objects_wrapper_query);
b=a.children(".object:first").outerWidth()*b.length;a.width(b);$("#toolbar-bottom").animate({height:a.outerHeight()+a.position().top},250,f)};this.updateObjectStatuses=function(){$(".object").each(function(){var b=$(this),a=k.find(b.data("object_id"));b.toggleClass("unavailable-object",a.isUnavailable());b.toggleClass("worn-object",a.isWorn())})};var c={},i={ghost:true,stop:f};$.each({bottom:{handles:"n"},right:{handles:"w"}},function(b,a){c[b]=$("#toolbar-"+b).resizable($.extend(i,a))});$(window).resize(f);
f();$(".object").live("mouseenter",function(){var b=$(this),a=$("#object-description");if(!b.children(".object-action").length){var d=k.find(b.data("object_id")),g="";function l(p){var q=p.toLowerCase();$('<a href="#" class="object-action object-action-'+q+'">'+p+"</a>").appendTo(b)}d.isWorn()?l("Unwear"):l("Wear");d.isCloseted()?l("Uncloset"):l("Closet");if(d.isUnavailable())g='<p class="ui-state-error">We haven\'t seen this body type wearing this item before. If you have, go to the homepage and add the pet, so we can get that data! Thanks!</p>';
a.html("<h1>"+d.name+" ("+[d.rarity,d.rarity_index].join(" - ")+")</h1><p>"+d.description+"</p>"+g+"<dl><dt>Type</dt><dd>"+d.type+"</dd><dt>Est. Price</dt><dd>"+d.price+"</dd></dl>").css("backgroundImage","url("+d.thumbnail_url+")").show()}}).live("mouseleave",function(){$(this).children(".object-action").remove();$("#object-description").hide()});this.error=function(b,a){var d=$("#error-dialog");if(d.length)d.dialog("destroy");else d=$("<div/>",{id:"error-dialog"});d.html(b);d.dialog($.extend({title:"Uh oh! Error!"},
a))};$(".object-action-wear").live("click",function(b){var a=$(this).parent();a=k.find(a.data("object_id"));b.preventDefault();a.addToOutfit();o.updateObjects();h.modules.closet.update()});$(".object-action-unwear").live("click",function(b){var a=$(this).parent();a=k.find(a.data("object_id"));b.preventDefault();a.removeFromOutfit();h.Outfit.update();h.modules.closet.update()});$(".object-action-closet").live("click",function(b){var a=$(this).parent();a=k.find(a.data("object_id"));b.preventDefault();
a.addToCloset();h.modules.closet.update()});$(".object-action-uncloset").live("click",function(b){var a=$(this).parent(),d=k.find(a.data("object_id"));b.preventDefault();a.parents("#closet-module").length&&$("#object-description").hide();d.removeFromCloset();h.Outfit.update();h.modules.closet.update()})});m.Outfit.initialize();o.initialize();s.initialize()}),ef=function(){};function log(n){typeof console!="undefined"&&typeof console.log!="undefined"&&console.log(n)}
function dir(n){typeof console!="undefined"&&typeof console.dir!="undefined"&&console.dir(n)};
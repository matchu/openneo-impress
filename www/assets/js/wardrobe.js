Array.prototype.removeValue=function(q){q=$.inArray(q,this);q!=-1&&this.splice(q,1)};Array.prototype.clone=function(){return this.splice(0)};Array.prototype.toInt=function(){return $.map(this,function(q){return parseInt(q)})};
var MainWardrobe=new (function(){function q(d){function f(c,h){i.push(c+"="+encodeURIComponent(h))}var i=[];$.each(d,function(c,h){$.isArray(h)?$.each(h,function(){f(c+"[]",this)}):f(c,h)});return i.join("&")}function r(d,f,i,c){f=f?q(f):"";var h=d+"?"+f;if($.inArray(h,r.requestsLoading)==-1){r.requestsLoading.push(h);$.ajax($.extend(c,{url:d,data:f,dataType:"json",success:i,complete:function(){r.requestsLoading.removeValue(h)}}))}}function y(d){var f;f=n.pet_type.body_id;d.id=parseInt(d.id);d.parent_id=
parseInt(d.parent_id);for(var i in d)this[i]=d[i];this.constructor.cache[this.id]=this;(d=this.constructor.cache_by_body_and_parent_id[f])||(d=this.constructor.cache_by_body_and_parent_id[f]={});(f=d[this.parent_id])||(f=d[this.parent_id]=[]);f.push(this)}function w(d){this.inheritsFrom=y;this.inheritsFrom(d);this.is_body_specific=this.is_body_specific=="1";this.getObject=function(){return k.find(this.parent_id)}}function x(d){this.inheritsFrom=y;this.inheritsFrom(d)}function k(d,f){this.is_placeholder=
f?true:false;this.addToCloset=function(){var c=s.getObjectIds();c.push(this.id);j.set("closet",c)};this.addToOutfit=function(){this.isCloseted()||this.addToCloset();var c=n.getObjectIds();c.push(this.id);j.set("objects",c);n.removeObjectsConflictingWith(this)};this.getAssetsByBodyId=function(c){c=w.cache_by_body_and_parent_id[c];var h;if(c)h=c[this.id];return h?$.extend(true,[],h):[]};this.hasAssetsWithBodyId=function(c){return this.getAssetsByBodyId(c).length>0};this.isAvailable=function(){return!this.isUnavailable()};
this.isCloseted=function(){return $.inArray(this.id,s.getObjectIds())!=-1};this.isUnavailable=function(){return $.inArray(this.id,s.unavailable_object_ids)!=-1};this.isWorn=function(){return this.isAvailable()&&$.inArray(this.id,n.getObjectIds())!=-1};this.removeFromCloset=function(){this.removeFromOutfit();var c=s.getObjectIds();c.removeValue(this.id);j.set("closet",c)};this.removeFromOutfit=function(){var c=n.getObjectIds();c.removeValue(this.id);j.set("objects",c)};d.id=parseInt(d.id);for(var i in d)this[i]=
d[i];k.cache[this.id]=this}r.requestsLoading=[];$.each([w,x],function(){this.cache={};this.find=function(d){d=parseInt(d);return this.cache[d]};this.cache_by_body_and_parent_id={}});k.cache={};k.find=function(d){d=parseInt(d);var f=k.cache[d];f||(f=new k({id:d},true));return f};var s=new (function(){this.unavailable_object_ids=[];this.setUnavailableObjectIds=function(d){this.unavailable_object_ids=d.toInt();o.updateObjectStatuses()};this.clearObjectStatuses=function(){this.unavailable_object_ids=
[]};this.getObjectIds=function(){return j.get("closet")?j.get("closet").toInt():[]};this.getObjects=function(){return $.map(j.get("closet"),function(d){return k.find(d)})};this.initialize=function(){j.get("objects")&&!j.get("closet")&&j.set("closet",j.get("objects"));this.update()};this.update=function(){var d=j.get("closet");if(d){d=$.grep(j.get("closet"),function(f){return k.find(f).is_placeholder});if(d.length){s.clearObjectStatuses();r("/objects.json",{ids:d},function(f){$.each(f,function(){object=
new k(this)});o.modules.closet.update()})}}}}),j=new (function(){function d(){return(document.location.hash||document.location.search).substr(1)}function f(){h={};var b=d(),e=b.split("&");$.each(e,function(){var g=this.split("="),l=decodeURIComponent(g[0]);g=decodeURIComponent(g[1]);var m=l.match(/(.+)\[\]/);if(m){h[m[1]]||(h[m[1]]=[]);h[m[1]].push(g)}else h[l]=g});a=b}function i(b,e){h[b]=e}function c(){document.location.hash=q(h)}var h=null,a;this.get=function(b){h||f();return h[b]};this.set=function(b,
e){typeof b=="object"?$.each(b,i):i(b,e);c()};setInterval(function(){if(d()!=a){f();n.update();s.update()}},100)}),n=new (function(){function d(a,b){$.each(a,function(){new b(this)})}function f(){if(!c.pet_type)return false;var a=x.cache_by_body_and_parent_id[c.pet_type.body_id],b,e=j.get("state");if(a)b=a[e];if(b){c.biology_assets=b;o.Outfit.update()}else r("/biology_assets.json",{parent_id:e},function(g){c.biology_assets=g;d(g,x);o.Outfit.update()})}function i(){var a=j.get("species"),b=j.get("color");
if(!c.pet_type||a!=c.pet_type.species_id||b!=c.pet_type.color_id){o.Outfit.hideBiologyAssets();r("/pet_types.json",{"for":"wardrobe",species_id:a,color_id:b},function(e){var g=j.get("state");if(e){c.pet_type&&e.body_id!=c.pet_type.body_id&&o.Outfit.removeBodySpecificAssets();e.species_id=a;e.color_id=b;c.pet_type=e;(g=!g||$.inArray(parseInt(g),e.pet_state_ids)==-1)&&j.set("state",e.pet_state_ids[0]);f();o.modules.pet_state.update();c.updateObjects()}else{o.error("Pet type not found!");o.Outfit.showBiologyAssets()}})}else c.updateObjects()}
var c=this,h=[];this.biology_assets=[];this.pet_type=null;this.restricted_zones=[];this.getAssets=function(){var a=c.biology_assets;$.each(this.getObjectIds(),function(){var b=k.find(this);a=a.concat(b.getAssetsByBodyId(c.pet_type.body_id))});return a};this.getObjectIds=function(){var a=j.get("objects");return a?a.toInt():[]};this.getObjects=function(){return $.map(this.getObjectIds(),function(a){return k.find(a)})};this.removeObjectsConflictingWith=function(a){h.push(a)};this.removeObjectsConflictingWithQueue=
function(){$.each(h,function(){var a=this,b=this.getAssetsByBodyId(c.pet_type.body_id);$.each(b,function(){var e=this;$.each(c.getObjects(),function(){var g;if(a.id!=this.id){g=this.getAssetsByBodyId(c.pet_type.body_id);for(var l in g)g[l].zone_id==e.zone_id&&this.removeFromOutfit()}})})});h=[]};this.setRestrictedZones=function(){this.restricted_zones=[];$.each(this.getObjects(),function(){var a;a=0;if(this.zones_restrict)for(;(a=this.zones_restrict.indexOf("1",a))!=-1;){a=a+1;c.restricted_zones.push(a);
a=a}})};this.updateObjects=function(){function a(){var e=$.grep(b.clone(),function(g){return!k.find(g).hasAssetsWithBodyId(c.pet_type.body_id)});c.setRestrictedZones();c.removeObjectsConflictingWithQueue();s.setUnavailableObjectIds(e);o.Outfit.update()}var b=$.grep(this.getObjectIds(),function(e){return!k.find(e).hasAssetsWithBodyId(c.pet_type.body_id)});b.length?r("/object_assets.json",{parent_ids:b,body_id:c.pet_type.body_id},function(e){d(e,w);a()}):a()};this.updatePetState=function(a){j.set("state",
a);f()};this.initialize=this.update=function(){i();f()}}),B=new (function(){var d=[];this.getObjects=function(){return d};$("#search-form").submit(function(f){f.preventDefault();$("#search-module-error").hide();r("/objects.json",{search:$("#search-form-query").val()},function(i){d=[];$.each(i,function(){d.push(new k(this))});o.modules.search.update()},{error:function(i){$("#search-module-error").text(i.responseText).show();d=[];o.modules.search.update()}})})}),o=this.View=new (function(){function d(a,
b){this.afterUpdate=function(){};this.object_owner=b;this.objects_wrapper_query=a;this.update=function(){var e=$(this.objects_wrapper_query).html("");$.each(this.object_owner.getObjects(),function(){var g=$("<li></li>").attr({id:"object-"+this.id,"class":"object"}).data("object_id",this.id);$("<img />").attr({src:this.thumbnail_url,alt:"",height:80,width:80}).appendTo(g);g.append("<span>"+this.name+"</span>").wrapInner("<div></div>").appendTo(e)});i.updateObjectStatuses();this.afterUpdate()}}function f(){var a=
{top:null,left:null},b=$(window);available={height:b.height()-c.bottom.outerHeight(),width:b.width()-c.right.outerWidth()};$.each(c,function(){this.css(a)});c.right.css("height",null);c.bottom.width(available.width);$("#toolbar-float").css("right",c.right.outerWidth());available.height>available.width?$("#outfit-preview").css({height:available.width,left:null,width:available.width,top:(available.height-available.width)/2}):$("#outfit-preview").css({height:available.height,left:(available.width-available.height)/
2,width:available.height,top:null});i.Outfit.Watermark.update_position();$("#object-description").css({bottom:c.bottom.outerHeight(),right:c.right.outerWidth()})}var i=this;this.Outfit=new (function(){var a=false;this.hideBiologyAssets=function(){};this.removeBodySpecificAssets=function(){$(".body-specific-asset").remove()};this.showBiologyAssets=function(){$(".biology-asset").show()};this.initialize=function(){swfobject.embedSWF("/assets/swf/preview.swf","outfit-preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",
{swf_assets_path:"/assets"},{wmode:"transparent"})};this.setFlashIsReady=function(){log("received flash ready notice");if(a){a=false;i.Outfit.update()}};this.update=function(){log("update called");var b;if(a)return false;log("no update pending");b=$("#outfit-preview-swf").get(0);if(b.setAssets){var e=$.grep(n.getAssets(),function(g){return $.inArray(parseInt(g.zone_id),n.restricted_zones)==-1});b.setAssets(e)}else{a=true;log("update now pending")}this.Watermark.update()};this.Watermark=new (function(){var b=
this,e,g={r:[0,0.2],e:[0,0.7],s:[0.5,0.2],t:[0.5,0.7],m:[0.25,0.45]},l=false;this.update=function(){function m(){for(var p=$("#"+e+"s"),t="",v=0;v<25;v++)t+=String.fromCharCode(Math.random()*26+97);p.length&&p.remove();for(var u in g){p=$("."+e+u);if(p.length)p.attr("class",t+u);else{p=$("<div>The Wardrobe</div>");p.attr("class",t+u).appendTo(document.body)}}e=t;b.update_position()}l?m():$(function(){m();l=true})};this.update_position=function(){function m(){var p=$("#outfit-preview"),t=p.height(),
v=p.width(),u=p.offset(),z="";$.each(g,function(C,A){z+="."+e+C+" {opacity: .1; filter:alpha(opacity=30);position: absolute;left: "+(v*A[0]+u.left)+"px;top: "+(t*A[1]+u.top)+"px;width: "+v/2+"px;color: #fff;font-weight: bold;text-align: center;text-shadow: #000 1px 1px;z-index: 100;}"});$('<style type="text/css">'+z+"</style>").attr("id",e+"s").appendTo("head");$("#outfit-preview").css("zIndex",1)}l?m():$(function(){m();l=true})}})});this.modules=[];this.modules.closet=new d("#closet-module-objects",
s);this.modules.pet_state=new (function(){this.update=function(){var a=$("#pet-state-list").html("");$.each(n.pet_type.pet_state_ids,function(){var b=this;$("<a/>",{href:"#",text:"State #"+b,click:function(e){e.preventDefault();n.updatePetState(b)}}).wrap("<li/>").parent().appendTo(a)})}});this.modules.pet_type=new (function(){r("/pet_attributes.json",null,function(a){$.each(a,function(b,e){var g=$("#pet-type-form-"+b),l=j.get(b);$.each(e,function(){var m=$('<option value="'+this.id+'">'+this.name+
"</option>");this.id==l&&m.attr("selected","selected");m.appendTo(g)})});$("#pet-type-form").css("visibility","visible")});$("#pet-type-form").submit(function(a){a.preventDefault();var b={};$.each(["species","color"],function(){b[this]=$("#pet-type-form-"+this+" option:selected").val()});j.set(b);n.update()})});this.modules.search=new d("#search-module-objects",B);this.modules.search.afterUpdate=function(){var a=this.object_owner.getObjects(),b=$(this.objects_wrapper_query);a=b.children(".object:first").outerWidth()*
a.length;b.width(a);$("#toolbar-bottom").animate({height:b.outerHeight()+b.position().top},250,f)};this.updateObjectStatuses=function(){$(".object").each(function(){var a=$(this),b=k.find(a.data("object_id"));a.toggleClass("unavailable-object",b.isUnavailable());a.toggleClass("worn-object",b.isWorn())})};var c={},h={ghost:true,stop:f};$.each({bottom:{handles:"n"},right:{handles:"w"}},function(a,b){c[a]=$("#toolbar-"+a).resizable($.extend(h,b))});$(window).resize(f);f();$(".object").live("mouseenter",
function(){var a=$(this),b=$("#object-description");if(!a.children(".object-action").length){var e=k.find(a.data("object_id")),g="";function l(m){var p=m.toLowerCase();$('<a href="#" class="object-action object-action-'+p+'">'+m+"</a>").appendTo(a)}e.isWorn()?l("Unwear"):l("Wear");e.isCloseted()?l("Uncloset"):l("Closet");if(e.isUnavailable())g='<p class="ui-state-error">We haven\'t seen this body type wearing this item before. If you have, go to the homepage and add the pet, so we can get that data! Thanks!</p>';
b.html("<h1>"+e.name+" ("+[e.rarity,e.rarity_index].join(" - ")+")</h1><p>"+e.description+"</p>"+g+"<dl><dt>Type</dt><dd>"+e.type+"</dd><dt>Est. Price</dt><dd>"+e.price+"</dd></dl>").css("backgroundImage","url("+e.thumbnail_url+")").show()}}).live("mouseleave",function(){$(this).children(".object-action").remove();$("#object-description").hide()});this.error=function(a){alert(a)};$(".object-action-wear").live("click",function(a){var b=$(this).parent();b=k.find(b.data("object_id"));a.preventDefault();
b.addToOutfit();n.updateObjects();i.modules.closet.update()});$(".object-action-unwear").live("click",function(a){var b=$(this).parent();b=k.find(b.data("object_id"));a.preventDefault();b.removeFromOutfit();i.Outfit.update();i.modules.closet.update()});$(".object-action-closet").live("click",function(a){var b=$(this).parent();b=k.find(b.data("object_id"));a.preventDefault();b.addToCloset();i.modules.closet.update()});$(".object-action-uncloset").live("click",function(a){var b=$(this).parent(),e=k.find(b.data("object_id"));
a.preventDefault();b.parents("#closet-module").length&&$("#object-description").hide();e.removeFromCloset();i.Outfit.update();i.modules.closet.update()})});o.Outfit.initialize();n.initialize();s.initialize()}),ef=function(){};function log(q){typeof console!="undefined"&&typeof console.log!="undefined"&&console.log(q)};
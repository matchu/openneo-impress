var View={},main_wardrobe;window.log=window.SWFLog=$.noop;function DeepObject(){}DeepObject.prototype.deepGet=function(){var c=this;$.each(arguments,function(){c=c[this];if(typeof c=="undefined")return false});return c};DeepObject.prototype.deepSet=function(){var c=$.proxy(Array.prototype.pop,"apply"),l=c(arguments);c=c(arguments);var i=this;$.each(arguments,function(){if(typeof i[this]=="undefined")i[this]={};i=i[this]});i[c]=l};
function Wardrobe(){function c(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function l(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b]}function i(a){l.apply(this,[a]);c.apply(this)}function f(a){l.apply(this,[a])}function e(a){var b=this;this.id=a;this.assets_by_body_id={};this.loaded=false;this.getAssetsFitting=function(d){return this.assets_by_body_id[d.body_id]||[]};this.hasAssetsFitting=function(d){return typeof b.assets_by_body_id[d.body_id]!=
"undefined"};this.update=function(d){for(var k in d)if(d.hasOwnProperty(k))b[k]=d[k];c.apply(this);this.loaded=true};e.cache[a]=this}function p(){}function q(a){var b=this,d=false;this.id=a;this.assets=[];this.loadAssets=function(k){d?k(b):$.getJSON("/biology_assets.json?parent_id="+b.id,function(n){b.assets=$.map(n,function(t){return new i(t)});d=true;k(b)})}}function r(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(b,d){a.loaded?b(a):$.getJSON("/pet_types.json",{"for":"wardrobe",
color_id:a.color_id,species_id:a.species_id},function(k){if(k){for(var n in k)if(k.hasOwnProperty(n))a[n]=k[n];$.each(a.pet_state_ids,function(){a.pet_states.push(new q(this))});r.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=true;b(a)}else d(a)})};this.loadItemAssets=function(b,d){for(var k=[],n=0;n<b.length;n++){var t=b[n];e.find(t).hasAssetsFitting(a)||k.push(t)}k.length&&$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:k},function(w){$.each(w,function(){var o=
e.find(this.parent_id),u=new f(this);if(typeof o.assets_by_body_id[a.body_id]=="undefined")o.assets_by_body_id[a.body_id]=[];o.assets_by_body_id[a.body_id].push(u)});d([])})};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"}}function j(){var a=this;this.events={};this.bind=function(b,d){if(typeof this.events[b]=="undefined")this.events[b]=[];this.events[b].push(d)};this.events.trigger=function(b){var d;if(a.events[b]){d=Array.prototype.slice.apply(arguments,
[1]);$.each(a.events[b],function(){this.apply(a,d)})}}}var h=this;e.find=function(a){var b=e.cache[a];b||(b=new e(a));return b};e.loadByIds=function(a,b){var d=[],k=$.map(a,function(n){var t=e.find(n);t.loaded||d.push(n);return t});d.length?$.getJSON("/objects.json",{ids:d},function(n){$.each(n,function(){e.find(this.id).update(this)});b(k)}):b(k);return k};e.cache={};p.loadAll=function(a){$.getJSON("/pet_attributes.json",function(b){a(b)})};r.cache_by_color_and_species=new DeepObject;r.findOrCreateByColorAndSpecies=
function(a,b){var d=r.cache_by_color_and_species.deepGet(a,b);if(!d){d=new r;d.color_id=a;d.species_id=b}return d};j.Outfit=function(){function a(){var g=[],v=o.items.concat(o.pet_state.assets);$.each(v,function(){g=g.concat(this.restricted_zones)});return g}function b(g){o.events.trigger("updateItemAssets",g)}function d(g){o.events.trigger("updateItems",g)}function k(g){o.pet_state=g;o.events.trigger("updatePetState",g)}function n(g){g.pet_states[0].loadAssets(k);w()}function t(g){o.events.trigger("petTypeNotFound",
g)}function w(){o.pet_type&&o.pet_type.loaded&&u.length&&o.pet_type.loadItemAssets(u,b)}var o=this,u=[];this.items=[];this.getVisibleAssets=function(){var g=this.pet_state.assets,v=a(),x=[];$.each(this.items,function(){g=g.concat(this.getAssetsFitting(o.pet_type))});$.each(g,function(){$.inArray(this.zone_id,v)==-1&&x.push(this)});return x};this.setPetTypeByColorAndSpecies=function(g,v){this.pet_type=r.findOrCreateByColorAndSpecies(g,v);o.events.trigger("updatePetType",this.pet_type);this.pet_type.load(n,
t)};this.setItemsByIds=function(g){if(g){u=g;this.items=g.length?e.loadByIds(g,d):[]}else this.items=[];w()}};j.BasePet=function(){var a=this;this.setName=function(b){a.name=b;a.events.trigger("updateName",b)}};j.PetAttributes=function(){function a(d){b.events.trigger("update",d)}var b=this;this.load=function(){p.loadAll(a)}};var s;for(var m in j)if(j.hasOwnProperty(m)){s=m.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();h[s]=new j[m];j.apply(h[s])}this.initialize=
function(){var a;for(var b in h.views)if(h.views.hasOwnProperty(b)){a=h.views[b];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){h.views={};$.each(a,function(b){h.views[b]=new this(h)})}}
if(document.location.search.substr(0,6)=="?debug")View.Console=function(c){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};var l=["updateItems","updateItemAssets","updatePetType","updatePetState"];for(var i in l)(function(f){c.outfit.bind(f,function(e){log(f,e)})})(l[i]);c.outfit.bind("petTypeNotFound",function(f){log(f.toString()+" not found")})};
View.Hash=function(c){function l(){var j=(document.location.hash||document.location.search).substr(1);if(j!=e){i(j);e=j}}function i(j){var h={};p=true;$.each(j.split("&"),function(){var s=this.split("="),m=decodeURIComponent(s[0]);if(s=decodeURIComponent(s[1]))if(r[m]==q.INTEGER)h[m]=+s;else if(r[m]==q.STRING)h[m]=s;else if(m.substr(m.length-2)=="[]"){m=m.substr(0,m.length-2);if(r[m]==q.INTEGER_ARRAY){if(typeof h[m]=="undefined")h[m]=[];h[m].push(+s)}}});if(h.color!==f.color||h.species!==f.species)c.outfit.setPetTypeByColorAndSpecies(h.color,
h.species);h.objects!==f.objects&&c.outfit.setItemsByIds(h.objects);h.name!=f.name&&h.name&&c.base_pet.setName(h.name);f=h;p=false}var f={},e,p=false,q={INTEGER:1,STRING:2,ARRAY:3},r={color:q.INTEGER,name:q.STRING,objects:q.INTEGER_ARRAY,species:q.INTEGER};this.initialize=function(){l();setInterval(l,100)};c.outfit.bind("updatePetType",function(j){if(j.color_id!=f.color||j.species_id!=f.species){j={color:j.color_id,species:j.species_id};if(!p){f=$.extend(f,j);e=j=$.param(f);document.location.hash=
"#"+j}}});c.outfit.bind("petTypeNotFound",function(){window.history.back()})};
View.Preview=function(c){function l(){var e;if(f)return false;if(i&&i.setAssets){e=c.outfit.getVisibleAssets();i.setAssets(e)}else f=true}$("#preview");var i,f=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){i=document.getElementById("preview-swf");if(f){f=false;l()}};c.outfit.bind("updateItems",l);c.outfit.bind("updateItemAssets",
l);c.outfit.bind("updatePetState",l)};
View.PetTypeForm=function(c){function l(e){f&&e&&$.each(i,function(p){i[p].val(e[p+"_id"])})}var i={},f=false;$("#pet-type-form").submit(function(e){e.preventDefault();c.outfit.setPetTypeByColorAndSpecies(parseInt(i.color.val()),parseInt(i.species.val()))}).children("select").each(function(){i[this.name]=$(this)});this.initialize=function(){c.pet_attributes.load()};c.pet_attributes.bind("update",function(e){$.each(e,function(p){var q=i[p];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(q)})});
f=true;l(c.outfit.pet_type)});c.outfit.bind("updatePetType",l)};View.Title=function(c){c.base_pet.bind("updateName",function(l){$("#title").text("Planning "+l+"'s outfit")})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
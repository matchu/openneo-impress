var View={},main_wardrobe;window.log=$.noop;function DeepObject(){}DeepObject.prototype.deepGet=function(){var d=this;$.each(arguments,function(){d=d[this];if(typeof d=="undefined")return false});return d};DeepObject.prototype.deepSet=function(){var d=$.proxy(Array.prototype.pop,"apply"),g=d(arguments);d=d(arguments);var j=this;$.each(arguments,function(){if(typeof j[this]=="undefined")j[this]={};j=j[this]});j[d]=g};
function Wardrobe(){function d(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function g(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b]}function j(a){g.apply(this,[a]);d.apply(this)}function i(a){g.apply(this,[a])}function h(a){var b=this;this.id=a;this.assets=[];this.loaded=false;this.update=function(c){$.each(c,function(l,k){b[l]=k});d.apply(this);this.loaded=true};h.cache[a]=this}function o(a){var b=this;this.id=a;this.assets=
[];this.assets.load=function(c){$.getJSON("/biology_assets.json?parent_id="+b.id,function(l){b.assets=$.map(l,function(k){return new j(k)});c(b)})}}function n(){var a=this,b=false;this.pet_states=[];this.load=function(c,l){b?c(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(k){if(k){$.each(k,function(p){a[p]=this});$.each(a.pet_state_ids,function(){a.pet_states.push(new o(this))});n.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);
b=true;c(a)}else l(a)})};this.loadItemAssets=function(c,l){$.getJSON("/object_assets.json?body_id="+a.body_id,{parent_ids:c},function(k){var p=[];$.each(k,function(){var s=h.find(this.parent_id),m=new i(this);s.assets.push(m);p.push(m)});l(p)})};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"}}var f=this;this.events={};this.events.trigger=function(a){var b;if(f.events[a]){b=Array.prototype.slice.apply(arguments,[1]);$.each(f.events[a],function(){this.apply(f,
b)})}};h.find=function(a){var b=h.cache[a];b||(b=new h(a));return b};h.loadByIds=function(a,b){var c=[],l=$.map(a,function(k){var p=h.find(k);p.loaded||c.push(k);return p});c.length?$.getJSON("/objects.json",{ids:c},function(k){$.each(k,function(){h.find(this.id).update(this)});b(l)}):b(l);return l};h.cache={};n.cache_by_color_and_species=new DeepObject;n.findOrCreateByColorAndSpecies=function(a,b){var c=n.cache_by_color_and_species.deepGet(a,b);if(!c){c=new n;c.color_id=a;c.species_id=b}return c};
this.outfit=new (function(){function a(){var e=[],q=m.items.concat(m.pet_state.assets);$.each(q,function(){e=e.concat(this.restricted_zones)});return e}function b(e){f.events.trigger("updateItemAssets",e)}function c(e){f.events.trigger("updateItems",e)}function l(e){m.pet_state=e;f.events.trigger("updatePetState",e)}function k(e){if(e==r){m.pet_type=e;f.events.trigger("updatePetType",e);e.pet_states[0].assets.load(l);s()}}function p(e){if(e==r){f.events.trigger("petTypeNotFound",e);r=null}}function s(){m.pet_type&&
t.length&&m.pet_type.loadItemAssets(t,b)}var m=this,r,t=[];this.items=[];this.getVisibleAssets=function(){var e=[],q=a(),u=m.items.concat([m.pet_state]);$.each(u,function(){$.each(this.assets,function(){$.inArray(this.zone_id,q)==-1&&e.push(this)})});return e};this.setPetTypeByColorAndSpecies=function(e,q){r=n.findOrCreateByColorAndSpecies(e,q);r.load(k,p)};this.setItemsByIds=function(e){t=e;if(e.length)this.items=h.loadByIds(e,c);s()}});this.base_pet=new (function(){var a=this;this.setName=function(b){a.name=
b;f.events.trigger("updateBasePetName",b)}});this.bind=function(a,b){if(typeof this.events[a]=="undefined")this.events[a]=[];this.events[a].push(b)};this.initialize=function(){this.events.trigger("initialize")};this.registerViews=function(a){$.each(a,function(){this(f)})}}
if(document.location.search.substr(0,6)=="?debug")View.Console=function(d){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");d.bind("initialize",function(){log("Welcome to the Wardrobe!")});$.each(["updateBasePetName","updateItems","updateItemAssets","updatePetType","updatePetState"],function(){var g=this;d.bind(g,function(j){log(g,j)})});d.bind("petTypeNotFound",function(g){log(g.toString()+" not found")})};
View.Hash=function(d){function g(){var f=(document.location.hash||document.location.search).substr(1);if(f!=h){j(f);h=f}}function j(f){var a={};$.each(f.split("&"),function(){var b=this.split("="),c=decodeURIComponent(b[0]);if(b=decodeURIComponent(b[1]))if(n[c]==o.INTEGER)a[c]=+b;else if(n[c]==o.STRING)a[c]=b;else if(c.substr(c.length-2)=="[]"){c=c.substr(0,c.length-2);if(n[c]==o.INTEGER_ARRAY){if(typeof a[c]=="undefined")a[c]=[];a[c].push(+b)}}});if(a.color!==i.color||a.species!==i.species)d.outfit.setPetTypeByColorAndSpecies(a.color,
a.species);a.objects!==i.objects&&d.outfit.setItemsByIds(a.objects);a.name!=i.name&&d.base_pet.setName(a.name);i=a}var i={},h,o={INTEGER:1,STRING:2,ARRAY:3},n={color:o.INTEGER,name:o.STRING,objects:o.INTEGER_ARRAY,species:o.INTEGER};d.bind("initialize",function(){g();setInterval(g,100)});d.bind("updatePetType",function(f){if(f.color_id!=i.color||f.species_id!=i.species){i.color=f.color_id;i.species=f.species_id;h=f=$.param(i);document.location.hash="#"+f}})};
View.Preview=function(d){function g(){var h;if(i)return false;if(j&&j.setAssets){log("Getting assets");h=d.outfit.getVisibleAssets();log("Setting assets");log(h);j.setAssets(h)}else{log("Will set assets once SWF is ready");i=true}}$("#preview");var j,i=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.10","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){log("Preview SWF is ready");j=
document.getElementById("preview-swf");if(i){log("About to set assets");i=false;g()}};d.bind("updateItems",g);d.bind("updateItemAssets",g);d.bind("updatePetState",g)};View.Title=function(d){d.bind("updateBasePetName",function(g){$("#title").text("Planning "+g+"'s outfit")})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
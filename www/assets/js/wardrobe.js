Array.prototype.removeValue=function(p){p=$.inArray(p,this);p!=-1&&this.splice(p,1)};Array.prototype.clone=function(){return this.splice(0)};Array.prototype.toInt=function(){return $.map(this,function(p){return parseInt(p)})};
var MainWardrobe=new (function(){function p(c){function g(f,d){e.push(f+"="+encodeURIComponent(d))}var e=[];$.each(c,function(f,d){$.isArray(d)?$.each(d,function(){g(f+"[]",this)}):g(f,d)});return e.join("&")}function q(c,g,e,f){g=g?p(g):"";var d=c+"?"+g;if($.inArray(d,q.requestsLoading)==-1){q.requestsLoading.push(d);$.ajax($.extend(f,{url:c,data:g,dataType:"json",success:e,complete:function(){q.requestsLoading.removeValue(d)}}))}}function w(c){var g;g=n.pet_type.body_id;c.id=parseInt(c.id);c.parent_id=
parseInt(c.parent_id);for(var e in c)this[e]=c[e];this.constructor.cache[this.id]=this;(c=this.constructor.cache_by_body_and_parent_id[g])||(c=this.constructor.cache_by_body_and_parent_id[g]={});(g=c[this.parent_id])||(g=c[this.parent_id]=[]);g.push(this)}function v(c){this.inheritsFrom=w;this.inheritsFrom(c);this.is_body_specific=this.is_body_specific=="1";this.getObject=function(){return j.find(this.parent_id)}}function x(c){this.inheritsFrom=w;this.inheritsFrom(c)}function j(c,g){this.is_placeholder=
g?true:false;this.addToCloset=function(){var f=r.getObjectIds();f.push(this.id);l.set("closet",f)};this.addToOutfit=function(){this.isCloseted()||this.addToCloset();var f=n.getObjectIds();f.push(this.id);l.set("objects",f);n.removeObjectsConflictingWith(this)};this.getAssetsByBodyId=function(f){f=v.cache_by_body_and_parent_id[f];var d;if(f)d=f[this.id];return d?$.extend(true,[],d):[]};this.hasAssetsWithBodyId=function(f){return this.getAssetsByBodyId(f).length>0};this.isAvailable=function(){return!this.isUnavailable()};
this.isCloseted=function(){return $.inArray(this.id,r.getObjectIds())!=-1};this.isUnavailable=function(){return $.inArray(this.id,r.unavailable_object_ids)!=-1};this.isWorn=function(){return this.isAvailable()&&$.inArray(this.id,n.getObjectIds())!=-1};this.removeFromCloset=function(){this.removeFromOutfit();var f=r.getObjectIds();f.removeValue(this.id);l.set("closet",f)};this.removeFromOutfit=function(){var f=n.getObjectIds();f.removeValue(this.id);l.set("objects",f)};c.id=parseInt(c.id);for(var e in c)this[e]=
c[e];j.cache[this.id]=this}q.requestsLoading=[];$.each([v,x],function(){this.cache={};this.find=function(c){c=parseInt(c);return this.cache[c]};this.cache_by_body_and_parent_id={}});j.cache={};j.find=function(c){c=parseInt(c);var g=j.cache[c];g||(g=new j({id:c},true));return g};var r=new (function(){this.unavailable_object_ids=[];this.setUnavailableObjectIds=function(c){this.unavailable_object_ids=c.toInt();o.updateObjectStatuses()};this.clearObjectStatuses=function(){this.unavailable_object_ids=
[]};this.getObjectIds=function(){return l.get("closet")?l.get("closet").toInt():[]};this.getObjects=function(){return $.map(l.get("closet"),function(c){return j.find(c)})};this.initialize=function(){l.get("objects")&&!l.get("closet")&&l.set("closet",l.get("objects"));this.update()};this.update=function(){var c=l.get("closet");if(c){c=$.grep(l.get("closet"),function(g){return j.find(g).is_placeholder});if(c.length){r.clearObjectStatuses();q("/objects.json",{ids:c},function(g){$.each(g,function(){object=
new j(this)});o.modules.closet.update()})}}}}),l=new (function(){function c(){return(document.location.hash||document.location.search).substr(1)}function g(){d={};var a=c(),h=a.split("&");$.each(h,function(){var k=this.split("="),m=decodeURIComponent(k[0]);k=decodeURIComponent(k[1]);var i=m.match(/(.+)\[\]/);if(i){d[i[1]]||(d[i[1]]=[]);d[i[1]].push(k)}else d[m]=k});b=a}function e(a,h){d[a]=h}function f(){document.location.hash=p(d)}var d=null,b;this.get=function(a){d||g();return d[a]};this.set=function(a,
h){typeof a=="object"?$.each(a,e):e(a,h);f()};setInterval(function(){if(c()!=b){g();n.update();r.update()}},100)}),n=new (function(){function c(d,b){$.each(d,function(){new b(this)})}function g(){var d=l.get("species"),b=l.get("color");if(!this.pet_type||d!=this.pet_type.species_id||b!=this.pet_type.color_id){o.Outfit.hideBiologyAssets();q("/pet_types.json",{"for":"wardrobe",species_id:d,color_id:b},function(a){if(a){e.pet_type&&a.body_id!=e.pet_type.body_id&&o.Outfit.removeBodySpecificAssets();a.species_id=
d;a.color_id=b;e.pet_type=a;c(a.assets,x);e.updateObjects();o.Outfit.update()}else{o.error("Pet type not found!");o.Outfit.showBiologyAssets()}})}else e.updateObjects()}var e=this,f=[];this.restricted_zones=[];this.pet_type=null;this.getAssets=function(){var d=this.pet_type.assets;$.each(this.getObjectIds(),function(){var b=j.find(this);d=d.concat(b.getAssetsByBodyId(e.pet_type.body_id))});return d};this.getObjectIds=function(){var d=l.get("objects");return d?d.toInt():[]};this.getObjects=function(){return $.map(this.getObjectIds(),
function(d){return j.find(d)})};this.removeObjectsConflictingWith=function(d){f.push(d)};this.removeObjectsConflictingWithQueue=function(){$.each(f,function(){var d=this,b=this.getAssetsByBodyId(e.pet_type.body_id);$.each(b,function(){var a=this;$.each(e.getObjects(),function(){var h;if(d.id!=this.id){h=this.getAssetsByBodyId(e.pet_type.body_id);for(var k in h)h[k].zone_id==a.zone_id&&this.removeFromOutfit()}})})});f=[]};this.setRestrictedZones=function(){this.restricted_zones=[];$.each(this.getObjects(),
function(){var d;for(d=0;(d=this.zones_restrict.indexOf("1",d))!=-1;){d=d+1;e.restricted_zones.push(d);d=d}})};this.updateObjects=function(){function d(){var a=$.grep(b.clone(),function(h){return!j.find(h).hasAssetsWithBodyId(e.pet_type.body_id)});e.setRestrictedZones();e.removeObjectsConflictingWithQueue();r.setUnavailableObjectIds(a);o.Outfit.update()}var b=$.grep(this.getObjectIds(),function(a){return!j.find(a).hasAssetsWithBodyId(e.pet_type.body_id)});b.length?q("/object_assets.json",{parent_ids:b,
body_id:e.pet_type.body_id},function(a){c(a,v);d()}):d()};this.initialize=this.update=g}),A=new (function(){var c=[];this.getObjects=function(){return c};$("#search-form").submit(function(g){g.preventDefault();$("#search-module-error").hide();q("/objects.json",{search:$("#search-form-query").val()},function(e){c=[];$.each(e,function(){c.push(new j(this))});o.modules.search.update()},{error:function(e){$("#search-module-error").text(e.responseText).show();c=[];o.modules.search.update()}})})}),o=new (function(){function c(b,
a){this.afterUpdate=function(){};this.object_owner=a;this.objects_wrapper_query=b;this.update=function(){var h=$(this.objects_wrapper_query).html("");$.each(this.object_owner.getObjects(),function(){var k=$("<li></li>").attr({id:"object-"+this.id,"class":"object"}).data("object_id",this.id);$("<img />").attr({src:this.thumbnail_url,alt:"",height:80,width:80}).appendTo(k);k.append("<span>"+this.name+"</span>").wrapInner("<div></div>").appendTo(h)});e.updateObjectStatuses();this.afterUpdate()}}function g(){var b=
{top:null,left:null},a={height:$(window).height()-f.bottom.outerHeight(),width:$(window).width()-f.right.outerWidth()};$.each(f,function(){this.css(b)});f.right.css("height",null);f.bottom.width(a.width);a.height>a.width?$("#outfit-preview").css({height:a.width,left:null,width:a.width,top:(a.height-a.width)/2}):$("#outfit-preview").css({height:a.height,left:(a.width-a.height)/2,width:a.height,top:null});e.Outfit.Watermark.update_position();$("#object-description").css({bottom:f.bottom.outerHeight(),
right:f.right.outerWidth()})}var e=this;this.Outfit=new (function(){this.hideBiologyAssets=function(){$(".biology-asset").hide()};this.removeBodySpecificAssets=function(){$(".body-specific-asset").remove()};this.showBiologyAssets=function(){$(".biology-asset").show()};this.update=function(){$(".outfit-asset").each(function(){var b=$(this),a=b.attr("data-parent-id");if(b.hasClass("object-asset")){a=j.find(a);a.isWorn()||b.remove()}else n.pet_type.id!=a&&b.remove()});$.each(n.getAssets(),function(){var b=
this.constructor==v;if(b&&this.getObject().isWorn()||!b){var a="outfit-asset-"+this.id+"-"+(b?"object":"biology");b="outfit-asset "+(b?"object-asset":"biology-asset");var h=$("#"+a);if(!h.length){$('<div id="'+a+'"></div>').appendTo("#outfit-preview");if(this.is_body_specific)b+=" body-specific-asset";attrs={"class":b,style:"z-index: "+this.depth,"data-parent-id":this.parent_id};swfobject.embedSWF(this.url,a,"100%","100%","9","/assets/js/swfobject/expressInstall.swf",null,{wmode:"transparent"},attrs)}h.toggle($.inArray(parseInt(this.zone_id),
n.restricted_zones)==-1)}});this.Watermark.update()};this.Watermark=new (function(){var b=this,a,h={r:[0,0.2],e:[0,0.7],s:[0.5,0.2],t:[0.5,0.7],m:[0.25,0.45]},k=false;this.update=function(){function m(){for(var i=$("#"+a+"s"),s="",u=0;u<25;u++)s+=String.fromCharCode(Math.random()*26+97);i.length&&i.remove();for(var t in h){i=$("."+a+t);if(i.length)i.attr("class",s+t);else{i=$("<div>The Wardrobe</div>");i.attr("class",s+t).appendTo(document.body)}}a=s;b.update_position()}k?m():$(function(){m();k=true})};
this.update_position=function(){function m(){var i=$("#outfit-preview"),s=i.height(),u=i.width(),t=i.offset(),y="";$.each(h,function(B,z){y+="."+a+B+" {opacity: .1; filter:alpha(opacity=30);position: absolute;left: "+(u*z[0]+t.left)+"px;top: "+(s*z[1]+t.top)+"px;width: "+u/2+"px;color: #fff;font-weight: bold;text-align: center;text-shadow: #000 1px 1px;z-index: 100;}"});$('<style type="text/css">'+y+"</style>").attr("id",a+"s").appendTo("head");$("#outfit-preview").css("zIndex",1)}k?m():$(function(){m();
k=true})}})});this.modules=[];this.modules.closet=new c("#closet-module-objects",r);this.modules.pet_type=new (function(){q("/pet_attributes.json",null,function(b){$.each(b,function(a,h){var k=$("#pet-type-form-"+a),m=l.get(a);$.each(h,function(){var i=$('<option value="'+this.id+'">'+this.name+"</option>");this.id==m&&i.attr("selected","selected");i.appendTo(k)})});$("#pet-type-form").css("visibility","visible")});$("#pet-type-form").submit(function(b){b.preventDefault();var a={};$.each(["species",
"color"],function(){a[this]=$("#pet-type-form-"+this+" option:selected").val()});l.set(a);n.update()})});this.modules.search=new c("#search-module-objects",A);this.modules.search.afterUpdate=function(){var b=this.object_owner.getObjects(),a=$(this.objects_wrapper_query);b=a.children(".object:first").outerWidth()*b.length;a.width(b);$("#toolbar-bottom").animate({height:a.outerHeight()+a.position().top},250,g)};this.updateObjectStatuses=function(){$(".object").each(function(){var b=$(this),a=j.find(b.data("object_id"));
b.toggleClass("unavailable-object",a.isUnavailable());b.toggleClass("worn-object",a.isWorn())})};var f={},d={ghost:true,stop:g};$.each({bottom:{handles:"n"},right:{handles:"w"}},function(b,a){f[b]=$("#toolbar-"+b).resizable($.extend(d,a))});$(window).resize(g);g();$(".object").live("mouseenter",function(){var b=$(this),a=$("#object-description");if(!b.children(".object-action").length){var h=j.find(b.data("object_id")),k="";function m(i){var s=i.toLowerCase();$('<a href="#" class="object-action object-action-'+
s+'">'+i+"</a>").appendTo(b)}h.isWorn()?m("Unwear"):m("Wear");h.isCloseted()?m("Uncloset"):m("Closet");if(h.isUnavailable())k='<p class="ui-state-error">We haven\'t seen this body type wearing this item before. If you have, go to the homepage and add the pet, so we can get that data! Thanks!</p>';a.html("<h1>"+h.name+" ("+[h.rarity,h.rarity_index].join(" - ")+")</h1><p>"+h.description+"</p>"+k+"<dl><dt>Type</dt><dd>"+h.type+"</dd><dt>Est. Price</dt><dd>"+h.price+"</dd></dl>").css("backgroundImage",
"url("+h.thumbnail_url+")").show()}}).live("mouseleave",function(){$(this).children(".object-action").remove();$("#object-description").hide()});this.error=function(b){alert(b)};$(".object-action-wear").live("click",function(b){var a=$(this).parent();a=j.find(a.data("object_id"));b.preventDefault();a.addToOutfit();n.updateObjects();e.modules.closet.update()});$(".object-action-unwear").live("click",function(b){var a=$(this).parent();a=j.find(a.data("object_id"));b.preventDefault();a.removeFromOutfit();
e.Outfit.update();e.modules.closet.update()});$(".object-action-closet").live("click",function(b){var a=$(this).parent();a=j.find(a.data("object_id"));b.preventDefault();a.addToCloset();e.modules.closet.update()});$(".object-action-uncloset").live("click",function(b){var a=$(this).parent();a=j.find(a.data("object_id"));b.preventDefault();a.removeFromCloset();e.Outfit.update();e.modules.closet.update()})});n.initialize();r.initialize()});
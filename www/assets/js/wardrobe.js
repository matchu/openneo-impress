var View={},main_wardrobe;function DeepObject(){}DeepObject.prototype.deepGet=function(){var d=this;$.each(arguments,function(){d=d[this];if(typeof d=="undefined")return false});return d};DeepObject.prototype.deepSet=function(){var d=$.proxy(Array.prototype.pop,"apply"),k=d(arguments);d=d(arguments);var i=this;$.each(arguments,function(){if(typeof i[this]=="undefined")i[this]={};i=i[this]});i[d]=k};
function Wardrobe(){function d(a){var b=this;$.each(a,function(c){b[c]=this});this.data_for_swf={id:+this.id,depth:+this.depth,local_path:""+this.local_path}}function k(a){d.apply(this,[a])}function i(a){d.apply(this,[a])}function e(a){var b=this;this.id=a;this.assets=[];this.loaded=false;this.update=function(c){$.each(c,function(f,h){b[f]=h});this.loaded=true};e.cache[a]=this}function m(a){var b=this;this.id=a;this.assets=[];this.assets.load=function(c){$.getJSON("/biology_assets.json?parent_id="+
b.id,function(f){b.assets=$.map(f,function(h){return new k(h)});c(b)})}}function j(){var a=this,b=false;this.pet_states=[];this.load=function(c,f){b?c(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(h){if(h){$.each(h,function(n){a[n]=this});$.each(a.pet_state_ids,function(){a.pet_states.push(new m(this))});j.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);b=true;c(a)}else f(a)})};this.loadItemAssets=function(c,f){$.getJSON("/object_assets.json?body_id="+
a.body_id,{parent_ids:c},function(h){var n=[];$.each(h,function(){var p=e.find(this.parent_id),o=new i(this);p.assets.push(o);n.push(o)});f(n)})};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"}}var l=this;this.events={};this.events.trigger=function(a){var b;if(l.events[a]){b=Array.prototype.slice.apply(arguments,[1]);$.each(l.events[a],function(){this.apply(l,b)})}};e.find=function(a){var b=e.cache[a];b||(b=new e(a));return b};e.loadByIds=function(a,
b){var c=[],f=$.map(a,function(h){var n=e.find(h);n.loaded||c.push(h);return n});c.length?$.getJSON("/objects.json",{ids:c},function(h){$.each(h,function(){e.find(this.id).update(this)});b(f)}):b(f);return f};e.cache={};j.cache_by_color_and_species=new DeepObject;j.findOrCreateByColorAndSpecies=function(a,b){var c=j.cache_by_color_and_species.deepGet(a,b);if(!c){c=new j;c.color_id=a;c.species_id=b}return c};this.outfit=new (function(){function a(g){l.events.trigger("updateItemAssets",g)}function b(g){l.events.trigger("updateItems",
g)}function c(g){p.pet_state=g;l.events.trigger("updatePetState",g)}function f(g){if(g==o){p.pet_type=g;l.events.trigger("updatePetType",g);g.pet_states[0].assets.load(c);n()}}function h(g){if(g==o){l.events.trigger("petTypeNotFound",g);o=null}}function n(){p.pet_type&&q.length&&p.pet_type.loadItemAssets(q,a)}var p=this,o,q=[];this.items=[];this.visibleAssets=function(){var g=p.pet_state.assets;$.each(this.items,function(){g=g.concat(this.assets)});return g};this.setPetTypeByColorAndSpecies=function(g,
r){o=j.findOrCreateByColorAndSpecies(g,r);o.load(f,h)};this.setItemsByIds=function(g){q=g;if(g.length)this.items=e.loadByIds(g,b);n()}});this.bind=function(a,b){if(typeof this.events[a]=="undefined")this.events[a]=[];this.events[a].push(b)};this.initialize=function(){this.events.trigger("initialize")};this.registerViews=function(a){$.each(a,function(){this(l)})}}
View.Console=function(d){window.log=typeof console=="undefined"||typeof console.log!="function"?$.noop:$.proxy(console,"log");d.bind("initialize",function(){log("Welcome to the Wardrobe!")});$.each(["updateItems","updateItemAssets","updatePetType","updatePetState"],function(){d.bind(this,log)});d.bind("petTypeNotFound",function(k){log(k.toString()+" not found")})};
View.Hash=function(d){function k(){var a=(document.location.hash||document.location.search).substr(1);if(a!=m){i(a);m=a}}function i(a){var b={};$.each(a.split("&"),function(){var c=this.split("="),f=decodeURIComponent(c[0]);if(c=decodeURIComponent(c[1]))if(l[f]==j.INTEGER)b[f]=+c;else if(f.substr(f.length-2)=="[]"){f=f.substr(0,f.length-2);if(l[f]==j.INTEGER_ARRAY){if(typeof b[f]=="undefined")b[f]=[];b[f].push(+c)}}});if(b.color!==e.color||b.species!==e.species)d.outfit.setPetTypeByColorAndSpecies(b.color,
b.species);b.objects!==e.objects&&d.outfit.setItemsByIds(b.objects);e=b}var e={},m,j={INTEGER:1,ARRAY:2},l={color:j.INTEGER,species:j.INTEGER,objects:j.INTEGER_ARRAY};d.bind("initialize",function(){k();setInterval(k,100)});d.bind("updatePetType",function(a){if(a.color_id!=e.color||a.species_id!=e.species){e.color=a.color_id;e.species=a.species_id;m=a=$.param(e);document.location.hash="#"+a}})};
View.Preview=function(d){function k(){var m;if(e)return false;if(i&&i.setAssets){m=d.outfit.visibleAssets();log("Setting assets now");m=$.map(m,function(j){return j.data_for_swf});log(m);i.setAssets(m)}else{log("Will set assets once SWF is ready");e=true}}$("#preview");var i,e=false;swfobject.embedSWF("/assets/swf/preview.swf?v=3","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){log("Preview SWF is ready");
i=document.getElementById("preview-swf");if(e){e=false;k()}};d.bind("updateItemAssets",k);d.bind("updatePetState",k)};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
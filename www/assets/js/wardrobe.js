var View={},Partial={},main_wardrobe,ITEMS_SERVER="items.impress.openneo.net";if(document.location.hostname.substr(0,5)=="beta.")ITEMS_SERVER="beta."+ITEMS_SERVER;ITEMS_SERVER="http://"+ITEMS_SERVER;window.log=window.SWFLog=$.noop;
function arraysMatch(b,k){var l;if(!$.isArray(b)||!$.isArray(k))return b==k;l=[];if(!b[0]||!k[0])return false;if(b.length!=k.length)return false;for(var g=0;g<b.length;g++){key=typeof b[g]+"~"+b[g];if(l[key])l[key]++;else l[key]=1}for(g=0;g<k.length;g++){key=typeof k[g]+"~"+k[g];if(l[key])if(l[key]==0)return false;else l[key]--;else return false}return true}Array.prototype.map=function(b){return $.map(this,function(k){return k[b]})};function DeepObject(){}
DeepObject.prototype.deepGet=function(){var b=this;$.each(arguments,function(){b=b[this];if(typeof b=="undefined")return false});return b};DeepObject.prototype.deepSet=function(){var b=$.proxy(Array.prototype.pop,"apply"),k=b(arguments);b=b(arguments);var l=this;$.each(arguments,function(){if(typeof l[this]=="undefined")l[this]={};l=l[this]});l[b]=k};
function Wardrobe(){function b(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function k(a){for(var c in a)if(a.hasOwnProperty(c))this[c]=a[c]}function l(a){k.apply(this,[a]);b.apply(this)}function g(a){k.apply(this,[a])}function n(a){var c=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(f){return this.assets_by_body_id[f.body_id]||[]};this.hasAssetsFitting=function(f){return typeof c.assets_by_body_id[f.body_id]!=
"undefined"&&c.assets_by_body_id[f.body_id].length>0};this.couldNotLoadAssetsFitting=function(f){return typeof c.assets_by_body_id[f.body_id]!="undefined"&&c.assets_by_body_id[f.body_id].length==0};this.update=function(f){for(var j in f)if(f.hasOwnProperty(j)&&j!="id")c[j]=f[j];b.apply(this);this.loaded=true};n.cache[a]=this}function q(a){this.name=a}function o(){}function t(a){var c=this,f=false;this.id=a;this.assets=[];this.loadAssets=function(j){f?j(c):$.getJSON("/biology_assets.json?parent_id="+
c.id,function(u){c.assets=$.map(u,function(w){return new l(w)});f=true;j(c)})};t.cache[a]=this}function v(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(c,f){a.loaded?c(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(j){if(j){for(var u in j)if(j.hasOwnProperty(u))a[u]=j[u];for(j=0;j<a.pet_state_ids.length;j++)a.pet_states.push(t.find(a.pet_state_ids[j]));v.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=
true;c(a)}else f(a)})};this.loadItemAssets=function(c,f){for(var j=[],u=0;u<c.length;u++){var w=c[u];n.find(w).hasAssetsFitting(a)||j.push(w)}j.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:j},function(m){$.each(m,function(){var x=n.find(this.parent_id),A=new g(this);if(typeof x.assets_by_body_id[a.body_id]=="undefined")x.assets_by_body_id[a.body_id]=[];x.assets_by_body_id[a.body_id].push(A)});for(var y=0,i=c.length;y<i;y++){m=n.find(c[y]);m.hasAssetsFitting(a)||(m.assets_by_body_id[a.body_id]=
[])}f()}):f()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(c){for(var f=0;f<this.pet_states.length;f++)if(this.pet_states[f]==c)return true;return false}}function e(){var a=this;this.events={};this.bind=function(c,f){if(typeof this.events[c]=="undefined")this.events[c]=[];this.events[c].push(f)};this.events.trigger=function(c){var f;if(a.events[c]){f=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[c],
function(){this.apply(a,f)})}}}var d=this;n.find=function(a){var c=n.cache[a];c||(c=new n(a));return c};var h=[];n.loadByIds=function(a,c){var f=[],j=[],u=$.map(a,function(w){var m=n.find(w);if(!m.load_started){f.push(w);m.load_started=true}m.loaded||j.push(w);return m});if(f.length)$.getJSON("/objects.json",{ids:f},function(w){var m,y,i,x=[];$.each(w,function(){x.push(+this.id);n.find(this.id).update(this)});for(var A=0;A<h.length;A++){m=h[A];w=m[0];y=m[1];m=m[2];i=true;for(var z=0;z<y.length;z++)if($.inArray(y[z],
x)==-1){i=false;break}i&&m(w)}c(u)});else j.length?h.push([u,j,c]):c(u);return u};var r=ITEMS_SERVER+"/index.js?callback=?";n.loadByQuery=function(a,c,f,j){$.getJSON(r,{q:a,per_page:21,page:c},function(u){var w=[],m,y;if(u.items){for(var i=0;i<u.items.length;i++){y=u.items[i];m=n.find(y.id);m.update(y);w.push(m)}f(w,u.total_pages)}else u.error&&j(u.error)})};n.cache={};q.loadAll=function(a){$.getJSON(ITEMS_SERVER+"/item_zone_sets.js?callback=?",function(c){for(var f=0,j=c.length;f<j;f++)q.all.push(new q(c[f]));
a(q.all)})};q.all=[];o.loadAll=function(a){$.getJSON("/pet_attributes.json",function(c){a(c)})};t.find=function(a){var c=t.cache[a];c||(c=new t(a));return c};t.cache={};v.cache_by_color_and_species=new DeepObject;v.findOrCreateByColorAndSpecies=function(a,c){var f=v.cache_by_color_and_species.deepGet(a,c);if(!f){f=new v;f.color_id=a;f.species_id=c}return f};e.Outfit=function(){function a(){var i=[],x=m.items.concat(m.pet_state.assets);$.each(x,function(){i=i.concat(this.restricted_zones)});return i}
function c(i){m.events.trigger("updateItems",i)}function f(i){m.events.trigger("updatePetState",i)}function j(i){if(!m.pet_state||!i.ownsPetState(m.pet_state))m.setPetStateById();m.events.trigger("petTypeLoaded",i);w()}function u(i){m.events.trigger("petTypeNotFound",i)}function w(i){m.pet_type&&m.pet_type.loaded&&y.length&&m.pet_type.loadItemAssets(y,function(){var x,A,z,E,B,F=[],G=[];if(i){x=i.getAssetsFitting(m.pet_type).map("zone_id");A=x.length;for(var C=0;C<m.items.length;C++){z=m.items[C];
E=z.getAssetsFitting(m.pet_type).map("zone_id");B=true;if(z!=i)for(var D=0;D<A;D++)if($.inArray(x[D],E)!=-1){B=false;break}if(B){F.push(z);G.push(z.id)}}m.items=F;y=G;m.events.trigger("updateItems",m.items)}m.events.trigger("updateItemAssets")})}var m=this,y=[];this.items=[];this.addItem=function(i){if($.inArray(i,m.items)==-1){this.items.push(i);y.push(i.id);w(i);m.events.trigger("updateItems",this.items)}};this.getVisibleAssets=function(){for(var i=this.pet_state.assets,x=a(),A=[],z=0;z<m.items.length;z++)i=
i.concat(m.items[z].getAssetsFitting(m.pet_type));$.each(i,function(){$.inArray(this.zone_id,x)==-1&&A.push(this)});return A};this.removeItem=function(i){var x=$.inArray(i,this.items);if(x!=-1){this.items.splice(x,1);i=$.inArray(i.id,y);y.splice(i,1);m.events.trigger("updateItems",this.items)}};this.setPetStateById=function(i){if(!i&&this.pet_type)i=this.pet_type.pet_state_ids[0];if(i){this.pet_state=t.find(i);this.pet_state.loadAssets(f)}};this.setPetTypeByColorAndSpecies=function(i,x){this.pet_type=
v.findOrCreateByColorAndSpecies(i,x);m.events.trigger("updatePetType",this.pet_type);this.pet_type.load(j,u)};this.setItemsByIds=function(i){if(i)y=i;if(i&&i.length)this.items=n.loadByIds(i,c);else{this.items=[];c(this.items)}w()}};e.Closet=function(){function a(j){c.events.trigger("updateItems",j)}var c=this,f=[];this.items=[];this.addItem=function(j){if($.inArray(j,c.items)==-1){this.items.push(j);f.push(j.id);c.events.trigger("updateItems",this.items)}};this.removeItem=function(j){var u=$.inArray(j,
this.items);if(u!=-1){this.items.splice(u,1);j=$.inArray(j.id,f);f.splice(j,1);c.events.trigger("updateItems",this.items)}};this.setItemsByIds=function(j){if(j&&j.length){f=j;this.items=n.loadByIds(j,a)}else{f=j;this.items=[];a(this.items)}}};e.BasePet=function(){var a=this;this.setName=function(c){a.name=c;a.events.trigger("updateName",c)}};e.PetAttributes=function(){function a(f){c.events.trigger("update",f)}var c=this;this.load=function(){o.loadAll(a)}};e.ItemZoneSets=function(){function a(f){c.events.trigger("update",
f)}var c=this;this.load=function(){q.loadAll(a)}};e.Search=function(){function a(f){c.events.trigger("error",f)}var c=this;this.request={};this.setItemsByQuery=function(f,j){c.request={query:f,page:j};c.events.trigger("updateRequest",c.request);if(f&&j){n.loadByQuery(f,j,function(u,w){c.events.trigger("updateItems",u);c.events.trigger("updatePagination",j,w)},a);c.events.trigger("startRequest")}else{c.events.trigger("updateItems",[]);c.events.trigger("updatePagination",0,0)}}};var s;for(var p in e)if(e.hasOwnProperty(p)){s=
p.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();d[s]=new e[p];e.apply(d[s])}this.initialize=function(){var a;for(var c in d.views)if(d.views.hasOwnProperty(c)){a=d.views[c];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){d.views={};$.each(a,function(c){d.views[c]=new this(d)})}}
Partial.ItemSet=function(b,k){function l(e){return function(d){for(var h,r=0;r<q.length;r++){h=q[r];in_set=$.inArray(h,d)!=-1;$("li.object-"+h.id).toggleClass(e,in_set).data("item",h).data(e,in_set).children("ul").children("li.control-set-for-"+e).remove().end()[e=="worn"?"prepend":"append"](Partial.ItemSet.CONTROL_SETS[e][in_set].clone())}}}function g(e){for(var d,h,r=0,s=e.length;r<s;r++){d=e[r];h=d.couldNotLoadAssetsFitting(b.outfit.pet_type);$("li.object-"+d.id).toggleClass("no-assets",h)}}var n=
$(k),q=[],o,t,v;Partial.ItemSet.setWardrobe(b);o=l("closeted");v=l("worn");t=function(e){v(e);g(e)};this.setItems=function(e){var d,h;q=e;n.children().remove();for(var r=0;r<q.length;r++){e=q[r];d=$("<li/>",{"class":"object object-"+e.id});img=$("<img/>",{src:e.thumbnail_url,alt:e.description,title:e.description});h=$("<ul/>");d.append(img).append(h).append(e.name).appendTo(n)}o(b.closet.items);t(b.outfit.items)};b.outfit.bind("updateItemAssets",function(){g(b.outfit.items)});b.outfit.bind("updateItems",
t);b.closet.bind("updateItems",o)};Partial.ItemSet.CONTROL_SETS={};
Partial.ItemSet.setWardrobe=function(b){for(var k,l,g,n,q,o={},t=0;t<2;t++){k=t==0?"worn":"closeted";l=t==0?["Unwear","Wear"]:["Uncloset","Closet"];Partial.ItemSet.CONTROL_SETS[k]={};for(var v=0;v<2;v++){g=v==0;q="control-set control-set-for-"+k;n="control-set-"+(g?"":"not-")+k;q+=" "+n;Partial.ItemSet.CONTROL_SETS[k][g]=$("<a/>",{href:"#",text:l[g?0:1]}).wrap("<li/>").parent().attr("class",q);(function(e,d){$("li."+n+" a").live("click",function(h){var r=$(this).closest(".object").data("item");o[e][!d](r);
h.preventDefault()})})(k,g)}}o.closeted={};o.closeted[true]=$.proxy(b.closet,"addItem");o.closeted[false]=function(e){b.outfit.removeItem(e);b.closet.removeItem(e)};o.worn={};o.worn[true]=function(e){b.closet.addItem(e);b.outfit.addItem(e)};o.worn[false]=$.proxy(b.outfit,"removeItem");Partial.ItemSet.setWardrobe=$.noop};
if(document.location.search.substr(0,6)=="?debug")View.Console=function(b){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var k=["updateItems","updateItemAssets","updatePetType","updatePetState"],l=0;l<k.length;l++)(function(g){b.outfit.bind(g,function(n){log(g,n)})})(k[l]);b.outfit.bind("petTypeNotFound",function(g){log(g.toString()+" not found")})};
View.Closet=function(b){var k=new Partial.ItemSet(b,"#preview-closet ul");b.closet.bind("updateItems",$.proxy(k,"setItems"))};
View.Hash=function(b){function k(){var e=(document.location.hash||document.location.search).substr(1);if(e!=n){var d={},h=e.split("&");q=true;for(var r=0;r<h.length;r++){var s=h[r].split("="),p=decodeURIComponent(s[0]);if(s=decodeURIComponent(s[1]))if(t[p]==o.INTEGER)d[p]=+s;else if(t[p]==o.STRING)d[p]=decodeURIComponent(s).replace(/\+/g," ");else if(p.substr(p.length-2)=="[]"){p=p.substr(0,p.length-2);if(t[p]==o.INTEGER_ARRAY){if(typeof d[p]=="undefined")d[p]=[];d[p].push(+s)}}}if(d.color!==g.color||
d.species!==g.species)b.outfit.setPetTypeByColorAndSpecies(d.color,d.species);if(d.closet)arraysMatch(d.closet,g.closet)||b.closet.setItemsByIds(d.closet.slice(0));else arraysMatch(d.objects,g.closet)||b.closet.setItemsByIds(d.objects.slice(0));arraysMatch(d.objects,g.objects)||b.outfit.setItemsByIds(d.objects.slice(0));d.name!=g.name&&d.name&&b.base_pet.setName(d.name);d.state!=g.state&&b.outfit.setPetStateById(d.state);if(d.search!=g.search||d.search_page!=g.search_page)b.search.setItemsByQuery(d.search,
d.search_page);g=d;q=false;v();n=e}}function l(e){var d;if(!q){for(var h in e)if(e.hasOwnProperty(h)){d=e[h];if(d===undefined)delete g[h];else g[h]=e[h]}n=e=$.param(g).replace(/%5B%5D/g,"[]");document.location.hash="#"+e;v()}}var g={},n,q=false,o={INTEGER:1,STRING:2,INTEGER_ARRAY:3},t={closet:o.INTEGER_ARRAY,color:o.INTEGER,name:o.STRING,objects:o.INTEGER_ARRAY,search:o.STRING,search_page:o.INTEGER,species:o.INTEGER,state:o.INTEGER},v;this.initialize=function(){k();setInterval(k,100)};b.outfit.bind("updateItems",
function(e){e=e.map("id");var d={};if(!arraysMatch(e,g.objects))d.objects=e;d.closet=arraysMatch(e,g.closet)||arraysMatch(e,g.objects)?undefined:b.closet.items.map("id");if(d.objects||d.closet)l(d)});b.outfit.bind("updatePetType",function(e){if(e.color_id!=g.color||e.species_id!=g.species)l({color:e.color_id,species:e.species_id,state:undefined})});b.outfit.bind("petTypeNotFound",function(){window.history.back()});b.outfit.bind("updatePetState",function(e){var d=b.outfit.pet_type;if(e.id!=g.state&&
d&&(g.state||e.id!=d.pet_state_ids[0]))l({state:e.id})});b.search.bind("updateRequest",function(e){if(e.page!=g.search_page||e.query!=g.search)l({search_page:e.page,search:e.query})});(function(){ZeroClipboard.setMoviePath("/assets/swf/ZeroClipboard.swf");var e=$("#shorten-url-response"),d=$("#shorten-url-form"),h=$("#shorten-url-response-form"),r=$("#shorten-url-loading"),s=new ZeroClipboard.Client,p=false;v=function(){d.show();r.hide();h.hide()};BitlyCB.wardrobeSelfShorten=function(a){var c;try{c=
a.results[document.location.href].hash}catch(f){log("shortener error: likely no longer same URL",f)}a="http://outfits.openneo.net/"+c;d.hide();h.show();if(!p){s.glue("shorten-url-copy-button","shorten-url-copy-button-wrapper");p=true}e.text(a);s.setText(a)};d.submit(function(a){BitlyClient.shorten(document.location.href,"BitlyCB.wardrobeSelfShorten");r.show();a.preventDefault()});h.submit(function(a){a.preventDefault()})})()};
View.Preview=function(b){function k(){var n;if(g)return false;if(l&&l.setAssets){n=b.outfit.getVisibleAssets();l.setAssets(n)}else g=true}$("#preview");var l,g=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){l=document.getElementById("preview-swf");if(g){g=false;k()}};b.outfit.bind("updateItems",k);b.outfit.bind("updateItemAssets",
k);b.outfit.bind("updatePetState",k)};
View.PetStateForm=function(b){function k(q){if(q){g.children("li.selected").removeClass("selected");$(n+"[value="+q.id+"]").attr("checked","checked").parent().addClass("selected")}}var l=$("#pet-state-form"),g=l.children("ul"),n="#pet-state-form input[name=pet_state_id]";$(n).live("click",function(){b.outfit.setPetStateById(+this.value)});b.outfit.bind("petTypeLoaded",function(q){q=q.pet_state_ids;var o,t,v,e;g.children().remove();if(q.length==1)l.hide();else{l.show();for(o=0;o<q.length;o++){t="pet-state-radio-"+
o;v=$("<li/>");e=$("<input/>",{id:t,name:"pet_state_id",type:"radio",value:q[o]});t=$("<label/>",{"for":t,text:o+1});o==0&&e.attr("checked","checked");e.appendTo(v);t.appendTo(v);v.appendTo(g)}k(b.outfit.pet_state)}});b.outfit.bind("updatePetState",k)};
View.PetTypeForm=function(b){function k(n){g&&n&&$.each(l,function(q){l[q].val(n[q+"_id"])})}var l={},g=false;$("#pet-type-form").submit(function(n){n.preventDefault();b.outfit.setPetTypeByColorAndSpecies(+l.color.val(),+l.species.val())}).children("select").each(function(){l[this.name]=$(this)});this.initialize=function(){b.pet_attributes.load()};b.pet_attributes.bind("update",function(n){$.each(n,function(q){var o=l[q];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(o)})});
g=true;k(b.outfit.pet_type)});b.outfit.bind("updatePetType",k);b.outfit.bind("petTypeNotFound",function(){$("#pet-type-not-found").show("normal").delay(3E3).hide("fast")})};
View.Search=function(b){var k=$("#preview-search-form"),l=new Partial.ItemSet(b,"#preview-search-form ul"),g=k.find("input[name=query]"),n=$("#preview-search-form-clear"),q=$("#preview-search-form-error"),o=$("#preview-search-form-help"),t=$("#preview-search-form-loading"),v=$("#preview-search-form-no-results"),e=v.children("span"),d={INNER_WINDOW:4,OUTER_WINDOW:1,GAP_TEXT:"&hellip;",PREV_TEXT:"&larr; Previous",NEXT_TEXT:"Next &rarr;",PAGE_EL:$("<a/>",{href:"#"}),CURRENT_EL:$("<span/>",{"class":"current"}),
EL_ID:"#preview-search-form-pagination"};d.EL=$(d.EL_ID);d.GAP_EL=$("<span/>",{"class":"gap",html:d.GAP_TEXT});d.PREV_EL=$("<a/>",{href:"#",rel:"prev",html:d.PREV_TEXT});d.NEXT_EL=$("<a/>",{href:"#",rel:"next",html:d.NEXT_TEXT});$(d.EL_ID+" a").live("click",function(h){h.preventDefault();h=$(this).data("page");b.search.setItemsByQuery(g.val(),h)});this.initialize=$.proxy(b.item_zone_sets,"load");k.submit(function(h){h.preventDefault();b.search.setItemsByQuery(g.val(),1)});n.click(function(h){h.preventDefault();
g.val("");k.submit()});b.search.bind("startRequest",function(){t.delay(1E3).show("slow")});b.search.bind("updateItems",function(h){t.stop(true,true).hide();l.setItems(h);if(b.search.request.query)h.length||v.show();else o.show()});b.search.bind("updateRequest",function(h){q.hide("fast");o.hide();v.hide();g.val(h.query||"");e.text(h.query);n.toggle(!!h.query)});b.search.bind("updatePagination",function(h,r){var s=h-d.INNER_WINDOW,p=h+d.INNER_WINDOW,a,c,f=1;if(p>r){s-=p-r;p=r}if(s<1){p+=1-s;s=1;if(p>
r)p=r}s=[2+d.OUTER_WINDOW,s];p=[p+1,r-d.OUTER_WINDOW];a=s[1]-s[0]>1;c=p[1]-p[0]>1;d.EL.children().remove();for(h>1&&d.PREV_EL.clone().data("page",h-1).appendTo(d.EL);f<=r;)if(a&&f>=s[0]&&f<s[1]){d.GAP_EL.clone().appendTo(d.EL);f=s[1]}else if(c&&f>=p[0]&&f<p[1]){d.GAP_EL.clone().appendTo(d.EL);f=p[1]}else{f==h?d.CURRENT_EL.clone().text(f).appendTo(d.EL):d.PAGE_EL.clone().text(f).data("page",f).appendTo(d.EL);f++}h<r&&d.NEXT_EL.clone().data("page",h+1).appendTo(d.EL)});b.search.bind("error",function(h){t.stop(true,
true).hide();q.text(h).show("normal")});o.find("dt").wrapInner($("<a/>",{href:"#"}));o.find("dt a").live("click",function(h){var r=$(this),s=r.children();h.preventDefault();h=s.length?s.map(function(){return this[$(this).is("span")?"innerText":"value"]}).get().join(""):r.text();g.val(h);k.submit()});$("select.search-helper").live("change",function(){var h=$(this);h.attr("data-search-filter");$("select.search-helper").val(h.val())}).live("click",function(h){h.stopPropagation()});b.item_zone_sets.bind("update",
function(h){for(var r=$("<select/>",{"class":"search-helper","data-search-filter":"type"}),s=$("span.search-helper[data-search-filter=type]"),p=0,a=h.length;p<a;p++)$("<option/>",{text:h[p].name}).appendTo(r);s.replaceWith(function(){return r.clone().fadeIn("fast")})})};View.Title=function(b){b.base_pet.bind("updateName",function(k){$("#title").text("Planning "+k+"'s outfit")})};$.ajaxSetup({error:function(){$.jGrowl("There was an error loading that last resource. Oops. Please try again!")}});
main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
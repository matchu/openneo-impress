var View={},main_wardrobe;window.log=window.SWFLog=$.noop;function arraysMatch(b,k){var g;if(!$.isArray(b)||!$.isArray(k))return b==k;g=[];if(!b[0]||!k[0])return false;if(b.length!=k.length)return false;for(var f=0;f<b.length;f++){key=typeof b[f]+"~"+b[f];if(g[key])g[key]++;else g[key]=1}for(f=0;f<k.length;f++){key=typeof k[f]+"~"+k[f];if(g[key])if(g[key]==0)return false;else g[key]--;else return false}return true}Array.prototype.map=function(b){return $.map(this,function(k){return k[b]})};
function DeepObject(){}DeepObject.prototype.deepGet=function(){var b=this;$.each(arguments,function(){b=b[this];if(typeof b=="undefined")return false});return b};DeepObject.prototype.deepSet=function(){var b=$.proxy(Array.prototype.pop,"apply"),k=b(arguments);b=b(arguments);var g=this;$.each(arguments,function(){if(typeof g[this]=="undefined")g[this]={};g=g[this]});g[b]=k};
function Wardrobe(){function b(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function k(a){for(var d in a)if(a.hasOwnProperty(d))this[d]=a[d]}function g(a){k.apply(this,[a]);b.apply(this)}function f(a){k.apply(this,[a])}function j(a){var d=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(h){return this.assets_by_body_id[h.body_id]||[]};this.hasAssetsFitting=function(h){return typeof d.assets_by_body_id[h.body_id]!=
"undefined"};this.update=function(h){for(var l in h)if(h.hasOwnProperty(l)&&l!="id")d[l]=h[l];b.apply(this);this.loaded=true};j.cache[a]=this}function o(){}function m(a){var d=this,h=false;this.id=a;this.assets=[];this.loadAssets=function(l){h?l(d):$.getJSON("/biology_assets.json?parent_id="+d.id,function(s){d.assets=$.map(s,function(t){return new g(t)});h=true;l(d)})};m.cache[a]=this}function p(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(d,h){a.loaded?d(a):$.getJSON("/pet_types.json",
{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(l){if(l){for(var s in l)if(l.hasOwnProperty(s))a[s]=l[s];for(l=0;l<a.pet_state_ids.length;l++)a.pet_states.push(m.find(a.pet_state_ids[l]));p.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=true;d(a)}else h(a)})};this.loadItemAssets=function(d,h){for(var l=[],s=0;s<d.length;s++){var t=d[s];j.find(t).hasAssetsFitting(a)||l.push(t)}l.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:l},
function(r){$.each(r,function(){var n=j.find(this.parent_id),v=new f(this);if(typeof n.assets_by_body_id[a.body_id]=="undefined")n.assets_by_body_id[a.body_id]=[];n.assets_by_body_id[a.body_id].push(v)});h()}):h()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(d){for(var h=0;h<this.pet_states.length;h++)if(this.pet_states[h]==d)return true;return false}}function e(){var a=this;this.events={};this.bind=function(d,
h){if(typeof this.events[d]=="undefined")this.events[d]=[];this.events[d].push(h)};this.events.trigger=function(d){var h;if(a.events[d]){h=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[d],function(){this.apply(a,h)})}}}var c=this;j.find=function(a){var d=j.cache[a];d||(d=new j(a));return d};var q=[];j.loadByIds=function(a,d){var h=[],l=[],s=$.map(a,function(t){var r=j.find(t);if(!r.load_started){h.push(t);r.load_started=true}r.loaded||l.push(t);return r});if(h.length)$.getJSON("/objects.json",
{ids:h},function(t){var r,n,v,i=[];$.each(t,function(){i.push(+this.id);j.find(this.id).update(this)});for(var x=0;x<q.length;x++){r=q[x];t=r[0];n=r[1];r=r[2];v=true;for(var y=0;y<n.length;y++)if($.inArray(n[y],i)==-1){v=false;break}v&&r(t)}d(s)});else l.length?q.push([s,l,d]):d(s);return s};j.cache={};o.loadAll=function(a){$.getJSON("/pet_attributes.json",function(d){a(d)})};m.find=function(a){var d=m.cache[a];d||(d=new m(a));return d};m.cache={};p.cache_by_color_and_species=new DeepObject;p.findOrCreateByColorAndSpecies=
function(a,d){var h=p.cache_by_color_and_species.deepGet(a,d);if(!h){h=new p;h.color_id=a;h.species_id=d}return h};e.Outfit=function(){function a(){var i=[],x=n.items.concat(n.pet_state.assets);$.each(x,function(){i=i.concat(this.restricted_zones)});return i}function d(i){n.events.trigger("updateItemAssets",i)}function h(i){n.events.trigger("updateItems",i)}function l(i){n.events.trigger("updatePetState",i)}function s(i){if(!n.pet_state||!i.ownsPetState(n.pet_state))n.setPetStateById();n.events.trigger("petTypeLoaded",
i);r()}function t(i){n.events.trigger("petTypeNotFound",i)}function r(){n.pet_type&&n.pet_type.loaded&&v.length&&n.pet_type.loadItemAssets(v,d)}var n=this,v=[];this.items=[];this.addItem=function(i){this.items.push(i);v.push(i.id);r();n.events.trigger("updateItems",this.items)};this.getVisibleAssets=function(){for(var i=this.pet_state.assets,x=a(),y=[],z=0;z<n.items.length;z++)i=i.concat(n.items[z].getAssetsFitting(n.pet_type));$.each(i,function(){$.inArray(this.zone_id,x)==-1&&y.push(this)});return y};
this.removeItem=function(i){i=$.inArray(i,this.items);if(i!=-1){this.items.splice(i,1);n.events.trigger("updateItems",this.items)}};this.setPetStateById=function(i){if(!i&&this.pet_type)i=this.pet_type.pet_state_ids[0];if(i){this.pet_state=m.find(i);this.pet_state.loadAssets(l)}};this.setPetTypeByColorAndSpecies=function(i,x){this.pet_type=p.findOrCreateByColorAndSpecies(i,x);n.events.trigger("updatePetType",this.pet_type);this.pet_type.load(s,t)};this.setItemsByIds=function(i){if(i)v=i;if(i&&i.length)this.items=
j.loadByIds(i,h);else{this.items=[];h(this.items)}r()}};e.Closet=function(){function a(l){d.events.trigger("updateItems",l)}var d=this,h=[];this.items=[];this.setItemsByIds=function(l){if(l&&l.length){h=l;this.items=j.loadByIds(l,a)}else{h=l;this.items=[];a(this.items)}}};e.BasePet=function(){var a=this;this.setName=function(d){a.name=d;a.events.trigger("updateName",d)}};e.PetAttributes=function(){function a(h){d.events.trigger("update",h)}var d=this;this.load=function(){o.loadAll(a)}};var u;for(var w in e)if(e.hasOwnProperty(w)){u=
w.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();c[u]=new e[w];e.apply(c[u])}this.initialize=function(){var a;for(var d in c.views)if(c.views.hasOwnProperty(d)){a=c.views[d];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){c.views={};$.each(a,function(d){c.views[d]=new this(c)})}}
if(document.location.search.substr(0,6)=="?debug")View.Console=function(b){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var k=["updateItems","updateItemAssets","updatePetType","updatePetState"],g=0;g<k.length;g++)(function(f){b.outfit.bind(f,function(j){log(f,j)})})(k[g]);b.outfit.bind("petTypeNotFound",function(f){log(f.toString()+" not found")})};
View.Closet=function(b){function k(p){for(var e,c,q=b.closet.items,u=0;u<q.length;u++){e=q[u];c=$.inArray(e,p)!=-1;$("li.object-"+e.id).toggleClass("worn",c).data({item:e,worn:c}).children("a.control-set").remove().end().append(f[c].clone())}}for(var g=$("#closet ul"),f={},j,o,m=0;m<2;m++){j=m==0;o="control-set-"+(j?"worn":"unworn");f[j]=$("<a/>",{"class":"control-set "+o,href:"#",text:j?"Unwear":"Wear"});(function(p){$("a."+o).live("click",function(e){var c=$(this).parent().data("item");!p?b.outfit.addItem(c):
b.outfit.removeItem(c);e.preventDefault()})})(j)}b.closet.bind("updateItems",function(p){var e,c;g.children().remove();for(var q=0;q<p.length;q++){e=p[q];c=$("<li/>",{"class":"object object-"+e.id});img=$("<img/>",{src:e.thumbnail_url,alt:e.description,title:e.description});c.append(img).append(e.name).appendTo(g)}k(b.outfit.items)});b.outfit.bind("updateItems",k)};
View.Hash=function(b){function k(){var e=(document.location.hash||document.location.search).substr(1);if(e!=j){var c={},q=e.split("&");o=true;for(var u=0;u<q.length;u++){var w=q[u].split("="),a=decodeURIComponent(w[0]);if(w=decodeURIComponent(w[1]))if(p[a]==m.INTEGER)c[a]=+w;else if(p[a]==m.STRING)c[a]=w;else if(a.substr(a.length-2)=="[]"){a=a.substr(0,a.length-2);if(p[a]==m.INTEGER_ARRAY){if(typeof c[a]=="undefined")c[a]=[];c[a].push(+w)}}}if(c.color!==f.color||c.species!==f.species)b.outfit.setPetTypeByColorAndSpecies(c.color,
c.species);if(c.closet)arraysMatch(c.closet,f.closet)||b.closet.setItemsByIds(c.closet.slice(0));else arraysMatch(c.objects,f.closet)||b.closet.setItemsByIds(c.objects.slice(0));arraysMatch(c.objects,f.objects)||b.outfit.setItemsByIds(c.objects.slice(0));c.name!=f.name&&c.name&&b.base_pet.setName(c.name);c.state!=f.state&&b.outfit.setPetStateById(c.state);f=c;o=false;j=e}}function g(e){var c;if(!o){for(var q in e)if(e.hasOwnProperty(q)){c=e[q];if(c===undefined)delete f[q];else f[q]=e[q]}j=e=$.param(f).replace(/%5B%5D/g,
"[]");document.location.hash="#"+e}}var f={},j,o=false,m={INTEGER:1,STRING:2,INTEGER_ARRAY:3},p={closet:m.INTEGER_ARRAY,color:m.INTEGER,name:m.STRING,objects:m.INTEGER_ARRAY,species:m.INTEGER,state:m.INTEGER};this.initialize=function(){k();setInterval(k,100)};b.outfit.bind("updateItems",function(e){e=e.map("id");var c={};if(!arraysMatch(e,f.objects))c.objects=e;c.closet=arraysMatch(e,f.closet)||arraysMatch(e,f.objects)?undefined:b.closet.items.map("id");if(c.objects||c.closet)g(c)});b.outfit.bind("updatePetType",
function(e){if(e.color_id!=f.color||e.species_id!=f.species)g({color:e.color_id,species:e.species_id,state:undefined})});b.outfit.bind("petTypeNotFound",function(){window.history.back()});b.outfit.bind("updatePetState",function(e){var c=b.outfit.pet_type;if(e.id!=f.state&&c&&(f.state||e.id!=c.pet_state_ids[0]))g({state:e.id})})};
View.Preview=function(b){function k(){var j;if(f)return false;if(g&&g.setAssets){j=b.outfit.getVisibleAssets();g.setAssets(j)}else f=true}$("#preview");var g,f=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){g=document.getElementById("preview-swf");if(f){f=false;k()}};b.outfit.bind("updateItems",k);b.outfit.bind("updateItemAssets",
k);b.outfit.bind("updatePetState",k)};
View.PetStateForm=function(b){function k(o){if(o){f.children("li.selected").removeClass("selected");$(j+"[value="+o.id+"]").attr("checked","checked").parent().addClass("selected")}}var g=$("#pet-state-form"),f=g.children("ul"),j="#pet-state-form input[name=pet_state_id]";$(j).live("click",function(){b.outfit.setPetStateById(+this.value)});b.outfit.bind("petTypeLoaded",function(o){o=o.pet_state_ids;var m,p,e,c;f.children().remove();if(o.length==1)g.hide();else{g.show();for(m=0;m<o.length;m++){p="pet-state-radio-"+
m;e=$("<li/>");c=$("<input/>",{id:p,name:"pet_state_id",type:"radio",value:o[m]});p=$("<label/>",{"for":p,text:m+1});m==0&&c.attr("checked","checked");c.appendTo(e);p.appendTo(e);e.appendTo(f)}k(b.outfit.pet_state)}});b.outfit.bind("updatePetState",k)};
View.PetTypeForm=function(b){function k(j){f&&j&&$.each(g,function(o){g[o].val(j[o+"_id"])})}var g={},f=false;$("#pet-type-form").submit(function(j){j.preventDefault();b.outfit.setPetTypeByColorAndSpecies(+g.color.val(),+g.species.val())}).children("select").each(function(){g[this.name]=$(this)});this.initialize=function(){b.pet_attributes.load()};b.pet_attributes.bind("update",function(j){$.each(j,function(o){var m=g[o];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(m)})});
f=true;k(b.outfit.pet_type)});b.outfit.bind("updatePetType",k)};View.Title=function(b){b.base_pet.bind("updateName",function(k){$("#title").text("Planning "+k+"'s outfit")})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
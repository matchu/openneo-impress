var View={},Partial={},main_wardrobe,ITEMS_SERVER="items.impress.openneo.net",SHORT_URL_HOST="http://bit.ly/";if(document.location.hostname.substr(0,5)=="beta.")ITEMS_SERVER="beta."+ITEMS_SERVER;ITEMS_SERVER="http://"+ITEMS_SERVER;window.log=window.SWFLog=$.noop;
function arraysMatch(d,n){var o;if(!$.isArray(d)||!$.isArray(n))return d==n;o=[];if(!d[0]||!n[0])return false;if(d.length!=n.length)return false;for(var h=0;h<d.length;h++){key=typeof d[h]+"~"+d[h];if(o[key])o[key]++;else o[key]=1}for(h=0;h<n.length;h++){key=typeof n[h]+"~"+n[h];if(o[key])if(o[key]==0)return false;else o[key]--;else return false}return true}Array.prototype.map=function(d){return $.map(this,function(n){return n[d]})};function DeepObject(){}
DeepObject.prototype.deepGet=function(){var d=this;$.each(arguments,function(){d=d[this];if(typeof d=="undefined")return false});return d};DeepObject.prototype.deepSet=function(){var d=$.proxy(Array.prototype.pop,"apply"),n=d(arguments);d=d(arguments);var o=this;$.each(arguments,function(){if(typeof o[this]=="undefined")o[this]={};o=o[this]});o[d]=n};
function Wardrobe(){function d(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function n(a){for(var c in a)if(a.hasOwnProperty(c))this[c]=a[c]}function o(a){n.apply(this,[a]);d.apply(this)}function h(a){n.apply(this,[a])}function m(a){var c=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(e){return this.assets_by_body_id[e.body_id]||[]};this.hasAssetsFitting=function(e){return typeof c.assets_by_body_id[e.body_id]!=
"undefined"&&c.assets_by_body_id[e.body_id].length>0};this.couldNotLoadAssetsFitting=function(e){return typeof c.assets_by_body_id[e.body_id]!="undefined"&&c.assets_by_body_id[e.body_id].length==0};this.update=function(e){for(var g in e)if(e.hasOwnProperty(g)&&g!="id")c[g]=e[g];d.apply(this);this.loaded=true};m.cache[a]=this}function s(a){this.name=a}function r(){}function v(a){var c=this,e=false;this.id=a;this.assets=[];this.loadAssets=function(g){e?g(c):$.getJSON("/biology_assets.json?parent_id="+
c.id,function(t){c.assets=$.map(t,function(q){return new o(q)});e=true;g(c)})};v.cache[a]=this}function k(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(c,e){a.loaded?c(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(g){if(g){for(var t in g)if(g.hasOwnProperty(t))a[t]=g[t];for(g=0;g<a.pet_state_ids.length;g++)a.pet_states.push(v.find(a.pet_state_ids[g]));k.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=
true;c(a)}else e(a)})};this.loadItemAssets=function(c,e){for(var g=[],t=0;t<c.length;t++){var q=c[t];m.find(q).hasAssetsFitting(a)||g.push(q)}g.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:g},function(i){$.each(i,function(){var z=m.find(this.parent_id),C=new h(this);if(typeof z.assets_by_body_id[a.body_id]=="undefined")z.assets_by_body_id[a.body_id]=[];z.assets_by_body_id[a.body_id].push(C)});for(var A=0,p=c.length;A<p;A++){i=m.find(c[A]);i.hasAssetsFitting(a)||(i.assets_by_body_id[a.body_id]=
[])}e()}):e()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(c){for(var e=0;e<this.pet_states.length;e++)if(this.pet_states[e]==c)return true;return false}}function b(){var a=this;this.events={};this.bind=function(c,e){if(typeof this.events[c]=="undefined")this.events[c]=[];this.events[c].push(e)};this.events.trigger=function(c){var e;if(a.events[c]){e=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[c],
function(){this.apply(a,e)})}}}var f=this;m.find=function(a){var c=m.cache[a];c||(c=new m(a));return c};var j=[];m.loadByIds=function(a,c){var e=[],g=[],t=$.map(a,function(q){var i=m.find(q);if(!i.load_started){e.push(q);i.load_started=true}i.loaded||g.push(q);return i});if(e.length)$.getJSON("/objects.json",{ids:e},function(q){var i,A,p,z=[];$.each(q,function(){z.push(+this.id);m.find(this.id).update(this)});for(var C=0;C<j.length;C++){i=j[C];q=i[0];A=i[1];i=i[2];p=true;for(var B=0;B<A.length;B++)if($.inArray(A[B],
z)==-1){p=false;break}p&&i(q)}c(t)});else g.length?j.push([t,g,c]):c(t);return t};var l=ITEMS_SERVER+"/index.js?callback=?";m.PER_PAGE=21;m.loadByQuery=function(a,c,e,g){var t=Math.round(c/m.PER_PAGE)+1;$.getJSON(l,{q:a,per_page:m.PER_PAGE,page:t},function(q){var i=[],A,p;if(q.items){for(var z=0;z<q.items.length;z++){p=q.items[z];A=m.find(p.id);A.update(p);i.push(A)}e(i,q.total_pages,t)}else q.error&&g(q.error)})};m.cache={};s.loadAll=function(a){$.getJSON(ITEMS_SERVER+"/item_zone_sets.js?callback=?",
function(c){for(var e=0,g=c.length;e<g;e++)s.all.push(new s(c[e]));a(s.all)})};s.all=[];r.loadAll=function(a){$.getJSON("/pet_attributes.json",function(c){a(c)})};v.find=function(a){var c=v.cache[a];c||(c=new v(a));return c};v.cache={};k.cache_by_color_and_species=new DeepObject;k.findOrCreateByColorAndSpecies=function(a,c){var e=k.cache_by_color_and_species.deepGet(a,c);if(!e){e=new k;e.color_id=a;e.species_id=c}return e};b.all={};b.all.Outfit=function(){function a(){var p=[],z=i.items.concat(i.pet_state.assets);
$.each(z,function(){p=p.concat(this.restricted_zones)});return p}function c(p){i.events.trigger("updateItems",p)}function e(p){i.events.trigger("updatePetState",p)}function g(p){if(!i.pet_state||!p.ownsPetState(i.pet_state))i.setPetStateById();i.events.trigger("petTypeLoaded",p);q()}function t(p){i.events.trigger("petTypeNotFound",p)}function q(p){i.pet_type&&i.pet_type.loaded&&A.length&&i.pet_type.loadItemAssets(A,function(){var z,C,B,G,D,H=[],I=[];if(p){z=p.getAssetsFitting(i.pet_type).map("zone_id");
C=z.length;for(var E=0;E<i.items.length;E++){B=i.items[E];G=B.getAssetsFitting(i.pet_type).map("zone_id");D=true;if(B!=p)for(var F=0;F<C;F++)if($.inArray(z[F],G)!=-1){D=false;break}if(D){H.push(B);I.push(B.id)}}i.items=H;A=I;i.events.trigger("updateItems",i.items)}i.events.trigger("updateItemAssets")})}var i=this,A=[];this.items=[];this.addItem=function(p){if($.inArray(p,i.items)==-1){this.items.push(p);A.push(p.id);q(p);i.events.trigger("updateItems",this.items)}};this.getVisibleAssets=function(){for(var p=
this.pet_state.assets,z=a(),C=[],B=0;B<i.items.length;B++)p=p.concat(i.items[B].getAssetsFitting(i.pet_type));$.each(p,function(){$.inArray(this.zone_id,z)==-1&&C.push(this)});return C};this.removeItem=function(p){var z=$.inArray(p,this.items);if(z!=-1){this.items.splice(z,1);p=$.inArray(p.id,A);A.splice(p,1);i.events.trigger("updateItems",this.items)}};this.setPetStateById=function(p){if(!p&&this.pet_type)p=this.pet_type.pet_state_ids[0];if(p){this.pet_state=v.find(p);this.pet_state.loadAssets(e)}};
this.setPetTypeByColorAndSpecies=function(p,z){this.pet_type=k.findOrCreateByColorAndSpecies(p,z);i.events.trigger("updatePetType",this.pet_type);this.pet_type.load(g,t)};this.setItemsByIds=function(p){if(p)A=p;if(p&&p.length)this.items=m.loadByIds(p,c);else{this.items=[];c(this.items)}q()}};b.all.Closet=function(){function a(g){c.events.trigger("updateItems",g)}var c=this,e=[];this.items=[];this.addItem=function(g){if($.inArray(g,c.items)==-1){this.items.push(g);e.push(g.id);c.events.trigger("updateItems",
this.items)}};this.removeItem=function(g){var t=$.inArray(g,this.items);if(t!=-1){this.items.splice(t,1);g=$.inArray(g.id,e);e.splice(g,1);c.events.trigger("updateItems",this.items)}};this.setItemsByIds=function(g){if(g&&g.length){e=g;this.items=m.loadByIds(g,a)}else{e=g;this.items=[];a(this.items)}}};b.all.BasePet=function(){var a=this;this.setName=function(c){a.name=c;a.events.trigger("updateName",c)}};b.all.PetAttributes=function(){function a(e){c.events.trigger("update",e)}var c=this;this.load=
function(){r.loadAll(a)}};b.all.ItemZoneSets=function(){function a(e){c.events.trigger("update",e)}var c=this;this.load=function(){s.loadAll(a)}};b.all.Search=function(){function a(g,t,q){e.events.trigger("updateItems",g);e.events.trigger("updatePagination",q,t)}function c(g){e.events.trigger("error",g)}var e=this;this.request={};this.setItemsByQuery=function(g,t){var q=typeof t.offset!="undefined"?t.offset:m.PER_PAGE*(t.page-1);e.request={query:g,offset:q};e.events.trigger("updateRequest",e.request);
if(g){m.loadByQuery(g,q,a,c);e.events.trigger("startRequest")}else{e.events.trigger("updateItems",[]);e.events.trigger("updatePagination",0,0)}};this.setPerPage=function(g){m.PER_PAGE=g}};var w,u;for(u in b.all)if(b.all.hasOwnProperty(u)){w=u.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();f[w]=new b.all[u];b.apply(f[w])}this.initialize=function(){var a,c;for(c in f.views)if(f.views.hasOwnProperty(c)){a=f.views[c];typeof a.initialize=="function"&&a.initialize()}};
this.registerViews=function(a){f.views={};$.each(a,function(c){f.views[c]=new this(f)})}}
Partial.ItemSet=function(d,n){function o(j){return function(l){for(var w,u=0;u<s.length;u++){w=s[u];in_set=$.inArray(w,l)!=-1;$("li.object-"+w.id).toggleClass(j,in_set).data("item",w).data(j,in_set).children("ul").children("li.control-set-for-"+j).remove().end()[j=="worn"?"prepend":"append"](Partial.ItemSet.CONTROL_SETS[j][in_set].clone())}}}function h(j){for(var l,w,u,a=0,c=j.length;a<c;a++){l=j[a];w=l.couldNotLoadAssetsFitting(d.outfit.pet_type);l=$("li.object-"+l.id).toggleClass("no-assets",w);
(function(e){u=e.find("span.no-assets-message");u.remove();w&&$("<span/>",{"class":"no-assets-message",text:"No data yet"}).appendTo(e)})(l)}}var m=$(n),s=[],r,v,k,b=$("#no-assets-full-message"),f=$("#container");Partial.ItemSet.setWardrobe(d);r=o("closeted");k=o("worn");v=function(j){k(j);h(j)};this.setItems=function(j){var l,w,u;s=j;m.children().remove();for(var a=0;a<s.length;a++){j=s[a];l=$("<li/>",{"class":"object object-"+j.id});img=$("<img/>",{src:j.thumbnail_url,alt:j.description,title:j.description});
w=$("<ul/>");u=$("<a/>",{"class":"object-info",html:"<span>i</span>",href:ITEMS_SERVER+"/"+j.id,target:"_blank"});if(typeof j.rarity_index!="undefined"&&(j.rarity_index==500||j.rarity_index==0))$("<div/>",{"class":"nc-icon",text:"NC",title:"NC"}).appendTo(l);l.append(img).append(w).append(u).append(j.name).appendTo(m)}r(d.closet.items);v(d.outfit.items)};$("span.no-assets-message").live("mouseover",function(){var j=$(this),l=j.offset();b.css({left:l.left+j.width()/2-b.width()/2-f.offset().left,top:l.top+
j.height()+10})}).live("mouseout",function(){b.removeAttr("style")});d.outfit.bind("updateItemAssets",function(){h(d.outfit.items)});d.outfit.bind("updateItems",v);d.closet.bind("updateItems",r)};Partial.ItemSet.CONTROL_SETS={};
Partial.ItemSet.setWardrobe=function(d){for(var n,o,h,m,s,r={},v=0;v<2;v++){n=v==0?"worn":"closeted";o=v==0?["Unwear","Wear"]:["Uncloset","Closet"];Partial.ItemSet.CONTROL_SETS[n]={};for(var k=0;k<2;k++){h=k==0;s="control-set control-set-for-"+n;m="control-set-"+(h?"":"not-")+n;s+=" "+m;Partial.ItemSet.CONTROL_SETS[n][h]=$("<a/>",{href:"#",text:o[h?0:1]}).wrap("<li/>").parent().attr("class",s);(function(b,f){$("li."+m+" a").live("click",function(j){var l=$(this).closest(".object").data("item");r[b][!f](l);
j.preventDefault()})})(n,h)}}r.closeted={};r.closeted[true]=$.proxy(d.closet,"addItem");r.closeted[false]=function(b){d.outfit.removeItem(b);d.closet.removeItem(b)};r.worn={};r.worn[true]=function(b){d.closet.addItem(b);d.outfit.addItem(b)};r.worn[false]=$.proxy(d.outfit,"removeItem");Partial.ItemSet.setWardrobe=$.noop};
if(document.location.search.substr(0,6)=="?debug")View.Console=function(d){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var n=["updateItems","updateItemAssets","updatePetType","updatePetState"],o=0;o<n.length;o++)(function(h){d.outfit.bind(h,function(m){log(h,m)})})(n[o]);d.outfit.bind("petTypeNotFound",function(h){log(h.toString()+" not found")})};
View.Closet=function(d){var n=new Partial.ItemSet(d,"#preview-closet ul");d.closet.bind("updateItems",$.proxy(n,"setItems"))};
View.Fullscreen=function(d){function n(){if(o){r=$("#preview-swf");var k={height:s.offset().top-m.offset().top,width:m.innerWidth()-v.outerWidth()-12},b={},f={},j={old:{height:r.height(),width:r.width()},next:{}};if(k.height>k.width){b.larger="height";b.smaller="width";f.active="marginTop";f.inactive="marginLeft"}else{b.larger="width";b.smaller="height";f.active="marginLeft";f.inactive="marginTop"}j.next[b.smaller]=k[b.smaller];j.next[b.larger]=k[b.smaller];j.next[f.active]=(k[b.larger]-j.next[b.larger])/
2;j.next[f.inactive]=0;r.css(j.next);m.height(k.height)}}var o=$(document.body).hasClass("fullscreen"),h=$(window),m=$("#preview"),s=$("#preview-search-form"),r=$("#preview-swf"),v=$("#preview-closet");$("#footer");$("#preview").data("fit",n);h.resize(n).load(n);n();konami=new function(){var k={addEvent:function(b,f,j,l){if(b.addEventListener)b.addEventListener(f,j,false);else if(b.attachEvent){b["e"+f+j]=j;b[f+j]=function(){b["e"+f+j](window.event,l)};b.attachEvent("on"+f,b[f+j])}},input:"",pattern:"3838404037393739666513",
load:function(b){this.addEvent(document,"keydown",function(f,j){if(j)k=j;k.input+=f?f.keyCode:event.keyCode;if(k.input.indexOf(k.pattern)!=-1){k.code(b);k.input=""}},this);this.iphone.load(b)},code:function(b){window.location=b},iphone:{start_x:0,start_y:0,stop_x:0,stop_y:0,tap:false,capture:false,keys:["UP","UP","DOWN","DOWN","LEFT","RIGHT","LEFT","RIGHT","TAP","TAP","TAP"],code:function(b){k.code(b)},load:function(b){k.addEvent(document,"touchmove",function(f){if(f.touches.length==1&&k.iphone.capture==
true){f=f.touches[0];k.iphone.stop_x=f.pageX;k.iphone.stop_y=f.pageY;k.iphone.tap=false;k.iphone.capture=false;k.iphone.check_direction()}});k.addEvent(document,"touchend",function(){k.iphone.tap==true&&k.iphone.check_direction(b)},false);k.addEvent(document,"touchstart",function(f){k.iphone.start_x=f.changedTouches[0].pageX;k.iphone.start_y=f.changedTouches[0].pageY;k.iphone.tap=true;k.iphone.capture=true})},check_direction:function(b){x_magnitude=Math.abs(this.start_x-this.stop_x);y_magnitude=Math.abs(this.start_y-
this.stop_y);x=this.start_x-this.stop_x<0?"RIGHT":"LEFT";y=this.start_y-this.stop_y<0?"DOWN":"UP";result=x_magnitude>y_magnitude?x:y;result=this.tap==true?"TAP":result;if(result==this.keys[0])this.keys=this.keys.slice(1,this.keys.length);this.keys.length==0&&this.code(b)}}};return k};konami.code=function(){$(document.body).removeClass("fullscreen");r.removeAttr("style").css("visibility","visible");m.removeAttr("style");d.search.setPerPage(21);d.search.setItemsByQuery(d.search.request.query,{offset:d.search.request.offset});
o=false};konami.load()};
View.Hash=function(d){function n(){var b=(document.location.hash||document.location.search).substr(1);if(b!=m){var f={},j=b.split("&");s=true;for(var l=0;l<j.length;l++){var w=j[l].split("="),u=decodeURIComponent(w[0]);if(w=decodeURIComponent(w[1]))if(v[u]==r.INTEGER)f[u]=+w;else if(v[u]==r.STRING)f[u]=decodeURIComponent(w).replace(/\+/g," ");else if(u.substr(u.length-2)=="[]"){u=u.substr(0,u.length-2);if(v[u]==r.INTEGER_ARRAY){if(typeof f[u]=="undefined")f[u]=[];f[u].push(+w)}}}if(f.color!==h.color||
f.species!==h.species)d.outfit.setPetTypeByColorAndSpecies(f.color,f.species);if(f.closet)arraysMatch(f.closet,h.closet)||d.closet.setItemsByIds(f.closet.slice(0));else arraysMatch(f.objects,h.closet)||d.closet.setItemsByIds(f.objects.slice(0));arraysMatch(f.objects,h.objects)||d.outfit.setItemsByIds(f.objects.slice(0));f.name!=h.name&&f.name&&d.base_pet.setName(f.name);f.state!=h.state&&d.outfit.setPetStateById(f.state);if(f.search!=h.search||f.search_offset!=h.search_offset)d.search.setItemsByQuery(f.search,
{offset:f.search_offset});h=f;s=false;m=b}}function o(b){var f;if(!s){for(var j in b)if(b.hasOwnProperty(j)){f=b[j];if(f===undefined)delete h[j];else h[j]=b[j]}m=b=$.param(h).replace(/%5B%5D/g,"[]");document.location.hash="#"+b;k()}}var h={},m,s=false,r={INTEGER:1,STRING:2,INTEGER_ARRAY:3},v={closet:r.INTEGER_ARRAY,color:r.INTEGER,name:r.STRING,objects:r.INTEGER_ARRAY,search:r.STRING,search_offset:r.INTEGER,species:r.INTEGER,state:r.INTEGER},k;this.initialize=function(){n();setInterval(n,100);k()};
d.closet.bind("updateItems",function(b){b=b.map("id");arraysMatch(b,h.closet)||o({closet:b})});d.outfit.bind("updateItems",function(b){b=b.map("id");var f={};if(!arraysMatch(b,h.objects))f.objects=b;f.closet=arraysMatch(b,h.closet)||arraysMatch(b,h.objects)?undefined:d.closet.items.map("id");if(f.objects||f.closet)o(f)});d.outfit.bind("updatePetType",function(b){if(b.color_id!=h.color||b.species_id!=h.species)o({color:b.color_id,species:b.species_id,state:undefined})});d.outfit.bind("petTypeNotFound",
function(){window.history.back()});d.outfit.bind("updatePetState",function(b){var f=d.outfit.pet_type;if(b.id!=h.state&&f&&(h.state||b.id!=f.pet_state_ids[0]))o({state:b.id})});d.search.bind("updateRequest",function(b){if(b.offset!=h.search_offset||b.query!=h.search)o({search_offset:b.offset,search:b.query})});(function(){function b(q){if(typeof addthis_share!="undefined"){addthis_share.url=q;w.replaceWith(w.clone());addthis.button(l)}}function f(){if(!g&&!t){g=true;BitlyClient.shorten(e,"BitlyCB."+
j)}}var j="shortenResponse",l="#share-button",w=$(l),u=w.parent(),a=$("#short-url-button"),c=$("#short-url-response"),e,g=false,t=false;k=function(){var q=window.location,i=q.hash;i||(i="#"+q.search.substr(1));e=q.protocol+"//"+q.host+q.pathname+i;b(e);c.hide();t=false};BitlyCB[j]=function(q){var i,A;for(A in q.results){i=SHORT_URL_HOST+q.results[A].hash;break}b(i);c.val(i).show();g=false;t=true};a.click(f);u.mouseover(f);w.focus(f);c.mouseover(function(){c.focus().select()})})()};
View.Preview=function(d){function n(){var m;if(h)return false;if(o&&o.setAssets){m=d.outfit.getVisibleAssets();o.setAssets(m)}else h=true}$("#preview");var o,h=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){o=document.getElementById("preview-swf");if(h){h=false;n()}};d.outfit.bind("updateItems",n);d.outfit.bind("updateItemAssets",
n);d.outfit.bind("updatePetState",n)};
View.PetStateForm=function(d){function n(s){if(s){h.children("li.selected").removeClass("selected");$(m+"[value="+s.id+"]").attr("checked","checked").parent().addClass("selected")}}var o=$("#pet-state-form"),h=o.children("ul"),m="#pet-state-form input[name=pet_state_id]";$(m).live("click",function(){d.outfit.setPetStateById(+this.value)});d.outfit.bind("petTypeLoaded",function(s){s=s.pet_state_ids;var r,v,k,b;h.children().remove();if(s.length==1)o.hide();else{o.show();for(r=0;r<s.length;r++){v="pet-state-radio-"+
r;k=$("<li/>");b=$("<input/>",{id:v,name:"pet_state_id",type:"radio",value:s[r]});v=$("<label/>",{"for":v,text:r+1});r==0&&b.attr("checked","checked");b.appendTo(k);v.appendTo(k);k.appendTo(h)}n(d.outfit.pet_state)}});d.outfit.bind("updatePetState",n)};
View.PetTypeForm=function(d){function n(m){h&&m&&$.each(o,function(s){o[s].val(m[s+"_id"])})}var o={},h=false;$("#pet-type-form").submit(function(m){m.preventDefault();d.outfit.setPetTypeByColorAndSpecies(+o.color.val(),+o.species.val())}).children("select").each(function(){o[this.name]=$(this)});this.initialize=function(){d.pet_attributes.load()};d.pet_attributes.bind("update",function(m){$.each(m,function(s){var r=o[s];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(r)})});
h=true;n(d.outfit.pet_type)});d.outfit.bind("updatePetType",n);d.outfit.bind("petTypeNotFound",function(){$("#pet-type-not-found").show("normal").delay(3E3).hide("fast")})};
View.Search=function(d){function n(){var a=Math.floor(h.width()/w);if(a!=l.PER_PAGE){l.PER_PAGE=a;d.search.setPerPage(l.PER_PAGE);if(u){a=u.offset;d.search.setItemsByQuery(s.val(),{offset:a})}}}function o(a,c){return function(e){var g=$("<select/>",{"class":"search-helper","data-search-filter":a}),t=$("span.search-helper[data-search-filter="+a+"]");e=c(e);for(var q=0,i=e.length;q<i;q++)$("<option/>",{text:e[q].name}).appendTo(g);t.replaceWith(function(){return g.clone().fadeIn("fast")})}}var h=$("#preview-search-form"),
m=new Partial.ItemSet(d,"#preview-search-form ul"),s=h.find("input[name=query]"),r=$("#preview-search-form-clear"),v=$("#preview-search-form-error"),k=$("#preview-search-form-help"),b=$("#preview-search-form-loading"),f=$("#preview-search-form-no-results"),j=f.children("span"),l={INNER_WINDOW:4,OUTER_WINDOW:1,GAP_TEXT:"&hellip;",PREV_TEXT:"&larr; Previous",NEXT_TEXT:"Next &rarr;",PAGE_EL:$("<a/>",{href:"#"}),CURRENT_EL:$("<span/>",{"class":"current"}),EL_ID:"#preview-search-form-pagination",PER_PAGE:21},
w=112,u;l.EL=$(l.EL_ID);l.GAP_EL=$("<span/>",{"class":"gap",html:l.GAP_TEXT});l.PREV_EL=$("<a/>",{href:"#",rel:"prev",html:l.PREV_TEXT});l.NEXT_EL=$("<a/>",{href:"#",rel:"next",html:l.NEXT_TEXT});$(l.EL_ID+" a").live("click",function(a){a.preventDefault();a=$(this).data("page");d.search.setItemsByQuery(s.val(),{page:a})});this.initialize=$.proxy(d.item_zone_sets,"load");d.search.setPerPage(l.PER_PAGE);$(window).resize(n).load(n);n();h.submit(function(a){a.preventDefault();d.search.setItemsByQuery(s.val(),
{page:1})});r.click(function(a){a.preventDefault();s.val("");h.submit()});d.search.bind("startRequest",function(){b.delay(1E3).show("slow")});d.search.bind("updateItems",function(a){var c=$("#preview").data("fit")||$.noop;b.stop(true,true).hide();m.setItems(a);if(d.search.request.query)a.length||f.show();else k.show();h.toggleClass("has-results",a.length>0);c()});d.search.bind("updateRequest",function(a){u=a;v.hide("fast");k.hide();f.hide();s.val(a.query||"");j.text(a.query);r.toggle(!!a.query)});
d.search.bind("updatePagination",function(a,c){var e=a-l.INNER_WINDOW,g=a+l.INNER_WINDOW,t,q,i=1;if(g>c){e-=g-c;g=c}if(e<1){g+=1-e;e=1;if(g>c)g=c}e=[2+l.OUTER_WINDOW,e];g=[g+1,c-l.OUTER_WINDOW];t=e[1]-e[0]>1;q=g[1]-g[0]>1;l.EL.children().remove();for(a>1&&l.PREV_EL.clone().data("page",a-1).appendTo(l.EL);i<=c;)if(t&&i>=e[0]&&i<e[1]){l.GAP_EL.clone().appendTo(l.EL);i=e[1]}else if(q&&i>=g[0]&&i<g[1]){l.GAP_EL.clone().appendTo(l.EL);i=g[1]}else{i==a?l.CURRENT_EL.clone().text(i).appendTo(l.EL):l.PAGE_EL.clone().text(i).data("page",
i).appendTo(l.EL);i++}a<c&&l.NEXT_EL.clone().data("page",a+1).appendTo(l.EL)});d.search.bind("error",function(a){b.stop(true,true).hide();v.text(a).show("normal")});k.find("dt").each(function(){var a=$(this);a.children().length||a.wrapInner($("<a/>",{href:"#"}))}).children("span:not(.search-helper)").each(function(){var a=$(this);a.replaceWith($("<a/>",{href:"#",text:a.text()}))});k.find("dt a").live("click",function(a){var c=$(this),e=c.parent().children();a.preventDefault();a=e.length>1?e.map(function(){var g=
$(this);return g[g.is("select")?"val":"text"]()}).get().join(""):c.text();s.val(a);h.submit()});$("select.search-helper").live("change",function(){var a=$(this),c=a.attr("data-search-filter");$("select.search-helper[data-search-filter="+c+"]").val(a.val())});d.item_zone_sets.bind("update",o("type",function(a){return a}));d.pet_attributes.bind("update",o("species",function(a){return a.species}))};View.Title=function(d){d.base_pet.bind("updateName",function(n){$("#title").text("Planning "+n+"'s outfit")})};
$.ajaxSetup({error:function(){$.jGrowl("There was an error loading that last resource. Oops. Please try again!")}});main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
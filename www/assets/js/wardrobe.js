Array.prototype.removeValue=function(q){q=$.inArray(q,this);q!=-1&&this.splice(q,1)};Array.prototype.clone=function(){return this.splice(0)};Array.prototype.toInt=function(){return $.map(this,function(q){return parseInt(q)})};
var MainWardrobe=new (function(){function q(b){function f(c,h){i.push(c+"="+encodeURIComponent(h))}var i=[];$.each(b,function(c,h){$.isArray(h)?$.each(h,function(){f(c+"[]",this)}):f(c,h)});return i.join("&")}function o(b,f,i,c){f=f?q(f):"";var h=b+"?"+f;if($.inArray(h,o.requestsLoading)==-1){o.requestsLoading.push(h);$.ajax($.extend(c,{url:b,data:f,dataType:"json",success:i,complete:function(){o.requestsLoading.removeValue(h)}}))}}function w(b){var f;f=n.pet_type.body_id;b.id=parseInt(b.id);b.parent_id=
parseInt(b.parent_id);for(var i in b)this[i]=b[i];this.constructor.cache[this.id]=this;(b=this.constructor.cache_by_body_and_parent_id[f])||(b=this.constructor.cache_by_body_and_parent_id[f]={});(f=b[this.parent_id])||(f=b[this.parent_id]=[]);f.push(this)}function v(b){this.inheritsFrom=w;this.inheritsFrom(b);this.is_body_specific=this.is_body_specific=="1";this.getObject=function(){return k.find(this.parent_id)}}function x(b){this.inheritsFrom=w;this.inheritsFrom(b)}function k(b,f){this.is_placeholder=
f?true:false;this.addToCloset=function(){var c=r.getObjectIds();c.push(this.id);m.set("closet",c)};this.addToOutfit=function(){this.isCloseted()||this.addToCloset();var c=n.getObjectIds();c.push(this.id);m.set("objects",c);n.removeObjectsConflictingWith(this)};this.getAssetsByBodyId=function(c){c=v.cache_by_body_and_parent_id[c];var h;if(c)h=c[this.id];return h?$.extend(true,[],h):[]};this.hasAssetsWithBodyId=function(c){return this.getAssetsByBodyId(c).length>0};this.isAvailable=function(){return!this.isUnavailable()};
this.isCloseted=function(){return $.inArray(this.id,r.getObjectIds())!=-1};this.isUnavailable=function(){return $.inArray(this.id,r.unavailable_object_ids)!=-1};this.isWorn=function(){return this.isAvailable()&&$.inArray(this.id,n.getObjectIds())!=-1};this.removeFromCloset=function(){this.removeFromOutfit();var c=r.getObjectIds();c.removeValue(this.id);m.set("closet",c)};this.removeFromOutfit=function(){var c=n.getObjectIds();c.removeValue(this.id);m.set("objects",c)};b.id=parseInt(b.id);for(var i in b)this[i]=
b[i];k.cache[this.id]=this}o.requestsLoading=[];$.each([v,x],function(){this.cache={};this.find=function(b){b=parseInt(b);return this.cache[b]};this.cache_by_body_and_parent_id={}});k.cache={};k.find=function(b){b=parseInt(b);var f=k.cache[b];f||(f=new k({id:b},true));return f};var r=new (function(){this.unavailable_object_ids=[];this.setUnavailableObjectIds=function(b){this.unavailable_object_ids=b.toInt();p.updateObjectStatuses()};this.clearObjectStatuses=function(){this.unavailable_object_ids=
[]};this.getObjectIds=function(){return m.get("closet")?m.get("closet").toInt():[]};this.getObjects=function(){return $.map(m.get("closet"),function(b){return k.find(b)})};this.initialize=function(){m.get("objects")&&!m.get("closet")&&m.set("closet",m.get("objects"));this.update()};this.update=function(){var b=m.get("closet");if(b){b=$.grep(m.get("closet"),function(f){return k.find(f).is_placeholder});if(b.length){r.clearObjectStatuses();o("/objects.json",{ids:b},function(f){$.each(f,function(){object=
new k(this)});p.modules.closet.update()})}}}}),m=new (function(){function b(){return(document.location.hash||document.location.search).substr(1)}function f(){h={};var a=b(),e=a.split("&");$.each(e,function(){var g=this.split("="),l=decodeURIComponent(g[0]);g=decodeURIComponent(g[1]);var j=l.match(/(.+)\[\]/);if(j){h[j[1]]||(h[j[1]]=[]);h[j[1]].push(g)}else h[l]=g});d=a}function i(a,e){h[a]=e}function c(){document.location.hash=q(h)}var h=null,d;this.get=function(a){h||f();return h[a]};this.set=function(a,
e){typeof a=="object"?$.each(a,i):i(a,e);c()};setInterval(function(){if(b()!=d){f();n.update();r.update()}},100)}),n=new (function(){function b(a,e){$.each(a,function(){new e(this)})}function f(){o("/biology_assets.json",{parent_id:c.pet_type.pet_state_ids[0]},function(a){d=a;b(a,x);p.Outfit.update()})}function i(){var a=m.get("species"),e=m.get("color");if(!this.pet_type||a!=this.pet_type.species_id||e!=this.pet_type.color_id){p.Outfit.hideBiologyAssets();o("/pet_types.json",{"for":"wardrobe",species_id:a,
color_id:e},function(g){if(g){c.pet_type&&g.body_id!=c.pet_type.body_id&&p.Outfit.removeBodySpecificAssets();g.species_id=a;g.color_id=e;c.pet_type=g;f();c.updateObjects()}else{p.error("Pet type not found!");p.Outfit.showBiologyAssets()}})}else c.updateObjects()}var c=this,h=[],d;this.restricted_zones=[];this.pet_type=null;this.getAssets=function(){var a=d;$.each(this.getObjectIds(),function(){var e=k.find(this);a=a.concat(e.getAssetsByBodyId(c.pet_type.body_id))});return a};this.getObjectIds=function(){var a=
m.get("objects");return a?a.toInt():[]};this.getObjects=function(){return $.map(this.getObjectIds(),function(a){return k.find(a)})};this.removeObjectsConflictingWith=function(a){h.push(a)};this.removeObjectsConflictingWithQueue=function(){$.each(h,function(){var a=this,e=this.getAssetsByBodyId(c.pet_type.body_id);$.each(e,function(){var g=this;$.each(c.getObjects(),function(){var l;if(a.id!=this.id){l=this.getAssetsByBodyId(c.pet_type.body_id);for(var j in l)l[j].zone_id==g.zone_id&&this.removeFromOutfit()}})})});
h=[]};this.setRestrictedZones=function(){this.restricted_zones=[];$.each(this.getObjects(),function(){var a;for(a=0;(a=this.zones_restrict.indexOf("1",a))!=-1;){a=a+1;c.restricted_zones.push(a);a=a}})};this.updateObjects=function(){function a(){var g=$.grep(e.clone(),function(l){return!k.find(l).hasAssetsWithBodyId(c.pet_type.body_id)});c.setRestrictedZones();c.removeObjectsConflictingWithQueue();r.setUnavailableObjectIds(g);p.Outfit.update()}var e=$.grep(this.getObjectIds(),function(g){return!k.find(g).hasAssetsWithBodyId(c.pet_type.body_id)});
e.length?o("/object_assets.json",{parent_ids:e,body_id:c.pet_type.body_id},function(g){b(g,v);a()}):a()};this.initialize=this.update=i}),A=new (function(){var b=[];this.getObjects=function(){return b};$("#search-form").submit(function(f){f.preventDefault();$("#search-module-error").hide();o("/objects.json",{search:$("#search-form-query").val()},function(i){b=[];$.each(i,function(){b.push(new k(this))});p.modules.search.update()},{error:function(i){$("#search-module-error").text(i.responseText).show();
b=[];p.modules.search.update()}})})}),p=new (function(){function b(d,a){this.afterUpdate=function(){};this.object_owner=a;this.objects_wrapper_query=d;this.update=function(){var e=$(this.objects_wrapper_query).html("");$.each(this.object_owner.getObjects(),function(){var g=$("<li></li>").attr({id:"object-"+this.id,"class":"object"}).data("object_id",this.id);$("<img />").attr({src:this.thumbnail_url,alt:"",height:80,width:80}).appendTo(g);g.append("<span>"+this.name+"</span>").wrapInner("<div></div>").appendTo(e)});
i.updateObjectStatuses();this.afterUpdate()}}function f(){var d={top:null,left:null},a={height:$(window).height()-c.bottom.outerHeight(),width:$(window).width()-c.right.outerWidth()};$.each(c,function(){this.css(d)});c.right.css("height",null);c.bottom.width(a.width);a.height>a.width?$("#outfit-preview").css({height:a.width,left:null,width:a.width,top:(a.height-a.width)/2}):$("#outfit-preview").css({height:a.height,left:(a.width-a.height)/2,width:a.height,top:null});i.Outfit.Watermark.update_position();
$("#object-description").css({bottom:c.bottom.outerHeight(),right:c.right.outerWidth()})}var i=this;this.Outfit=new (function(){this.hideBiologyAssets=function(){$(".biology-asset").hide()};this.removeBodySpecificAssets=function(){$(".body-specific-asset").remove()};this.showBiologyAssets=function(){$(".biology-asset").show()};this.update=function(){$(".outfit-asset").each(function(){var d=$(this),a=d.attr("data-parent-id");if(d.hasClass("object-asset")){a=k.find(a);a.isWorn()||d.remove()}else n.pet_type.id!=
a&&d.remove()});$.each(n.getAssets(),function(){var d=this.constructor==v;if(d&&this.getObject().isWorn()||!d){var a="outfit-asset-"+this.id+"-"+(d?"object":"biology");d="outfit-asset "+(d?"object-asset":"biology-asset");var e=$("#"+a);if(!e.length){$('<div id="'+a+'"></div>').appendTo("#outfit-preview");if(this.is_body_specific)d+=" body-specific-asset";attrs={"class":d,style:"z-index: "+this.depth,"data-parent-id":this.parent_id};swfobject.embedSWF(this.url,a,"100%","100%","9","/assets/js/swfobject/expressInstall.swf",
null,{wmode:"transparent"},attrs)}e.toggle($.inArray(parseInt(this.zone_id),n.restricted_zones)==-1)}});this.Watermark.update()};this.Watermark=new (function(){var d=this,a,e={r:[0,0.2],e:[0,0.7],s:[0.5,0.2],t:[0.5,0.7],m:[0.25,0.45]},g=false;this.update=function(){function l(){for(var j=$("#"+a+"s"),s="",u=0;u<25;u++)s+=String.fromCharCode(Math.random()*26+97);j.length&&j.remove();for(var t in e){j=$("."+a+t);if(j.length)j.attr("class",s+t);else{j=$("<div>The Wardrobe</div>");j.attr("class",s+t).appendTo(document.body)}}a=
s;d.update_position()}g?l():$(function(){l();g=true})};this.update_position=function(){function l(){var j=$("#outfit-preview"),s=j.height(),u=j.width(),t=j.offset(),y="";$.each(e,function(B,z){y+="."+a+B+" {opacity: .1; filter:alpha(opacity=30);position: absolute;left: "+(u*z[0]+t.left)+"px;top: "+(s*z[1]+t.top)+"px;width: "+u/2+"px;color: #fff;font-weight: bold;text-align: center;text-shadow: #000 1px 1px;z-index: 100;}"});$('<style type="text/css">'+y+"</style>").attr("id",a+"s").appendTo("head");
$("#outfit-preview").css("zIndex",1)}g?l():$(function(){l();g=true})}})});this.modules=[];this.modules.closet=new b("#closet-module-objects",r);this.modules.pet_type=new (function(){o("/pet_attributes.json",null,function(d){$.each(d,function(a,e){var g=$("#pet-type-form-"+a),l=m.get(a);$.each(e,function(){var j=$('<option value="'+this.id+'">'+this.name+"</option>");this.id==l&&j.attr("selected","selected");j.appendTo(g)})});$("#pet-type-form").css("visibility","visible")});$("#pet-type-form").submit(function(d){d.preventDefault();
var a={};$.each(["species","color"],function(){a[this]=$("#pet-type-form-"+this+" option:selected").val()});m.set(a);n.update()})});this.modules.search=new b("#search-module-objects",A);this.modules.search.afterUpdate=function(){var d=this.object_owner.getObjects(),a=$(this.objects_wrapper_query);d=a.children(".object:first").outerWidth()*d.length;a.width(d);$("#toolbar-bottom").animate({height:a.outerHeight()+a.position().top},250,f)};this.updateObjectStatuses=function(){$(".object").each(function(){var d=
$(this),a=k.find(d.data("object_id"));d.toggleClass("unavailable-object",a.isUnavailable());d.toggleClass("worn-object",a.isWorn())})};var c={},h={ghost:true,stop:f};$.each({bottom:{handles:"n"},right:{handles:"w"}},function(d,a){c[d]=$("#toolbar-"+d).resizable($.extend(h,a))});$(window).resize(f);f();$(".object").live("mouseenter",function(){var d=$(this),a=$("#object-description");if(!d.children(".object-action").length){var e=k.find(d.data("object_id")),g="";function l(j){var s=j.toLowerCase();
$('<a href="#" class="object-action object-action-'+s+'">'+j+"</a>").appendTo(d)}e.isWorn()?l("Unwear"):l("Wear");e.isCloseted()?l("Uncloset"):l("Closet");if(e.isUnavailable())g='<p class="ui-state-error">We haven\'t seen this body type wearing this item before. If you have, go to the homepage and add the pet, so we can get that data! Thanks!</p>';a.html("<h1>"+e.name+" ("+[e.rarity,e.rarity_index].join(" - ")+")</h1><p>"+e.description+"</p>"+g+"<dl><dt>Type</dt><dd>"+e.type+"</dd><dt>Est. Price</dt><dd>"+
e.price+"</dd></dl>").css("backgroundImage","url("+e.thumbnail_url+")").show()}}).live("mouseleave",function(){$(this).children(".object-action").remove();$("#object-description").hide()});this.error=function(d){alert(d)};$(".object-action-wear").live("click",function(d){var a=$(this).parent();a=k.find(a.data("object_id"));d.preventDefault();a.addToOutfit();n.updateObjects();i.modules.closet.update()});$(".object-action-unwear").live("click",function(d){var a=$(this).parent();a=k.find(a.data("object_id"));
d.preventDefault();a.removeFromOutfit();i.Outfit.update();i.modules.closet.update()});$(".object-action-closet").live("click",function(d){var a=$(this).parent();a=k.find(a.data("object_id"));d.preventDefault();a.addToCloset();i.modules.closet.update()});$(".object-action-uncloset").live("click",function(d){var a=$(this).parent();a=k.find(a.data("object_id"));d.preventDefault();a.removeFromCloset();i.Outfit.update();i.modules.closet.update()})});n.initialize();r.initialize()});
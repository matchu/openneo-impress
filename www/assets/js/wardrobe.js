Array.prototype.removeValue=function(q){q=$.inArray(q,this);q!=-1&&this.splice(q,1)};Array.prototype.clone=function(){return this.splice(0)};Array.prototype.toInt=function(){return $.map(this,function(q){return parseInt(q)})};
var MainWardrobe=new (function(){function q(d){function f(c,g){h.push(c+"="+encodeURIComponent(g))}var h=[];$.each(d,function(c,g){$.isArray(g)?$.each(g,function(){f(c+"[]",this)}):f(c,g)});return h.join("&")}function p(d,f,h,c){f=f?q(f):"";var g=d+"?"+f;if($.inArray(g,p.requestsLoading)==-1){p.requestsLoading.push(g);$.ajax($.extend(c,{url:d,data:f,dataType:"json",success:h,complete:function(){p.requestsLoading.removeValue(g)}}))}}function x(d){var f;f=n.pet_type.body_id;d.id=parseInt(d.id);d.parent_id=
parseInt(d.parent_id);for(var h in d)this[h]=d[h];this.constructor.cache[this.id]=this;(d=this.constructor.cache_by_body_and_parent_id[f])||(d=this.constructor.cache_by_body_and_parent_id[f]={});(f=d[this.parent_id])||(f=d[this.parent_id]=[]);f.push(this)}function v(d){this.inheritsFrom=x;this.inheritsFrom(d);this.is_body_specific=this.is_body_specific=="1";this.getObject=function(){return l.find(this.parent_id)}}function w(d){this.inheritsFrom=x;this.inheritsFrom(d)}function l(d,f){this.is_placeholder=
f?true:false;this.addToCloset=function(){var c=r.getObjectIds();c.push(this.id);j.set("closet",c)};this.addToOutfit=function(){this.isCloseted()||this.addToCloset();var c=n.getObjectIds();c.push(this.id);j.set("objects",c);n.removeObjectsConflictingWith(this)};this.getAssetsByBodyId=function(c){c=v.cache_by_body_and_parent_id[c];var g;if(c)g=c[this.id];return g?$.extend(true,[],g):[]};this.hasAssetsWithBodyId=function(c){return this.getAssetsByBodyId(c).length>0};this.isAvailable=function(){return!this.isUnavailable()};
this.isCloseted=function(){return $.inArray(this.id,r.getObjectIds())!=-1};this.isUnavailable=function(){return $.inArray(this.id,r.unavailable_object_ids)!=-1};this.isWorn=function(){return this.isAvailable()&&$.inArray(this.id,n.getObjectIds())!=-1};this.removeFromCloset=function(){this.removeFromOutfit();var c=r.getObjectIds();c.removeValue(this.id);j.set("closet",c)};this.removeFromOutfit=function(){var c=n.getObjectIds();c.removeValue(this.id);j.set("objects",c)};d.id=parseInt(d.id);for(var h in d)this[h]=
d[h];l.cache[this.id]=this}p.requestsLoading=[];$.each([v,w],function(){this.cache={};this.find=function(d){d=parseInt(d);return this.cache[d]};this.cache_by_body_and_parent_id={}});l.cache={};l.find=function(d){d=parseInt(d);var f=l.cache[d];f||(f=new l({id:d},true));return f};var r=new (function(){this.unavailable_object_ids=[];this.setUnavailableObjectIds=function(d){this.unavailable_object_ids=d.toInt();o.updateObjectStatuses()};this.clearObjectStatuses=function(){this.unavailable_object_ids=
[]};this.getObjectIds=function(){return j.get("closet")?j.get("closet").toInt():[]};this.getObjects=function(){return $.map(j.get("closet"),function(d){return l.find(d)})};this.initialize=function(){j.get("objects")&&!j.get("closet")&&j.set("closet",j.get("objects"));this.update()};this.update=function(){var d=j.get("closet");if(d){d=$.grep(j.get("closet"),function(f){return l.find(f).is_placeholder});if(d.length){r.clearObjectStatuses();p("/objects.json",{ids:d},function(f){$.each(f,function(){object=
new l(this)});o.modules.closet.update()})}}}}),j=new (function(){function d(){return(document.location.hash||document.location.search).substr(1)}function f(){g={};var b=d(),e=b.split("&");$.each(e,function(){var i=this.split("="),m=decodeURIComponent(i[0]);i=decodeURIComponent(i[1]);var k=m.match(/(.+)\[\]/);if(k){g[k[1]]||(g[k[1]]=[]);g[k[1]].push(i)}else g[m]=i});a=b}function h(b,e){g[b]=e}function c(){document.location.hash=q(g)}var g=null,a;this.get=function(b){g||f();return g[b]};this.set=function(b,
e){typeof b=="object"?$.each(b,h):h(b,e);c()};setInterval(function(){if(d()!=a){f();n.update();r.update()}},100)}),n=new (function(){function d(a,b){$.each(a,function(){new b(this)})}function f(){var a=w.cache_by_body_and_parent_id[c.pet_type.body_id],b,e=j.get("state");if(a)b=a[e];if(b){c.biology_assets=b;o.Outfit.update()}else p("/biology_assets.json",{parent_id:e},function(i){c.biology_assets=i;d(i,w);o.Outfit.update()})}function h(){var a=j.get("species"),b=j.get("color");if(!this.pet_type||a!=
this.pet_type.species_id||b!=this.pet_type.color_id){o.Outfit.hideBiologyAssets();p("/pet_types.json",{"for":"wardrobe",species_id:a,color_id:b},function(e){if(e){c.pet_type&&e.body_id!=c.pet_type.body_id&&o.Outfit.removeBodySpecificAssets();e.species_id=a;e.color_id=b;c.pet_type=e;j.get("state")||j.set("state",c.pet_type.pet_state_ids[0]);f();o.modules.pet_state.update();c.updateObjects()}else{o.error("Pet type not found!");o.Outfit.showBiologyAssets()}})}else c.updateObjects()}var c=this,g=[];this.biology_assets=
[];this.pet_type=null;this.restricted_zones=[];this.getAssets=function(){var a=c.biology_assets;$.each(this.getObjectIds(),function(){var b=l.find(this);a=a.concat(b.getAssetsByBodyId(c.pet_type.body_id))});return a};this.getObjectIds=function(){var a=j.get("objects");return a?a.toInt():[]};this.getObjects=function(){return $.map(this.getObjectIds(),function(a){return l.find(a)})};this.removeObjectsConflictingWith=function(a){g.push(a)};this.removeObjectsConflictingWithQueue=function(){$.each(g,function(){var a=
this,b=this.getAssetsByBodyId(c.pet_type.body_id);$.each(b,function(){var e=this;$.each(c.getObjects(),function(){var i;if(a.id!=this.id){i=this.getAssetsByBodyId(c.pet_type.body_id);for(var m in i)i[m].zone_id==e.zone_id&&this.removeFromOutfit()}})})});g=[]};this.setRestrictedZones=function(){this.restricted_zones=[];$.each(this.getObjects(),function(){var a;for(a=0;(a=this.zones_restrict.indexOf("1",a))!=-1;){a=a+1;c.restricted_zones.push(a);a=a}})};this.updateObjects=function(){function a(){var e=
$.grep(b.clone(),function(i){return!l.find(i).hasAssetsWithBodyId(c.pet_type.body_id)});c.setRestrictedZones();c.removeObjectsConflictingWithQueue();r.setUnavailableObjectIds(e);o.Outfit.update()}var b=$.grep(this.getObjectIds(),function(e){return!l.find(e).hasAssetsWithBodyId(c.pet_type.body_id)});b.length?p("/object_assets.json",{parent_ids:b,body_id:c.pet_type.body_id},function(e){d(e,v);a()}):a()};this.updatePetState=function(a){j.set("state",a);f()};this.initialize=this.update=h}),A=new (function(){var d=
[];this.getObjects=function(){return d};$("#search-form").submit(function(f){f.preventDefault();$("#search-module-error").hide();p("/objects.json",{search:$("#search-form-query").val()},function(h){d=[];$.each(h,function(){d.push(new l(this))});o.modules.search.update()},{error:function(h){$("#search-module-error").text(h.responseText).show();d=[];o.modules.search.update()}})})}),o=new (function(){function d(a,b){this.afterUpdate=function(){};this.object_owner=b;this.objects_wrapper_query=a;this.update=
function(){var e=$(this.objects_wrapper_query).html("");$.each(this.object_owner.getObjects(),function(){var i=$("<li></li>").attr({id:"object-"+this.id,"class":"object"}).data("object_id",this.id);$("<img />").attr({src:this.thumbnail_url,alt:"",height:80,width:80}).appendTo(i);i.append("<span>"+this.name+"</span>").wrapInner("<div></div>").appendTo(e)});h.updateObjectStatuses();this.afterUpdate()}}function f(){var a={top:null,left:null},b=$(window);available={height:b.height()-c.bottom.outerHeight(),
width:b.width()-c.right.outerWidth()};$.each(c,function(){this.css(a)});c.right.css("height",null);c.bottom.width(available.width);$("#toolbar-float").css("right",c.right.outerWidth());available.height>available.width?$("#outfit-preview").css({height:available.width,left:null,width:available.width,top:(available.height-available.width)/2}):$("#outfit-preview").css({height:available.height,left:(available.width-available.height)/2,width:available.height,top:null});h.Outfit.Watermark.update_position();
$("#object-description").css({bottom:c.bottom.outerHeight(),right:c.right.outerWidth()})}var h=this;this.Outfit=new (function(){this.hideBiologyAssets=function(){$(".biology-asset").hide()};this.removeBodySpecificAssets=function(){$(".body-specific-asset").remove()};this.showBiologyAssets=function(){$(".biology-asset").show()};this.update=function(){$(".outfit-asset").each(function(){var a=$(this),b;b=$.map(n.biology_assets,function(e){return e.id});if(a.hasClass("object-asset")){b=l.find(a.attr("data-parent-id"));
b.isWorn()||a.remove()}else $.inArray(parseInt(a.attr("data-id")),b)==-1&&a.remove()});$.each(n.getAssets(),function(){var a=this.constructor==v;if(a&&this.getObject().isWorn()||!a){var b="outfit-asset-"+this.id+"-"+(a?"object":"biology");a="outfit-asset "+(a?"object-asset":"biology-asset");var e=$("#"+b);if(!e.length){$('<div id="'+b+'"></div>').appendTo("#outfit-preview");if(this.is_body_specific)a+=" body-specific-asset";attrs={"class":a,style:"z-index: "+this.depth,"data-id":this.id,"data-parent-id":this.parent_id};
swfobject.embedSWF(this.url,b,"100%","100%","9","/assets/js/swfobject/expressInstall.swf",null,{wmode:"transparent"},attrs)}e.toggle($.inArray(parseInt(this.zone_id),n.restricted_zones)==-1)}});this.Watermark.update()};this.Watermark=new (function(){var a=this,b,e={r:[0,0.2],e:[0,0.7],s:[0.5,0.2],t:[0.5,0.7],m:[0.25,0.45]},i=false;this.update=function(){function m(){for(var k=$("#"+b+"s"),s="",u=0;u<25;u++)s+=String.fromCharCode(Math.random()*26+97);k.length&&k.remove();for(var t in e){k=$("."+b+
t);if(k.length)k.attr("class",s+t);else{k=$("<div>The Wardrobe</div>");k.attr("class",s+t).appendTo(document.body)}}b=s;a.update_position()}i?m():$(function(){m();i=true})};this.update_position=function(){function m(){var k=$("#outfit-preview"),s=k.height(),u=k.width(),t=k.offset(),y="";$.each(e,function(B,z){y+="."+b+B+" {opacity: .1; filter:alpha(opacity=30);position: absolute;left: "+(u*z[0]+t.left)+"px;top: "+(s*z[1]+t.top)+"px;width: "+u/2+"px;color: #fff;font-weight: bold;text-align: center;text-shadow: #000 1px 1px;z-index: 100;}"});
$('<style type="text/css">'+y+"</style>").attr("id",b+"s").appendTo("head");$("#outfit-preview").css("zIndex",1)}i?m():$(function(){m();i=true})}})});this.modules=[];this.modules.closet=new d("#closet-module-objects",r);this.modules.pet_state=new (function(){this.update=function(){var a=$("#pet-state-list").html("");$.each(n.pet_type.pet_state_ids,function(){var b=this;$("<a/>",{href:"#",text:"State #"+b,click:function(e){e.preventDefault();n.updatePetState(b)}}).wrap("<li/>").parent().appendTo(a)})}});
this.modules.pet_type=new (function(){p("/pet_attributes.json",null,function(a){$.each(a,function(b,e){var i=$("#pet-type-form-"+b),m=j.get(b);$.each(e,function(){var k=$('<option value="'+this.id+'">'+this.name+"</option>");this.id==m&&k.attr("selected","selected");k.appendTo(i)})});$("#pet-type-form").css("visibility","visible")});$("#pet-type-form").submit(function(a){a.preventDefault();var b={};$.each(["species","color"],function(){b[this]=$("#pet-type-form-"+this+" option:selected").val()});
j.set(b);n.update()})});this.modules.search=new d("#search-module-objects",A);this.modules.search.afterUpdate=function(){var a=this.object_owner.getObjects(),b=$(this.objects_wrapper_query);a=b.children(".object:first").outerWidth()*a.length;b.width(a);$("#toolbar-bottom").animate({height:b.outerHeight()+b.position().top},250,f)};this.updateObjectStatuses=function(){$(".object").each(function(){var a=$(this),b=l.find(a.data("object_id"));a.toggleClass("unavailable-object",b.isUnavailable());a.toggleClass("worn-object",
b.isWorn())})};var c={},g={ghost:true,stop:f};$.each({bottom:{handles:"n"},right:{handles:"w"}},function(a,b){c[a]=$("#toolbar-"+a).resizable($.extend(g,b))});$(window).resize(f);f();$(".object").live("mouseenter",function(){var a=$(this),b=$("#object-description");if(!a.children(".object-action").length){var e=l.find(a.data("object_id")),i="";function m(k){var s=k.toLowerCase();$('<a href="#" class="object-action object-action-'+s+'">'+k+"</a>").appendTo(a)}e.isWorn()?m("Unwear"):m("Wear");e.isCloseted()?
m("Uncloset"):m("Closet");if(e.isUnavailable())i='<p class="ui-state-error">We haven\'t seen this body type wearing this item before. If you have, go to the homepage and add the pet, so we can get that data! Thanks!</p>';b.html("<h1>"+e.name+" ("+[e.rarity,e.rarity_index].join(" - ")+")</h1><p>"+e.description+"</p>"+i+"<dl><dt>Type</dt><dd>"+e.type+"</dd><dt>Est. Price</dt><dd>"+e.price+"</dd></dl>").css("backgroundImage","url("+e.thumbnail_url+")").show()}}).live("mouseleave",function(){$(this).children(".object-action").remove();
$("#object-description").hide()});this.error=function(a){alert(a)};$(".object-action-wear").live("click",function(a){var b=$(this).parent();b=l.find(b.data("object_id"));a.preventDefault();b.addToOutfit();n.updateObjects();h.modules.closet.update()});$(".object-action-unwear").live("click",function(a){var b=$(this).parent();b=l.find(b.data("object_id"));a.preventDefault();b.removeFromOutfit();h.Outfit.update();h.modules.closet.update()});$(".object-action-closet").live("click",function(a){var b=$(this).parent();
b=l.find(b.data("object_id"));a.preventDefault();b.addToCloset();h.modules.closet.update()});$(".object-action-uncloset").live("click",function(a){var b=$(this).parent();b=l.find(b.data("object_id"));a.preventDefault();b.removeFromCloset();h.Outfit.update();h.modules.closet.update()})});n.initialize();r.initialize()});
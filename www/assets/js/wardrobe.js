var View={},main_wardrobe;window.log=$.noop;function DeepObject(){}DeepObject.prototype.deepGet=function(){var c=this;$.each(arguments,function(){c=c[this];if(typeof c=="undefined")return false});return c};DeepObject.prototype.deepSet=function(){var c=$.proxy(Array.prototype.pop,"apply"),g=c(arguments);c=c(arguments);var l=this;$.each(arguments,function(){if(typeof l[this]=="undefined")l[this]={};l=l[this]});l[c]=g};
function Wardrobe(){function c(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function g(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b]}function l(a){g.apply(this,[a]);c.apply(this)}function j(a){g.apply(this,[a])}function i(a){var b=this;this.id=a;this.assets=[];this.loaded=false;this.update=function(e){$.each(e,function(o,n){b[o]=n});c.apply(this);this.loaded=true};i.cache[a]=this}function r(a){var b=this;this.id=a;this.assets=
[];this.assets.load=function(e){$.getJSON("/biology_assets.json?parent_id="+b.id,function(o){b.assets=$.map(o,function(n){return new l(n)});e(b)})}}function p(){var a=this,b=false;this.pet_states=[];this.load=function(e,o){b?e(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(n){if(n){$.each(n,function(s){a[s]=this});$.each(a.pet_state_ids,function(){a.pet_states.push(new r(this))});p.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);
b=true;e(a)}else o(a)})};this.loadItemAssets=function(e,o){$.getJSON("/object_assets.json?body_id="+a.body_id,{parent_ids:e},function(n){var s=[];$.each(n,function(){var v=i.find(this.parent_id),m=new j(this);v.assets.push(m);s.push(m)});o(s)})};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"}}function h(){var a=this;this.events={};this.bind=function(b,e){if(typeof this.events[b]=="undefined")this.events[b]=[];this.events[b].push(e)};this.events.trigger=
function(b){var e;if(a.events[b]){e=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[b],function(){this.apply(a,e)})}}}var f=this;i.find=function(a){var b=i.cache[a];b||(b=new i(a));return b};i.loadByIds=function(a,b){var e=[],o=$.map(a,function(n){var s=i.find(n);s.loaded||e.push(n);return s});e.length?$.getJSON("/objects.json",{ids:e},function(n){$.each(n,function(){i.find(this.id).update(this)});b(o)}):b(o);return o};i.cache={};p.cache_by_color_and_species=new DeepObject;p.findOrCreateByColorAndSpecies=
function(a,b){var e=p.cache_by_color_and_species.deepGet(a,b);if(!e){e=new p;e.color_id=a;e.species_id=b}return e};h.Outfit=function(){function a(){var d=[],t=m.items.concat(m.pet_state.assets);$.each(t,function(){d=d.concat(this.restricted_zones)});return d}function b(d){m.events.trigger("updateItemAssets",d)}function e(d){m.events.trigger("updateItems",d)}function o(d){m.pet_state=d;m.events.trigger("updatePetState",d)}function n(d){if(d==u){m.pet_type=d;m.events.trigger("updatePetType",d);d.pet_states[0].assets.load(o);
v()}}function s(d){if(d==u){m.events.trigger("petTypeNotFound",d);u=null}}function v(){m.pet_type&&w.length&&m.pet_type.loadItemAssets(w,b)}var m=this,u,w=[];this.items=[];this.getVisibleAssets=function(){var d=[],t=a(),x=m.items.concat([m.pet_state]);$.each(x,function(){$.each(this.assets,function(){$.inArray(this.zone_id,t)==-1&&d.push(this)})});return d};this.setPetTypeByColorAndSpecies=function(d,t){u=p.findOrCreateByColorAndSpecies(d,t);u.load(n,s)};this.setItemsByIds=function(d){w=d;if(d.length)this.items=
i.loadByIds(d,e);v()}};h.BasePet=function(){var a=this;this.setName=function(b){a.name=b;a.events.trigger("updateName",b)}};var q;for(var k in h)if(h.hasOwnProperty(k)){q=k.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();f[q]=new h[k];h.apply(f[q])}this.initialize=function(){var a;for(var b in f.views)if(f.views.hasOwnProperty(b)){a=f.views[b];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){f.views={};$.each(a,function(b){f.views[b]=
new this(f)})}}if(document.location.search.substr(0,6)=="?debug")View.Console=function(c){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};$.each(["updateItems","updateItemAssets","updatePetType","updatePetState"],function(){var g=this;c.outfit.bind(g,function(l){log(g,l)})});c.outfit.bind("petTypeNotFound",function(g){log(g.toString()+" not found")})};
View.Hash=function(c){function g(){var h=(document.location.hash||document.location.search).substr(1);if(h!=i){l(h);i=h}}function l(h){var f={};$.each(h.split("&"),function(){var q=this.split("="),k=decodeURIComponent(q[0]);if(q=decodeURIComponent(q[1]))if(p[k]==r.INTEGER)f[k]=+q;else if(p[k]==r.STRING)f[k]=q;else if(k.substr(k.length-2)=="[]"){k=k.substr(0,k.length-2);if(p[k]==r.INTEGER_ARRAY){if(typeof f[k]=="undefined")f[k]=[];f[k].push(+q)}}});if(f.color!==j.color||f.species!==j.species)c.outfit.setPetTypeByColorAndSpecies(f.color,
f.species);f.objects!==j.objects&&c.outfit.setItemsByIds(f.objects);f.name!=j.name&&c.base_pet.setName(f.name);j=f}var j={},i,r={INTEGER:1,STRING:2,ARRAY:3},p={color:r.INTEGER,name:r.STRING,objects:r.INTEGER_ARRAY,species:r.INTEGER};this.initialize=function(){g();setInterval(g,100)};c.outfit.bind("updatePetType",function(h){if(h.color_id!=j.color||h.species_id!=j.species){j.color=h.color_id;j.species=h.species_id;i=h=$.param(j);document.location.hash="#"+h}})};
View.Preview=function(c){function g(){var i;if(j)return false;if(l&&l.setAssets){log("Getting assets");i=c.outfit.getVisibleAssets();log("Setting assets");log(i);l.setAssets(i)}else{log("Will set assets once SWF is ready");j=true}}$("#preview");var l,j=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.10","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){log("Preview SWF is ready");l=
document.getElementById("preview-swf");if(j){log("About to set assets");j=false;g()}};c.outfit.bind("updateItems",g);c.outfit.bind("updateItemAssets",g);c.outfit.bind("updatePetState",g)};View.Title=function(c){c.base_pet.bind("updateName",function(g){$("#title").text("Planning "+g+"'s outfit")})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
var View={},main_wardrobe;window.log=window.SWFLog=$.noop;function DeepObject(){}DeepObject.prototype.deepGet=function(){var d=this;$.each(arguments,function(){d=d[this];if(typeof d=="undefined")return false});return d};DeepObject.prototype.deepSet=function(){var d=$.proxy(Array.prototype.pop,"apply"),k=d(arguments);d=d(arguments);var h=this;$.each(arguments,function(){if(typeof h[this]=="undefined")h[this]={};h=h[this]});h[d]=k};
function Wardrobe(){function d(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function k(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b]}function h(a){k.apply(this,[a]);d.apply(this)}function l(a){k.apply(this,[a])}function c(a){var b=this;this.id=a;this.assets_by_body_id={};this.loaded=false;this.getAssetsFitting=function(e){return this.assets_by_body_id[e.body_id]||[]};this.hasAssetsFitting=function(e){return typeof b.assets_by_body_id[e.body_id]!=
"undefined"};this.update=function(e){for(var j in e)if(e.hasOwnProperty(j))b[j]=e[j];d.apply(this);this.loaded=true};c.cache[a]=this}function n(){}function o(a){var b=this,e=false;this.id=a;this.assets=[];this.loadAssets=function(j){e?j(b):$.getJSON("/biology_assets.json?parent_id="+b.id,function(q){b.assets=$.map(q,function(t){return new h(t)});e=true;j(b)})};o.cache[a]=this}function m(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(b,e){a.loaded?b(a):$.getJSON("/pet_types.json",
{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(j){if(j){for(var q in j)if(j.hasOwnProperty(q))a[q]=j[q];for(j=0;j<a.pet_state_ids.length;j++)a.pet_states.push(o.find(a.pet_state_ids[j]));m.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=true;b(a)}else e(a)})};this.loadItemAssets=function(b,e){for(var j=[],q=0;q<b.length;q++){var t=b[q];c.find(t).hasAssetsFitting(a)||j.push(t)}j.length&&$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:j},
function(w){$.each(w,function(){var p=c.find(this.parent_id),u=new l(this);if(typeof p.assets_by_body_id[a.body_id]=="undefined")p.assets_by_body_id[a.body_id]=[];p.assets_by_body_id[a.body_id].push(u)});e([])})};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(b){for(var e=0;e<this.pet_states.length;e++)if(this.pet_states[e]==b)return true;return false}}function s(){var a=this;this.events={};this.bind=function(b,e){if(typeof this.events[b]==
"undefined")this.events[b]=[];this.events[b].push(e)};this.events.trigger=function(b){var e;if(a.events[b]){e=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[b],function(){this.apply(a,e)})}}}var f=this;c.find=function(a){var b=c.cache[a];b||(b=new c(a));return b};c.loadByIds=function(a,b){var e=[],j=$.map(a,function(q){var t=c.find(q);t.loaded||e.push(q);return t});e.length?$.getJSON("/objects.json",{ids:e},function(q){$.each(q,function(){c.find(this.id).update(this)});b(j)}):b(j);return j};
c.cache={};n.loadAll=function(a){$.getJSON("/pet_attributes.json",function(b){a(b)})};o.find=function(a){var b=o.cache[a];b||(b=new o(a));return b};o.cache={};m.cache_by_color_and_species=new DeepObject;m.findOrCreateByColorAndSpecies=function(a,b){var e=m.cache_by_color_and_species.deepGet(a,b);if(!e){e=new m;e.color_id=a;e.species_id=b}return e};s.Outfit=function(){function a(){var g=[],v=p.items.concat(p.pet_state.assets);$.each(v,function(){g=g.concat(this.restricted_zones)});return g}function b(g){p.events.trigger("updateItemAssets",
g)}function e(g){p.events.trigger("updateItems",g)}function j(g){p.events.trigger("updatePetState",g)}function q(g){if(!p.pet_state||!g.ownsPetState(p.pet_state))p.setPetStateById();p.events.trigger("petTypeLoaded",g);w()}function t(g){p.events.trigger("petTypeNotFound",g)}function w(){p.pet_type&&p.pet_type.loaded&&u.length&&p.pet_type.loadItemAssets(u,b)}var p=this,u=[];this.items=[];this.getVisibleAssets=function(){var g=this.pet_state.assets,v=a(),x=[];$.each(this.items,function(){g=g.concat(this.getAssetsFitting(p.pet_type))});
$.each(g,function(){$.inArray(this.zone_id,v)==-1&&x.push(this)});return x};this.setPetStateById=function(g){if(!g&&this.pet_type)g=this.pet_type.pet_state_ids[0];if(g){this.pet_state=o.find(g);this.pet_state.loadAssets(j)}};this.setPetTypeByColorAndSpecies=function(g,v){this.pet_type=m.findOrCreateByColorAndSpecies(g,v);p.events.trigger("updatePetType",this.pet_type);this.pet_type.load(q,t)};this.setItemsByIds=function(g){if(g){u=g;this.items=g.length?c.loadByIds(g,e):[]}else this.items=[];w()}};
s.BasePet=function(){var a=this;this.setName=function(b){a.name=b;a.events.trigger("updateName",b)}};s.PetAttributes=function(){function a(e){b.events.trigger("update",e)}var b=this;this.load=function(){n.loadAll(a)}};var i;for(var r in s)if(s.hasOwnProperty(r)){i=r.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();f[i]=new s[r];s.apply(f[i])}this.initialize=function(){var a;for(var b in f.views)if(f.views.hasOwnProperty(b)){a=f.views[b];typeof a.initialize==
"function"&&a.initialize()}};this.registerViews=function(a){f.views={};$.each(a,function(b){f.views[b]=new this(f)})}}
if(document.location.search.substr(0,6)=="?debug")View.Console=function(d){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};var k=["updateItems","updateItemAssets","updatePetType","updatePetState"];for(var h in k)(function(l){d.outfit.bind(l,function(c){log(l,c)})})(k[h]);d.outfit.bind("petTypeNotFound",function(l){log(l.toString()+" not found")})};
View.Hash=function(d){function k(){var f=(document.location.hash||document.location.search).substr(1);if(f!=n){h(f);n=f}}function h(f){var i={};o=true;$.each(f.split("&"),function(){var r=this.split("="),a=decodeURIComponent(r[0]);if(r=decodeURIComponent(r[1]))if(s[a]==m.INTEGER)i[a]=+r;else if(s[a]==m.STRING)i[a]=r;else if(a.substr(a.length-2)=="[]"){a=a.substr(0,a.length-2);if(s[a]==m.INTEGER_ARRAY){if(typeof i[a]=="undefined")i[a]=[];i[a].push(+r)}}});if(i.color!==c.color||i.species!==c.species)d.outfit.setPetTypeByColorAndSpecies(i.color,
i.species);i.objects!==c.objects&&d.outfit.setItemsByIds(i.objects);i.name!=c.name&&i.name&&d.base_pet.setName(i.name);i.state!=c.state&&d.outfit.setPetStateById(i.state);c=i;o=false}function l(f){var i;if(!o){for(var r in f)if(f.hasOwnProperty(r)){i=f[r];if(i===undefined)delete c[r];else c[r]=f[r]}n=f=$.param(c);document.location.hash="#"+f}}var c={},n,o=false,m={INTEGER:1,STRING:2,INTEGER_ARRAY:3},s={color:m.INTEGER,name:m.STRING,objects:m.INTEGER_ARRAY,species:m.INTEGER,state:m.INTEGER};this.initialize=
function(){k();setInterval(k,100)};d.outfit.bind("updatePetType",function(f){if(f.color_id!=c.color||f.species_id!=c.species)l({color:f.color_id,species:f.species_id,state:undefined})});d.outfit.bind("petTypeNotFound",function(){window.history.back()});d.outfit.bind("updatePetState",function(f){var i=d.outfit.pet_type;if(f.id!=c.state&&(!i||f.id!=i.pet_state_ids[0]))l({state:f.id})})};
View.Preview=function(d){function k(){var c;if(l)return false;if(h&&h.setAssets){c=d.outfit.getVisibleAssets();h.setAssets(c)}else l=true}$("#preview");var h,l=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){h=document.getElementById("preview-swf");if(l){l=false;k()}};d.outfit.bind("updateItems",k);d.outfit.bind("updateItemAssets",
k);d.outfit.bind("updatePetState",k)};
View.PetStateForm=function(d){function k(c){if(c){h.children("li.selected").removeClass("selected");$(l+"[value="+c.id+"]").attr("checked","checked").parent().addClass("selected")}}var h=$("#pet-state-form").children("ul"),l="#pet-state-form input[name=pet_state_id]";$(l).live("click",function(){d.outfit.setPetStateById(+this.value)});d.outfit.bind("petTypeLoaded",function(c){c=c.pet_state_ids;var n,o,m,s;h.children().remove();for(n=0;n<c.length;n++){o="pet-state-radio-"+n;m=$("<li/>");s=$("<input/>",
{id:o,name:"pet_state_id",type:"radio",value:c[n]});o=$("<label/>",{"for":o,text:n+1});n==0&&s.attr("checked","checked");s.appendTo(m);o.appendTo(m);m.appendTo(h)}k(d.outfit.pet_state)});d.outfit.bind("updatePetState",k)};
View.PetTypeForm=function(d){function k(c){l&&c&&$.each(h,function(n){h[n].val(c[n+"_id"])})}var h={},l=false;$("#pet-type-form").submit(function(c){c.preventDefault();d.outfit.setPetTypeByColorAndSpecies(+h.color.val(),+h.species.val())}).children("select").each(function(){h[this.name]=$(this)});this.initialize=function(){d.pet_attributes.load()};d.pet_attributes.bind("update",function(c){$.each(c,function(n){var o=h[n];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(o)})});
l=true;k(d.outfit.pet_type)});d.outfit.bind("updatePetType",k)};View.Title=function(d){d.base_pet.bind("updateName",function(k){$("#title").text("Planning "+k+"'s outfit")})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
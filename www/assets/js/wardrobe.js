var View={},Partial={},main_wardrobe;window.log=window.SWFLog=$.noop;function arraysMatch(b,o){var m;if(!$.isArray(b)||!$.isArray(o))return b==o;m=[];if(!b[0]||!o[0])return false;if(b.length!=o.length)return false;for(var f=0;f<b.length;f++){key=typeof b[f]+"~"+b[f];if(m[key])m[key]++;else m[key]=1}for(f=0;f<o.length;f++){key=typeof o[f]+"~"+o[f];if(m[key])if(m[key]==0)return false;else m[key]--;else return false}return true}Array.prototype.map=function(b){return $.map(this,function(o){return o[b]})};
function DeepObject(){}DeepObject.prototype.deepGet=function(){var b=this;$.each(arguments,function(){b=b[this];if(typeof b=="undefined")return false});return b};DeepObject.prototype.deepSet=function(){var b=$.proxy(Array.prototype.pop,"apply"),o=b(arguments);b=b(arguments);var m=this;$.each(arguments,function(){if(typeof m[this]=="undefined")m[this]={};m=m[this]});m[b]=o};
function Wardrobe(){function b(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function o(a){for(var c in a)if(a.hasOwnProperty(c))this[c]=a[c]}function m(a){o.apply(this,[a]);b.apply(this)}function f(a){o.apply(this,[a])}function e(a){var c=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(h){return this.assets_by_body_id[h.body_id]||[]};this.hasAssetsFitting=function(h){return typeof c.assets_by_body_id[h.body_id]!=
"undefined"&&c.assets_by_body_id[h.body_id].length>0};this.couldNotLoadAssetsFitting=function(h){return typeof c.assets_by_body_id[h.body_id]!="undefined"&&c.assets_by_body_id[h.body_id].length==0};this.update=function(h){for(var j in h)if(h.hasOwnProperty(j)&&j!="id")c[j]=h[j];b.apply(this);this.loaded=true};e.cache[a]=this}function k(){}function l(a){var c=this,h=false;this.id=a;this.assets=[];this.loadAssets=function(j){h?j(c):$.getJSON("/biology_assets.json?parent_id="+c.id,function(s){c.assets=
$.map(s,function(u){return new m(u)});h=true;j(c)})};l.cache[a]=this}function r(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(c,h){a.loaded?c(a):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(j){if(j){for(var s in j)if(j.hasOwnProperty(s))a[s]=j[s];for(j=0;j<a.pet_state_ids.length;j++)a.pet_states.push(l.find(a.pet_state_ids[j]));r.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=true;c(a)}else h(a)})};
this.loadItemAssets=function(c,h){for(var j=[],s=0;s<c.length;s++){var u=c[s];e.find(u).hasAssetsFitting(a)||j.push(u)}j.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:j},function(n){$.each(n,function(){var v=e.find(this.parent_id),z=new f(this);if(typeof v.assets_by_body_id[a.body_id]=="undefined")v.assets_by_body_id[a.body_id]=[];v.assets_by_body_id[a.body_id].push(z)});for(var w=0,i=c.length;w<i;w++){n=e.find(c[w]);n.hasAssetsFitting(a)||(n.assets_by_body_id[a.body_id]=[])}h()}):
h()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(c){for(var h=0;h<this.pet_states.length;h++)if(this.pet_states[h]==c)return true;return false}}function q(){var a=this;this.events={};this.bind=function(c,h){if(typeof this.events[c]=="undefined")this.events[c]=[];this.events[c].push(h)};this.events.trigger=function(c){var h;if(a.events[c]){h=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[c],function(){this.apply(a,
h)})}}}var d=this;e.find=function(a){var c=e.cache[a];c||(c=new e(a));return c};var g=[];e.loadByIds=function(a,c){var h=[],j=[],s=$.map(a,function(u){var n=e.find(u);if(!n.load_started){h.push(u);n.load_started=true}n.loaded||j.push(u);return n});if(h.length)$.getJSON("/objects.json",{ids:h},function(u){var n,w,i,v=[];$.each(u,function(){v.push(+this.id);e.find(this.id).update(this)});for(var z=0;z<g.length;z++){n=g[z];u=n[0];w=n[1];n=n[2];i=true;for(var y=0;y<w.length;y++)if($.inArray(w[y],v)==
-1){i=false;break}i&&n(u)}c(s)});else j.length?g.push([s,j,c]):c(s);return s};var p="items.impress.openneo.net/index.js?callback=?";if(document.location.hostname.substr(0,5)=="beta.")p="beta."+p;p="http://"+p;e.loadByQuery=function(a,c,h,j){$.getJSON(p,{q:a,per_page:21,page:c},function(s){var u=[],n,w;if(s.items){for(var i=0;i<s.items.length;i++){w=s.items[i];n=e.find(w.id);n.update(w);u.push(n)}h(u,s.total_pages)}else s.error&&j(s.error)})};e.cache={};k.loadAll=function(a){$.getJSON("/pet_attributes.json",
function(c){a(c)})};l.find=function(a){var c=l.cache[a];c||(c=new l(a));return c};l.cache={};r.cache_by_color_and_species=new DeepObject;r.findOrCreateByColorAndSpecies=function(a,c){var h=r.cache_by_color_and_species.deepGet(a,c);if(!h){h=new r;h.color_id=a;h.species_id=c}return h};q.Outfit=function(){function a(){var i=[],v=n.items.concat(n.pet_state.assets);$.each(v,function(){i=i.concat(this.restricted_zones)});return i}function c(i){n.events.trigger("updateItems",i)}function h(i){n.events.trigger("updatePetState",
i)}function j(i){if(!n.pet_state||!i.ownsPetState(n.pet_state))n.setPetStateById();n.events.trigger("petTypeLoaded",i);u()}function s(i){n.events.trigger("petTypeNotFound",i)}function u(i){n.pet_type&&n.pet_type.loaded&&w.length&&n.pet_type.loadItemAssets(w,function(){var v,z,y,D,A,E=[],F=[];if(i){v=i.getAssetsFitting(n.pet_type).map("zone_id");z=v.length;for(var B=0;B<n.items.length;B++){y=n.items[B];D=y.getAssetsFitting(n.pet_type).map("zone_id");A=true;if(y!=i)for(var C=0;C<z;C++)if($.inArray(v[C],
D)!=-1){A=false;break}if(A){E.push(y);F.push(y.id)}}n.items=E;w=F;n.events.trigger("updateItems",n.items)}n.events.trigger("updateItemAssets")})}var n=this,w=[];this.items=[];this.addItem=function(i){if($.inArray(i,n.items)==-1){this.items.push(i);w.push(i.id);u(i);n.events.trigger("updateItems",this.items)}};this.getVisibleAssets=function(){for(var i=this.pet_state.assets,v=a(),z=[],y=0;y<n.items.length;y++)i=i.concat(n.items[y].getAssetsFitting(n.pet_type));$.each(i,function(){$.inArray(this.zone_id,
v)==-1&&z.push(this)});return z};this.removeItem=function(i){var v=$.inArray(i,this.items);if(v!=-1){this.items.splice(v,1);i=$.inArray(i.id,w);w.splice(i,1);n.events.trigger("updateItems",this.items)}};this.setPetStateById=function(i){if(!i&&this.pet_type)i=this.pet_type.pet_state_ids[0];if(i){this.pet_state=l.find(i);this.pet_state.loadAssets(h)}};this.setPetTypeByColorAndSpecies=function(i,v){this.pet_type=r.findOrCreateByColorAndSpecies(i,v);n.events.trigger("updatePetType",this.pet_type);this.pet_type.load(j,
s)};this.setItemsByIds=function(i){if(i)w=i;if(i&&i.length)this.items=e.loadByIds(i,c);else{this.items=[];c(this.items)}u()}};q.Closet=function(){function a(j){c.events.trigger("updateItems",j)}var c=this,h=[];this.items=[];this.addItem=function(j){if($.inArray(j,c.items)==-1){this.items.push(j);h.push(j.id);c.events.trigger("updateItems",this.items)}};this.removeItem=function(j){var s=$.inArray(j,this.items);if(s!=-1){this.items.splice(s,1);j=$.inArray(j.id,h);h.splice(j,1);c.events.trigger("updateItems",
this.items)}};this.setItemsByIds=function(j){if(j&&j.length){h=j;this.items=e.loadByIds(j,a)}else{h=j;this.items=[];a(this.items)}}};q.BasePet=function(){var a=this;this.setName=function(c){a.name=c;a.events.trigger("updateName",c)}};q.PetAttributes=function(){function a(h){c.events.trigger("update",h)}var c=this;this.load=function(){k.loadAll(a)}};q.Search=function(){function a(h){c.events.trigger("error",h)}var c=this;this.setItemsByQuery=function(h,j){if(h&&j)e.loadByQuery(h,j,function(s,u){c.events.trigger("updateItems",
s);c.events.trigger("updatePagination",j,u)},a);else{c.events.trigger("updateItems",[]);c.events.trigger("updatePagination",0,0)}c.events.trigger("updateRequest",{query:h,page:j})}};var t;for(var x in q)if(q.hasOwnProperty(x)){t=x.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();d[t]=new q[x];q.apply(d[t])}this.initialize=function(){var a;for(var c in d.views)if(d.views.hasOwnProperty(c)){a=d.views[c];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=
function(a){d.views={};$.each(a,function(c){d.views[c]=new this(d)})}}
Partial.ItemSet=function(b,o){function m(d){return function(g){for(var p,t=0;t<k.length;t++){p=k[t];in_set=$.inArray(p,g)!=-1;$("li.object-"+p.id).toggleClass(d,in_set).data("item",p).data(d,in_set).children("ul").children("li.control-set-for-"+d).remove().end()[d=="worn"?"prepend":"append"](Partial.ItemSet.CONTROL_SETS[d][in_set].clone())}}}function f(d){for(var g,p,t=0,x=d.length;t<x;t++){g=d[t];p=g.couldNotLoadAssetsFitting(b.outfit.pet_type);$("li.object-"+g.id).toggleClass("no-assets",p)}}var e=
$(o),k=[],l,r,q;Partial.ItemSet.setWardrobe(b);l=m("closeted");q=m("worn");r=function(d){q(d);f(d)};this.setItems=function(d){var g,p;k=d;e.children().remove();for(var t=0;t<k.length;t++){d=k[t];g=$("<li/>",{"class":"object object-"+d.id});img=$("<img/>",{src:d.thumbnail_url,alt:d.description,title:d.description});p=$("<ul/>");g.append(img).append(p).append(d.name).appendTo(e)}l(b.closet.items);r(b.outfit.items)};b.outfit.bind("updateItemAssets",function(){f(b.outfit.items)});b.outfit.bind("updateItems",
r);b.closet.bind("updateItems",l)};Partial.ItemSet.CONTROL_SETS={};
Partial.ItemSet.setWardrobe=function(b){for(var o,m,f,e,k,l={},r=0;r<2;r++){o=r==0?"worn":"closeted";m=r==0?["Unwear","Wear"]:["Uncloset","Closet"];Partial.ItemSet.CONTROL_SETS[o]={};for(var q=0;q<2;q++){f=q==0;k="control-set control-set-for-"+o;e="control-set-"+(f?"":"not-")+o;k+=" "+e;Partial.ItemSet.CONTROL_SETS[o][f]=$("<a/>",{href:"#",text:m[f?0:1]}).wrap("<li/>").parent().attr("class",k);(function(d,g){$("li."+e+" a").live("click",function(p){var t=$(this).closest(".object").data("item");l[d][!g](t);
p.preventDefault()})})(o,f)}}l.closeted={};l.closeted[true]=$.proxy(b.closet,"addItem");l.closeted[false]=function(d){b.outfit.removeItem(d);b.closet.removeItem(d)};l.worn={};l.worn[true]=function(d){b.closet.addItem(d);b.outfit.addItem(d)};l.worn[false]=$.proxy(b.outfit,"removeItem");Partial.ItemSet.setWardrobe=$.noop};
if(document.location.search.substr(0,6)=="?debug")View.Console=function(b){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var o=["updateItems","updateItemAssets","updatePetType","updatePetState"],m=0;m<o.length;m++)(function(f){b.outfit.bind(f,function(e){log(f,e)})})(o[m]);b.outfit.bind("petTypeNotFound",function(f){log(f.toString()+" not found")})};
View.Closet=function(b){var o=new Partial.ItemSet(b,"#preview-closet ul");b.closet.bind("updateItems",$.proxy(o,"setItems"))};
View.Hash=function(b){function o(){var d=(document.location.hash||document.location.search).substr(1);if(d!=e){var g={},p=d.split("&");k=true;for(var t=0;t<p.length;t++){var x=p[t].split("="),a=decodeURIComponent(x[0]);if(x=decodeURIComponent(x[1]))if(r[a]==l.INTEGER)g[a]=+x;else if(r[a]==l.STRING)g[a]=decodeURIComponent(x).replace(/\+/g," ");else if(a.substr(a.length-2)=="[]"){a=a.substr(0,a.length-2);if(r[a]==l.INTEGER_ARRAY){if(typeof g[a]=="undefined")g[a]=[];g[a].push(+x)}}}if(g.color!==f.color||
g.species!==f.species)b.outfit.setPetTypeByColorAndSpecies(g.color,g.species);if(g.closet)arraysMatch(g.closet,f.closet)||b.closet.setItemsByIds(g.closet.slice(0));else arraysMatch(g.objects,f.closet)||b.closet.setItemsByIds(g.objects.slice(0));arraysMatch(g.objects,f.objects)||b.outfit.setItemsByIds(g.objects.slice(0));g.name!=f.name&&g.name&&b.base_pet.setName(g.name);g.state!=f.state&&b.outfit.setPetStateById(g.state);if(g.search!=f.search||g.search_page!=f.search_page)b.search.setItemsByQuery(g.search,
g.search_page);f=g;k=false;q();e=d}}function m(d){var g;if(!k){for(var p in d)if(d.hasOwnProperty(p)){g=d[p];if(g===undefined)delete f[p];else f[p]=d[p]}e=d=$.param(f).replace(/%5B%5D/g,"[]");document.location.hash="#"+d;q()}}var f={},e,k=false,l={INTEGER:1,STRING:2,INTEGER_ARRAY:3},r={closet:l.INTEGER_ARRAY,color:l.INTEGER,name:l.STRING,objects:l.INTEGER_ARRAY,search:l.STRING,search_page:l.INTEGER,species:l.INTEGER,state:l.INTEGER},q;this.initialize=function(){o();setInterval(o,100)};b.outfit.bind("updateItems",
function(d){d=d.map("id");var g={};if(!arraysMatch(d,f.objects))g.objects=d;g.closet=arraysMatch(d,f.closet)||arraysMatch(d,f.objects)?undefined:b.closet.items.map("id");if(g.objects||g.closet)m(g)});b.outfit.bind("updatePetType",function(d){if(d.color_id!=f.color||d.species_id!=f.species)m({color:d.color_id,species:d.species_id,state:undefined})});b.outfit.bind("petTypeNotFound",function(){window.history.back()});b.outfit.bind("updatePetState",function(d){var g=b.outfit.pet_type;if(d.id!=f.state&&
g&&(f.state||d.id!=g.pet_state_ids[0]))m({state:d.id})});b.search.bind("updateRequest",function(d){if(d.page!=f.search_page||d.query!=f.search)m({search_page:d.page,search:d.query})});(function(){ZeroClipboard.setMoviePath("/assets/swf/ZeroClipboard.swf");var d=$("#shorten-url-response"),g=$("#shorten-url-form"),p=$("#shorten-url-response-form"),t=$("#shorten-url-loading"),x=new ZeroClipboard.Client,a=false;q=function(){g.show();t.hide();p.hide()};BitlyCB.wardrobeSelfShorten=function(c){var h;try{h=
c.results[document.location.href].hash}catch(j){log("shortener error: likely no longer same URL",j)}c="http://outfits.openneo.net/"+h;g.hide();p.show();if(!a){x.glue("shorten-url-copy-button","shorten-url-copy-button-wrapper");a=true}d.text(c);x.setText(c)};g.submit(function(c){BitlyClient.shorten(document.location.href,"BitlyCB.wardrobeSelfShorten");t.show();c.preventDefault()});p.submit(function(c){c.preventDefault()})})()};
View.Preview=function(b){function o(){var e;if(f)return false;if(m&&m.setAssets){e=b.outfit.getVisibleAssets();m.setAssets(e)}else f=true}$("#preview");var m,f=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){m=document.getElementById("preview-swf");if(f){f=false;o()}};b.outfit.bind("updateItems",o);b.outfit.bind("updateItemAssets",
o);b.outfit.bind("updatePetState",o)};
View.PetStateForm=function(b){function o(k){if(k){f.children("li.selected").removeClass("selected");$(e+"[value="+k.id+"]").attr("checked","checked").parent().addClass("selected")}}var m=$("#pet-state-form"),f=m.children("ul"),e="#pet-state-form input[name=pet_state_id]";$(e).live("click",function(){b.outfit.setPetStateById(+this.value)});b.outfit.bind("petTypeLoaded",function(k){k=k.pet_state_ids;var l,r,q,d;f.children().remove();if(k.length==1)m.hide();else{m.show();for(l=0;l<k.length;l++){r="pet-state-radio-"+
l;q=$("<li/>");d=$("<input/>",{id:r,name:"pet_state_id",type:"radio",value:k[l]});r=$("<label/>",{"for":r,text:l+1});l==0&&d.attr("checked","checked");d.appendTo(q);r.appendTo(q);q.appendTo(f)}o(b.outfit.pet_state)}});b.outfit.bind("updatePetState",o)};
View.PetTypeForm=function(b){function o(e){f&&e&&$.each(m,function(k){m[k].val(e[k+"_id"])})}var m={},f=false;$("#pet-type-form").submit(function(e){e.preventDefault();b.outfit.setPetTypeByColorAndSpecies(+m.color.val(),+m.species.val())}).children("select").each(function(){m[this.name]=$(this)});this.initialize=function(){b.pet_attributes.load()};b.pet_attributes.bind("update",function(e){$.each(e,function(k){var l=m[k];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(l)})});
f=true;o(b.outfit.pet_type)});b.outfit.bind("updatePetType",o)};
View.Search=function(b){var o=$("#preview-search-form"),m=new Partial.ItemSet(b,"#preview-search-form ul"),f=o.find("input[name=query]"),e={INNER_WINDOW:4,OUTER_WINDOW:1,GAP_TEXT:"&hellip;",PREV_TEXT:"&larr; Previous",NEXT_TEXT:"Next &rarr;",PAGE_EL:$("<a/>",{href:"#"}),CURRENT_EL:$("<span/>",{"class":"current"}),EL_ID:"#preview-search-form-pagination"};e.EL=$(e.EL_ID);e.GAP_EL=$("<span/>",{"class":"gap",html:e.GAP_TEXT});e.PREV_EL=$("<a/>",{href:"#",rel:"prev",html:e.PREV_TEXT});e.NEXT_EL=$("<a/>",
{href:"#",rel:"next",html:e.NEXT_TEXT});$(e.EL_ID+" a").live("click",function(k){k.preventDefault();k=$(this).data("page");b.search.setItemsByQuery(f.val(),k)});o.submit(function(k){k.preventDefault();b.search.setItemsByQuery(f.val(),1)});b.search.bind("updateItems",function(k){m.setItems(k)});b.search.bind("updateRequest",function(k){f.val(k.query||"")});b.search.bind("updatePagination",function(k,l){var r=k-e.INNER_WINDOW,q=k+e.INNER_WINDOW,d,g,p=1;if(q>l){r-=q-l;q=l}if(r<1){q+=1-r;r=1;if(q>l)q=
l}r=[2+e.OUTER_WINDOW,r];q=[q+1,l-e.OUTER_WINDOW];d=r[1]-r[0]>1;g=q[1]-q[0]>1;e.EL.children().remove();for(k>1&&e.PREV_EL.clone().data("page",k-1).appendTo(e.EL);p<=l;)if(d&&p>=r[0]&&p<r[1]){e.GAP_EL.clone().appendTo(e.EL);p=r[1]}else if(g&&p>=q[0]&&p<q[1]){e.GAP_EL.clone().appendTo(e.EL);p=q[1]}else{p==k?e.CURRENT_EL.clone().text(p).appendTo(e.EL):e.PAGE_EL.clone().text(p).data("page",p).appendTo(e.EL);p++}k<l&&e.NEXT_EL.clone().data("page",k+1).appendTo(e.EL)});b.search.bind("error",function(k){log(k)})};
View.Title=function(b){b.base_pet.bind("updateName",function(o){$("#title").text("Planning "+o+"'s outfit")})};$.ajaxSetup({error:function(){$.jGrowl("There was an error loading that last resource. Oops. Please try again!")}});main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
var View={},Partial={},main_wardrobe;window.log=window.SWFLog=$.noop;function arraysMatch(b,j){var k;if(!$.isArray(b)||!$.isArray(j))return b==j;k=[];if(!b[0]||!j[0])return false;if(b.length!=j.length)return false;for(var d=0;d<b.length;d++){key=typeof b[d]+"~"+b[d];if(k[key])k[key]++;else k[key]=1}for(d=0;d<j.length;d++){key=typeof j[d]+"~"+j[d];if(k[key])if(k[key]==0)return false;else k[key]--;else return false}return true}Array.prototype.map=function(b){return $.map(this,function(j){return j[b]})};
function DeepObject(){}DeepObject.prototype.deepGet=function(){var b=this;$.each(arguments,function(){b=b[this];if(typeof b=="undefined")return false});return b};DeepObject.prototype.deepSet=function(){var b=$.proxy(Array.prototype.pop,"apply"),j=b(arguments);b=b(arguments);var k=this;$.each(arguments,function(){if(typeof k[this]=="undefined")k[this]={};k=k[this]});k[b]=j};
function Wardrobe(){function b(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function j(a){for(var c in a)if(a.hasOwnProperty(c))this[c]=a[c]}function k(a){j.apply(this,[a]);b.apply(this)}function d(a){j.apply(this,[a])}function m(a){var c=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(g){return this.assets_by_body_id[g.body_id]||[]};this.hasAssetsFitting=function(g){return typeof c.assets_by_body_id[g.body_id]!=
"undefined"};this.update=function(g){for(var e in g)if(g.hasOwnProperty(e)&&e!="id")c[e]=g[e];b.apply(this);this.loaded=true};m.cache[a]=this}function p(){}function n(a){var c=this,g=false;this.id=a;this.assets=[];this.loadAssets=function(e){g?e(c):$.getJSON("/biology_assets.json?parent_id="+c.id,function(r){c.assets=$.map(r,function(s){return new k(s)});g=true;e(c)})};n.cache[a]=this}function o(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(c,g){a.loaded?c(a):$.getJSON("/pet_types.json",
{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(e){if(e){for(var r in e)if(e.hasOwnProperty(r))a[r]=e[r];for(e=0;e<a.pet_state_ids.length;e++)a.pet_states.push(n.find(a.pet_state_ids[e]));o.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=true;c(a)}else g(a)})};this.loadItemAssets=function(c,g){for(var e=[],r=0;r<c.length;r++){var s=c[r];m.find(s).hasAssetsFitting(a)||e.push(s)}e.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:e},
function(l){$.each(l,function(){var u=m.find(this.parent_id),i=new d(this);if(typeof u.assets_by_body_id[a.body_id]=="undefined")u.assets_by_body_id[a.body_id]=[];u.assets_by_body_id[a.body_id].push(i)});g()}):g()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(c){for(var g=0;g<this.pet_states.length;g++)if(this.pet_states[g]==c)return true;return false}}function q(){var a=this;this.events={};this.bind=function(c,
g){if(typeof this.events[c]=="undefined")this.events[c]=[];this.events[c].push(g)};this.events.trigger=function(c){var g;if(a.events[c]){g=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[c],function(){this.apply(a,g)})}}}var f=this;m.find=function(a){var c=m.cache[a];c||(c=new m(a));return c};var h=[];m.loadByIds=function(a,c){var g=[],e=[],r=$.map(a,function(s){var l=m.find(s);if(!l.load_started){g.push(s);l.load_started=true}l.loaded||e.push(s);return l});if(g.length)$.getJSON("/objects.json",
{ids:g},function(s){var l,u,i,v=[];$.each(s,function(){v.push(+this.id);m.find(this.id).update(this)});for(var z=0;z<h.length;z++){l=h[z];s=l[0];u=l[1];l=l[2];i=true;for(var w=0;w<u.length;w++)if($.inArray(u[w],v)==-1){i=false;break}i&&l(s)}c(r)});else e.length?h.push([r,e,c]):c(r);return r};var t="items.impress.openneo.net/index.js?callback=?";if(document.location.hostname.substr(0,5)=="beta.")t="beta."+t;t="http://"+t;m.loadByQuery=function(a,c,g){$.getJSON(t,{q:a,per_page:21},function(e){var r=
[],s,l;if(e.items){for(var u=0;u<e.items.length;u++){l=e.items[u];s=m.find(l.id);s.update(l);r.push(s)}c(r,e.total_pages)}else e.error&&g(e.error)})};m.cache={};p.loadAll=function(a){$.getJSON("/pet_attributes.json",function(c){a(c)})};n.find=function(a){var c=n.cache[a];c||(c=new n(a));return c};n.cache={};o.cache_by_color_and_species=new DeepObject;o.findOrCreateByColorAndSpecies=function(a,c){var g=o.cache_by_color_and_species.deepGet(a,c);if(!g){g=new o;g.color_id=a;g.species_id=c}return g};q.Outfit=
function(){function a(){var i=[],v=l.items.concat(l.pet_state.assets);$.each(v,function(){i=i.concat(this.restricted_zones)});return i}function c(i){l.events.trigger("updateItems",i)}function g(i){l.events.trigger("updatePetState",i)}function e(i){if(!l.pet_state||!i.ownsPetState(l.pet_state))l.setPetStateById();l.events.trigger("petTypeLoaded",i);s()}function r(i){l.events.trigger("petTypeNotFound",i)}function s(i){l.pet_type&&l.pet_type.loaded&&u.length&&l.pet_type.loadItemAssets(u,function(){var v,
z,w,D,A,E=[],F=[];if(i){v=i.getAssetsFitting(l.pet_type).map("zone_id");z=v.length;for(var B=0;B<l.items.length;B++){w=l.items[B];D=w.getAssetsFitting(l.pet_type).map("zone_id");A=true;if(w!=i)for(var C=0;C<z;C++)if($.inArray(v[C],D)!=-1){A=false;break}if(A){E.push(w);F.push(w.id)}}l.items=E;u=F;l.events.trigger("updateItems",l.items)}l.events.trigger("updateItemAssets")})}var l=this,u=[];this.items=[];this.addItem=function(i){if($.inArray(i,l.items)==-1){this.items.push(i);u.push(i.id);s(i);l.events.trigger("updateItems",
this.items)}};this.getVisibleAssets=function(){for(var i=this.pet_state.assets,v=a(),z=[],w=0;w<l.items.length;w++)i=i.concat(l.items[w].getAssetsFitting(l.pet_type));$.each(i,function(){$.inArray(this.zone_id,v)==-1&&z.push(this)});return z};this.removeItem=function(i){var v=$.inArray(i,this.items);if(v!=-1){this.items.splice(v,1);i=$.inArray(i.id,u);u.splice(i,1);l.events.trigger("updateItems",this.items)}};this.setPetStateById=function(i){if(!i&&this.pet_type)i=this.pet_type.pet_state_ids[0];if(i){this.pet_state=
n.find(i);this.pet_state.loadAssets(g)}};this.setPetTypeByColorAndSpecies=function(i,v){this.pet_type=o.findOrCreateByColorAndSpecies(i,v);l.events.trigger("updatePetType",this.pet_type);this.pet_type.load(e,r)};this.setItemsByIds=function(i){if(i)u=i;if(i&&i.length)this.items=m.loadByIds(i,c);else{this.items=[];c(this.items)}s()}};q.Closet=function(){function a(e){c.events.trigger("updateItems",e)}var c=this,g=[];this.items=[];this.addItem=function(e){if($.inArray(e,c.items)==-1){this.items.push(e);
g.push(e.id);c.events.trigger("updateItems",this.items)}};this.removeItem=function(e){var r=$.inArray(e,this.items);if(r!=-1){this.items.splice(r,1);e=$.inArray(e.id,g);g.splice(e,1);c.events.trigger("updateItems",this.items)}};this.setItemsByIds=function(e){if(e&&e.length){g=e;this.items=m.loadByIds(e,a)}else{g=e;this.items=[];a(this.items)}}};q.BasePet=function(){var a=this;this.setName=function(c){a.name=c;a.events.trigger("updateName",c)}};q.PetAttributes=function(){function a(g){c.events.trigger("update",
g)}var c=this;this.load=function(){p.loadAll(a)}};q.Search=function(){function a(e,r){g.events.trigger("updateItems",e);g.events.trigger("updateTotalPages",r)}function c(e){g.events.trigger("error",e)}var g=this;this.setItemsByQuery=function(e){m.loadByQuery(e,a,c)}};var y;for(var x in q)if(q.hasOwnProperty(x)){y=x.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();f[y]=new q[x];q.apply(f[y])}this.initialize=function(){var a;for(var c in f.views)if(f.views.hasOwnProperty(c)){a=
f.views[c];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){f.views={};$.each(a,function(c){f.views[c]=new this(f)})}}
Partial.ItemSet=function(b,j){function k(o){return function(q){for(var f,h=0;h<m.length;h++){f=m[h];in_set=$.inArray(f,q)!=-1;$("li.object-"+f.id).toggleClass(o,in_set).data("item",f).data(o,in_set).children("ul").children("li.control-set-for-"+o).remove().end().append(Partial.ItemSet.CONTROL_SETS[o][in_set].clone())}}}var d=$(j),m=[],p,n;Partial.ItemSet.setWardrobe(b);p=k("closeted");n=k("worn");this.setItems=function(o){var q,f;m=o;d.children().remove();for(var h=0;h<m.length;h++){o=m[h];q=$("<li/>",
{"class":"object object-"+o.id});img=$("<img/>",{src:o.thumbnail_url,alt:o.description,title:o.description});f=$("<ul/>");q.append(img).append(f).append(o.name).appendTo(d)}p(b.closet.items);n(b.outfit.items)};b.outfit.bind("updateItems",n);b.closet.bind("updateItems",p)};Partial.ItemSet.CONTROL_SETS={};
Partial.ItemSet.setWardrobe=function(b){for(var j,k,d,m,p,n={},o=0;o<2;o++){j=o==0?"worn":"closeted";k=o==0?["Unwear","Wear"]:["Uncloset","Closet"];Partial.ItemSet.CONTROL_SETS[j]={};for(var q=0;q<2;q++){d=q==0;p="control-set control-set-for-"+j;m="control-set-"+(d?"":"not-")+j;p+=" "+m;Partial.ItemSet.CONTROL_SETS[j][d]=$("<a/>",{href:"#",text:k[d?0:1]}).wrap("<li/>").parent().attr("class",p);(function(f,h){$("li."+m+" a").live("click",function(t){var y=$(this).closest(".object").data("item");n[f][!h](y);
t.preventDefault()})})(j,d)}}n.closeted={};n.closeted[true]=$.proxy(b.closet,"addItem");n.closeted[false]=function(f){b.outfit.removeItem(f);b.closet.removeItem(f)};n.worn={};n.worn[true]=function(f){b.closet.addItem(f);b.outfit.addItem(f)};n.worn[false]=$.proxy(b.outfit,"removeItem");Partial.ItemSet.setWardrobe=$.noop};
if(document.location.search.substr(0,6)=="?debug")View.Console=function(b){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var j=["updateItems","updateItemAssets","updatePetType","updatePetState"],k=0;k<j.length;k++)(function(d){b.outfit.bind(d,function(m){log(d,m)})})(j[k]);b.outfit.bind("petTypeNotFound",function(d){log(d.toString()+" not found")})};
View.Closet=function(b){var j=new Partial.ItemSet(b,"#preview-closet ul");b.closet.bind("updateItems",$.proxy(j,"setItems"))};
View.Hash=function(b){function j(){var f=(document.location.hash||document.location.search).substr(1);if(f!=m){var h={},t=f.split("&");p=true;for(var y=0;y<t.length;y++){var x=t[y].split("="),a=decodeURIComponent(x[0]);if(x=decodeURIComponent(x[1]))if(o[a]==n.INTEGER)h[a]=+x;else if(o[a]==n.STRING)h[a]=x;else if(a.substr(a.length-2)=="[]"){a=a.substr(0,a.length-2);if(o[a]==n.INTEGER_ARRAY){if(typeof h[a]=="undefined")h[a]=[];h[a].push(+x)}}}if(h.color!==d.color||h.species!==d.species)b.outfit.setPetTypeByColorAndSpecies(h.color,
h.species);if(h.closet)arraysMatch(h.closet,d.closet)||b.closet.setItemsByIds(h.closet.slice(0));else arraysMatch(h.objects,d.closet)||b.closet.setItemsByIds(h.objects.slice(0));arraysMatch(h.objects,d.objects)||b.outfit.setItemsByIds(h.objects.slice(0));h.name!=d.name&&h.name&&b.base_pet.setName(h.name);h.state!=d.state&&b.outfit.setPetStateById(h.state);d=h;p=false;q();m=f}}function k(f){var h;if(!p){for(var t in f)if(f.hasOwnProperty(t)){h=f[t];if(h===undefined)delete d[t];else d[t]=f[t]}m=f=$.param(d).replace(/%5B%5D/g,
"[]");document.location.hash="#"+f;q()}}var d={},m,p=false,n={INTEGER:1,STRING:2,INTEGER_ARRAY:3},o={closet:n.INTEGER_ARRAY,color:n.INTEGER,name:n.STRING,objects:n.INTEGER_ARRAY,species:n.INTEGER,state:n.INTEGER},q;this.initialize=function(){j();setInterval(j,100)};b.outfit.bind("updateItems",function(f){f=f.map("id");var h={};if(!arraysMatch(f,d.objects))h.objects=f;h.closet=arraysMatch(f,d.closet)||arraysMatch(f,d.objects)?undefined:b.closet.items.map("id");if(h.objects||h.closet)k(h)});b.outfit.bind("updatePetType",
function(f){if(f.color_id!=d.color||f.species_id!=d.species)k({color:f.color_id,species:f.species_id,state:undefined})});b.outfit.bind("petTypeNotFound",function(){window.history.back()});b.outfit.bind("updatePetState",function(f){var h=b.outfit.pet_type;if(f.id!=d.state&&h&&(d.state||f.id!=h.pet_state_ids[0]))k({state:f.id})});(function(){ZeroClipboard.setMoviePath("/assets/swf/ZeroClipboard.swf");var f=$("#shorten-url-response"),h=$("#shorten-url-form"),t=$("#shorten-url-response-form"),y=$("#shorten-url-loading"),
x=new ZeroClipboard.Client,a=false;q=function(){h.show();y.hide();t.hide()};BitlyCB.wardrobeSelfShorten=function(c){var g;try{g=c.results[document.location.href].hash}catch(e){log("shortener error: likely no longer same URL",e)}c="http://outfits.openneo.net/"+g;h.hide();t.show();if(!a){x.glue("shorten-url-copy-button","shorten-url-copy-button-wrapper");a=true}f.text(c);x.setText(c)};h.submit(function(c){BitlyClient.shorten(document.location.href,"BitlyCB.wardrobeSelfShorten");y.show();c.preventDefault()});
t.submit(function(c){c.preventDefault()})})()};
View.Preview=function(b){function j(){var m;if(d)return false;if(k&&k.setAssets){m=b.outfit.getVisibleAssets();k.setAssets(m)}else d=true}$("#preview");var k,d=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){k=document.getElementById("preview-swf");if(d){d=false;j()}};b.outfit.bind("updateItems",j);b.outfit.bind("updateItemAssets",
j);b.outfit.bind("updatePetState",j)};
View.PetStateForm=function(b){function j(p){if(p){d.children("li.selected").removeClass("selected");$(m+"[value="+p.id+"]").attr("checked","checked").parent().addClass("selected")}}var k=$("#pet-state-form"),d=k.children("ul"),m="#pet-state-form input[name=pet_state_id]";$(m).live("click",function(){b.outfit.setPetStateById(+this.value)});b.outfit.bind("petTypeLoaded",function(p){p=p.pet_state_ids;var n,o,q,f;d.children().remove();if(p.length==1)k.hide();else{k.show();for(n=0;n<p.length;n++){o="pet-state-radio-"+
n;q=$("<li/>");f=$("<input/>",{id:o,name:"pet_state_id",type:"radio",value:p[n]});o=$("<label/>",{"for":o,text:n+1});n==0&&f.attr("checked","checked");f.appendTo(q);o.appendTo(q);q.appendTo(d)}j(b.outfit.pet_state)}});b.outfit.bind("updatePetState",j)};
View.PetTypeForm=function(b){function j(m){d&&m&&$.each(k,function(p){k[p].val(m[p+"_id"])})}var k={},d=false;$("#pet-type-form").submit(function(m){m.preventDefault();b.outfit.setPetTypeByColorAndSpecies(+k.color.val(),+k.species.val())}).children("select").each(function(){k[this.name]=$(this)});this.initialize=function(){b.pet_attributes.load()};b.pet_attributes.bind("update",function(m){$.each(m,function(p){var n=k[p];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(n)})});
d=true;j(b.outfit.pet_type)});b.outfit.bind("updatePetType",j)};View.Title=function(b){b.base_pet.bind("updateName",function(j){$("#title").text("Planning "+j+"'s outfit")})};
View.Search=function(b){var j=$("#preview-search-form"),k=new Partial.ItemSet(b,"#preview-search-form ul");j.submit(function(d){d.preventDefault();b.search.setItemsByQuery(j.find("input[name=query]").val())});b.search.bind("updateItems",function(d){k.setItems(d)});b.search.bind("updateTotalPages",function(){});b.search.bind("error",function(d){log(d)})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
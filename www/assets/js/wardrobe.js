var View={},Partial={},main_wardrobe,ITEMS_SERVER="items.impress.openneo.net";if(document.location.hostname.substr(0,5)=="beta.")ITEMS_SERVER="beta."+ITEMS_SERVER;ITEMS_SERVER="http://"+ITEMS_SERVER;window.log=window.SWFLog=$.noop;
function arraysMatch(c,n){var l;if(!$.isArray(c)||!$.isArray(n))return c==n;l=[];if(!c[0]||!n[0])return false;if(c.length!=n.length)return false;for(var g=0;g<c.length;g++){key=typeof c[g]+"~"+c[g];if(l[key])l[key]++;else l[key]=1}for(g=0;g<n.length;g++){key=typeof n[g]+"~"+n[g];if(l[key])if(l[key]==0)return false;else l[key]--;else return false}return true}Array.prototype.map=function(c){return $.map(this,function(n){return n[c]})};function DeepObject(){}
DeepObject.prototype.deepGet=function(){var c=this;$.each(arguments,function(){c=c[this];if(typeof c=="undefined")return false});return c};DeepObject.prototype.deepSet=function(){var c=$.proxy(Array.prototype.pop,"apply"),n=c(arguments);c=c(arguments);var l=this;$.each(arguments,function(){if(typeof l[this]=="undefined")l[this]={};l=l[this]});l[c]=n};
function Wardrobe(){function c(){var b;for(this.restricted_zones=[];(b=this.zones_restrict.indexOf(1,b)+1)!=0;)this.restricted_zones.push(b)}function n(b){for(var a in b)if(b.hasOwnProperty(a))this[a]=b[a]}function l(b){n.apply(this,[b]);c.apply(this)}function g(b){n.apply(this,[b])}function p(b){var a=this;this.id=b;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(e){return this.assets_by_body_id[e.body_id]||[]};this.hasAssetsFitting=function(e){return typeof a.assets_by_body_id[e.body_id]!=
"undefined"&&a.assets_by_body_id[e.body_id].length>0};this.couldNotLoadAssetsFitting=function(e){return typeof a.assets_by_body_id[e.body_id]!="undefined"&&a.assets_by_body_id[e.body_id].length==0};this.update=function(e){for(var h in e)if(e.hasOwnProperty(h)&&h!="id")a[h]=e[h];c.apply(this);this.loaded=true};p.cache[b]=this}function q(b){this.name=b}function r(){}function v(b){var a=this,e=false;this.id=b;this.assets=[];this.loadAssets=function(h){e?h(a):$.getJSON("/biology_assets.json?parent_id="+
a.id,function(o){a.assets=$.map(o,function(t){return new l(t)});e=true;h(a)})};v.cache[b]=this}function w(){var b=this;this.loaded=false;this.pet_states=[];this.load=function(a,e){b.loaded?a(b):$.getJSON("/pet_types.json",{"for":"wardrobe",color_id:b.color_id,species_id:b.species_id},function(h){if(h){for(var o in h)if(h.hasOwnProperty(o))b[o]=h[o];for(h=0;h<b.pet_state_ids.length;h++)b.pet_states.push(v.find(b.pet_state_ids[h]));w.cache_by_color_and_species.deepSet(b.color_id,b.species_id,b);b.loaded=
true;a(b)}else e(b)})};this.loadItemAssets=function(a,e){for(var h=[],o=0;o<a.length;o++){var t=a[o];p.find(t).hasAssetsFitting(b)||h.push(t)}h.length?$.getJSON("/object_assets.json",{body_id:b.body_id,parent_ids:h},function(k){$.each(k,function(){var y=p.find(this.parent_id),A=new g(this);if(typeof y.assets_by_body_id[b.body_id]=="undefined")y.assets_by_body_id[b.body_id]=[];y.assets_by_body_id[b.body_id].push(A)});for(var x=0,j=a.length;x<j;x++){k=p.find(a[x]);k.hasAssetsFitting(b)||(k.assets_by_body_id[b.body_id]=
[])}e()}):e()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(a){for(var e=0;e<this.pet_states.length;e++)if(this.pet_states[e]==a)return true;return false}}function d(){var b=this;this.events={};this.bind=function(a,e){if(typeof this.events[a]=="undefined")this.events[a]=[];this.events[a].push(e)};this.events.trigger=function(a){var e;if(b.events[a]){e=Array.prototype.slice.apply(arguments,[1]);$.each(b.events[a],
function(){this.apply(b,e)})}}}var f=this;p.find=function(b){var a=p.cache[b];a||(a=new p(b));return a};var u=[];p.loadByIds=function(b,a){var e=[],h=[],o=$.map(b,function(t){var k=p.find(t);if(!k.load_started){e.push(t);k.load_started=true}k.loaded||h.push(t);return k});if(e.length)$.getJSON("/objects.json",{ids:e},function(t){var k,x,j,y=[];$.each(t,function(){y.push(+this.id);p.find(this.id).update(this)});for(var A=0;A<u.length;A++){k=u[A];t=k[0];x=k[1];k=k[2];j=true;for(var z=0;z<x.length;z++)if($.inArray(x[z],
y)==-1){j=false;break}j&&k(t)}a(o)});else h.length?u.push([o,h,a]):a(o);return o};var m=ITEMS_SERVER+"/index.js?callback=?";p.loadByQuery=function(b,a,e,h){$.getJSON(m,{q:b,per_page:21,page:a},function(o){var t=[],k,x;if(o.items){for(var j=0;j<o.items.length;j++){x=o.items[j];k=p.find(x.id);k.update(x);t.push(k)}e(t,o.total_pages)}else o.error&&h(o.error)})};p.cache={};q.loadAll=function(b){$.getJSON(ITEMS_SERVER+"/item_zone_sets.js?callback=?",function(a){for(var e=0,h=a.length;e<h;e++)q.all.push(new q(a[e]));
b(q.all)})};q.all=[];r.loadAll=function(b){$.getJSON("/pet_attributes.json",function(a){b(a)})};v.find=function(b){var a=v.cache[b];a||(a=new v(b));return a};v.cache={};w.cache_by_color_and_species=new DeepObject;w.findOrCreateByColorAndSpecies=function(b,a){var e=w.cache_by_color_and_species.deepGet(b,a);if(!e){e=new w;e.color_id=b;e.species_id=a}return e};d.all={};d.all.Outfit=function(){function b(){var j=[],y=k.items.concat(k.pet_state.assets);$.each(y,function(){j=j.concat(this.restricted_zones)});
return j}function a(j){k.events.trigger("updateItems",j)}function e(j){k.events.trigger("updatePetState",j)}function h(j){if(!k.pet_state||!j.ownsPetState(k.pet_state))k.setPetStateById();k.events.trigger("petTypeLoaded",j);t()}function o(j){k.events.trigger("petTypeNotFound",j)}function t(j){k.pet_type&&k.pet_type.loaded&&x.length&&k.pet_type.loadItemAssets(x,function(){var y,A,z,E,B,F=[],G=[];if(j){y=j.getAssetsFitting(k.pet_type).map("zone_id");A=y.length;for(var C=0;C<k.items.length;C++){z=k.items[C];
E=z.getAssetsFitting(k.pet_type).map("zone_id");B=true;if(z!=j)for(var D=0;D<A;D++)if($.inArray(y[D],E)!=-1){B=false;break}if(B){F.push(z);G.push(z.id)}}k.items=F;x=G;k.events.trigger("updateItems",k.items)}k.events.trigger("updateItemAssets")})}var k=this,x=[];this.items=[];this.addItem=function(j){if($.inArray(j,k.items)==-1){this.items.push(j);x.push(j.id);t(j);k.events.trigger("updateItems",this.items)}};this.getVisibleAssets=function(){for(var j=this.pet_state.assets,y=b(),A=[],z=0;z<k.items.length;z++)j=
j.concat(k.items[z].getAssetsFitting(k.pet_type));$.each(j,function(){$.inArray(this.zone_id,y)==-1&&A.push(this)});return A};this.removeItem=function(j){var y=$.inArray(j,this.items);if(y!=-1){this.items.splice(y,1);j=$.inArray(j.id,x);x.splice(j,1);k.events.trigger("updateItems",this.items)}};this.setPetStateById=function(j){if(!j&&this.pet_type)j=this.pet_type.pet_state_ids[0];if(j){this.pet_state=v.find(j);this.pet_state.loadAssets(e)}};this.setPetTypeByColorAndSpecies=function(j,y){this.pet_type=
w.findOrCreateByColorAndSpecies(j,y);k.events.trigger("updatePetType",this.pet_type);this.pet_type.load(h,o)};this.setItemsByIds=function(j){if(j)x=j;if(j&&j.length)this.items=p.loadByIds(j,a);else{this.items=[];a(this.items)}t()}};d.all.Closet=function(){function b(h){a.events.trigger("updateItems",h)}var a=this,e=[];this.items=[];this.addItem=function(h){if($.inArray(h,a.items)==-1){this.items.push(h);e.push(h.id);a.events.trigger("updateItems",this.items)}};this.removeItem=function(h){var o=$.inArray(h,
this.items);if(o!=-1){this.items.splice(o,1);h=$.inArray(h.id,e);e.splice(h,1);a.events.trigger("updateItems",this.items)}};this.setItemsByIds=function(h){if(h&&h.length){e=h;this.items=p.loadByIds(h,b)}else{e=h;this.items=[];b(this.items)}}};d.all.BasePet=function(){var b=this;this.setName=function(a){b.name=a;b.events.trigger("updateName",a)}};d.all.PetAttributes=function(){function b(e){a.events.trigger("update",e)}var a=this;this.load=function(){r.loadAll(b)}};d.all.ItemZoneSets=function(){function b(e){a.events.trigger("update",
e)}var a=this;this.load=function(){q.loadAll(b)}};d.all.Search=function(){function b(e){a.events.trigger("error",e)}var a=this;this.request={};this.setItemsByQuery=function(e,h){a.request={query:e,page:h};a.events.trigger("updateRequest",a.request);if(e&&h){p.loadByQuery(e,h,function(o,t){a.events.trigger("updateItems",o);a.events.trigger("updatePagination",h,t)},b);a.events.trigger("startRequest")}else{a.events.trigger("updateItems",[]);a.events.trigger("updatePagination",0,0)}}};var i;for(var s in d.all)if(d.all.hasOwnProperty(s)){i=
s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();f[i]=new d.all[s];d.apply(f[i])}this.initialize=function(){var b;for(var a in f.views)if(f.views.hasOwnProperty(a)){b=f.views[a];typeof b.initialize=="function"&&b.initialize()}};this.registerViews=function(b){f.views={};$.each(b,function(a){f.views[a]=new this(f)})}}
Partial.ItemSet=function(c,n){function l(d){return function(f){for(var u,m=0;m<q.length;m++){u=q[m];in_set=$.inArray(u,f)!=-1;$("li.object-"+u.id).toggleClass(d,in_set).data("item",u).data(d,in_set).children("ul").children("li.control-set-for-"+d).remove().end()[d=="worn"?"prepend":"append"](Partial.ItemSet.CONTROL_SETS[d][in_set].clone())}}}function g(d){for(var f,u,m=0,i=d.length;m<i;m++){f=d[m];u=f.couldNotLoadAssetsFitting(c.outfit.pet_type);$("li.object-"+f.id).toggleClass("no-assets",u)}}var p=
$(n),q=[],r,v,w;Partial.ItemSet.setWardrobe(c);r=l("closeted");w=l("worn");v=function(d){w(d);g(d)};this.setItems=function(d){var f,u;q=d;p.children().remove();for(var m=0;m<q.length;m++){d=q[m];f=$("<li/>",{"class":"object object-"+d.id});img=$("<img/>",{src:d.thumbnail_url,alt:d.description,title:d.description});u=$("<ul/>");f.append(img).append(u).append(d.name).appendTo(p)}r(c.closet.items);v(c.outfit.items)};c.outfit.bind("updateItemAssets",function(){g(c.outfit.items)});c.outfit.bind("updateItems",
v);c.closet.bind("updateItems",r)};Partial.ItemSet.CONTROL_SETS={};
Partial.ItemSet.setWardrobe=function(c){for(var n,l,g,p,q,r={},v=0;v<2;v++){n=v==0?"worn":"closeted";l=v==0?["Unwear","Wear"]:["Uncloset","Closet"];Partial.ItemSet.CONTROL_SETS[n]={};for(var w=0;w<2;w++){g=w==0;q="control-set control-set-for-"+n;p="control-set-"+(g?"":"not-")+n;q+=" "+p;Partial.ItemSet.CONTROL_SETS[n][g]=$("<a/>",{href:"#",text:l[g?0:1]}).wrap("<li/>").parent().attr("class",q);(function(d,f){$("li."+p+" a").live("click",function(u){var m=$(this).closest(".object").data("item");r[d][!f](m);
u.preventDefault()})})(n,g)}}r.closeted={};r.closeted[true]=$.proxy(c.closet,"addItem");r.closeted[false]=function(d){c.outfit.removeItem(d);c.closet.removeItem(d)};r.worn={};r.worn[true]=function(d){c.closet.addItem(d);c.outfit.addItem(d)};r.worn[false]=$.proxy(c.outfit,"removeItem");Partial.ItemSet.setWardrobe=$.noop};
if(document.location.search.substr(0,6)=="?debug")View.Console=function(c){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var n=["updateItems","updateItemAssets","updatePetType","updatePetState"],l=0;l<n.length;l++)(function(g){c.outfit.bind(g,function(p){log(g,p)})})(n[l]);c.outfit.bind("petTypeNotFound",function(g){log(g.toString()+" not found")})};
View.Closet=function(c){var n=new Partial.ItemSet(c,"#preview-closet ul");c.closet.bind("updateItems",$.proxy(n,"setItems"))};
View.Hash=function(c){function n(){var d=(document.location.hash||document.location.search).substr(1);if(d!=p){var f={},u=d.split("&");q=true;for(var m=0;m<u.length;m++){var i=u[m].split("="),s=decodeURIComponent(i[0]);if(i=decodeURIComponent(i[1]))if(v[s]==r.INTEGER)f[s]=+i;else if(v[s]==r.STRING)f[s]=decodeURIComponent(i).replace(/\+/g," ");else if(s.substr(s.length-2)=="[]"){s=s.substr(0,s.length-2);if(v[s]==r.INTEGER_ARRAY){if(typeof f[s]=="undefined")f[s]=[];f[s].push(+i)}}}if(f.color!==g.color||
f.species!==g.species)c.outfit.setPetTypeByColorAndSpecies(f.color,f.species);if(f.closet)arraysMatch(f.closet,g.closet)||c.closet.setItemsByIds(f.closet.slice(0));else arraysMatch(f.objects,g.closet)||c.closet.setItemsByIds(f.objects.slice(0));arraysMatch(f.objects,g.objects)||c.outfit.setItemsByIds(f.objects.slice(0));f.name!=g.name&&f.name&&c.base_pet.setName(f.name);f.state!=g.state&&c.outfit.setPetStateById(f.state);if(f.search!=g.search||f.search_page!=g.search_page)c.search.setItemsByQuery(f.search,
f.search_page);g=f;q=false;p=d}}function l(d){var f;if(!q){for(var u in d)if(d.hasOwnProperty(u)){f=d[u];if(f===undefined)delete g[u];else g[u]=d[u]}p=d=$.param(g).replace(/%5B%5D/g,"[]");document.location.hash="#"+d;w()}}var g={},p,q=false,r={INTEGER:1,STRING:2,INTEGER_ARRAY:3},v={closet:r.INTEGER_ARRAY,color:r.INTEGER,name:r.STRING,objects:r.INTEGER_ARRAY,search:r.STRING,search_page:r.INTEGER,species:r.INTEGER,state:r.INTEGER},w;this.initialize=function(){n();setInterval(n,100);w()};c.outfit.bind("updateItems",
function(d){d=d.map("id");var f={};if(!arraysMatch(d,g.objects))f.objects=d;f.closet=arraysMatch(d,g.closet)||arraysMatch(d,g.objects)?undefined:c.closet.items.map("id");if(f.objects||f.closet)l(f)});c.outfit.bind("updatePetType",function(d){if(d.color_id!=g.color||d.species_id!=g.species)l({color:d.color_id,species:d.species_id,state:undefined})});c.outfit.bind("petTypeNotFound",function(){window.history.back()});c.outfit.bind("updatePetState",function(d){var f=c.outfit.pet_type;if(d.id!=g.state&&
f&&(g.state||d.id!=f.pet_state_ids[0]))l({state:d.id})});c.search.bind("updateRequest",function(d){if(d.page!=g.search_page||d.query!=g.search)l({search_page:d.page,search:d.query})});(function(){function d(t){if(typeof addthis_share!="undefined"){addthis_share.url=t;i.replaceWith(i.clone());addthis.button(m)}}function f(){if(!h&&!o){h=true;BitlyClient.shorten(e,"BitlyCB."+u)}}var u="shortenResponse",m="#share-button",i=$(m),s=i.parent(),b=$("#short-url-button"),a=$("#short-url-response"),e,h=false,
o=false;w=function(){var t=window.location;e=t.protocol+"//"+t.host+t.pathname+t.hash;d(e);a.hide();o=false};BitlyCB[u]=function(t){var k,x;for(x in t.results){k="http://outfits.openneo.net/"+t.results[x].hash;break}d(k);a.val(k).show();h=false;o=true};b.click(f);s.mouseover(f);i.focus(f);a.mouseover(function(){a.focus().select()})})()};
View.Preview=function(c){function n(){var p;if(g)return false;if(l&&l.setAssets){p=c.outfit.getVisibleAssets();l.setAssets(p)}else g=true}$("#preview");var l,g=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){l=document.getElementById("preview-swf");if(g){g=false;n()}};c.outfit.bind("updateItems",n);c.outfit.bind("updateItemAssets",
n);c.outfit.bind("updatePetState",n)};
View.PetStateForm=function(c){function n(q){if(q){g.children("li.selected").removeClass("selected");$(p+"[value="+q.id+"]").attr("checked","checked").parent().addClass("selected")}}var l=$("#pet-state-form"),g=l.children("ul"),p="#pet-state-form input[name=pet_state_id]";$(p).live("click",function(){c.outfit.setPetStateById(+this.value)});c.outfit.bind("petTypeLoaded",function(q){q=q.pet_state_ids;var r,v,w,d;g.children().remove();if(q.length==1)l.hide();else{l.show();for(r=0;r<q.length;r++){v="pet-state-radio-"+
r;w=$("<li/>");d=$("<input/>",{id:v,name:"pet_state_id",type:"radio",value:q[r]});v=$("<label/>",{"for":v,text:r+1});r==0&&d.attr("checked","checked");d.appendTo(w);v.appendTo(w);w.appendTo(g)}n(c.outfit.pet_state)}});c.outfit.bind("updatePetState",n)};
View.PetTypeForm=function(c){function n(p){g&&p&&$.each(l,function(q){l[q].val(p[q+"_id"])})}var l={},g=false;$("#pet-type-form").submit(function(p){p.preventDefault();c.outfit.setPetTypeByColorAndSpecies(+l.color.val(),+l.species.val())}).children("select").each(function(){l[this.name]=$(this)});this.initialize=function(){c.pet_attributes.load()};c.pet_attributes.bind("update",function(p){$.each(p,function(q){var r=l[q];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(r)})});
g=true;n(c.outfit.pet_type)});c.outfit.bind("updatePetType",n);c.outfit.bind("petTypeNotFound",function(){$("#pet-type-not-found").show("normal").delay(3E3).hide("fast")})};
View.Search=function(c){function n(i,s){return function(b){var a=$("<select/>",{"class":"search-helper","data-search-filter":i}),e=$("span.search-helper[data-search-filter="+i+"]");b=s(b);for(var h=0,o=b.length;h<o;h++)$("<option/>",{text:b[h].name}).appendTo(a);e.replaceWith(function(){return a.clone().fadeIn("fast")})}}function l(i){return i.species}var g=$("#preview-search-form"),p=new Partial.ItemSet(c,"#preview-search-form ul"),q=g.find("input[name=query]"),r=$("#preview-search-form-clear"),
v=$("#preview-search-form-error"),w=$("#preview-search-form-help"),d=$("#preview-search-form-loading"),f=$("#preview-search-form-no-results"),u=f.children("span"),m={INNER_WINDOW:4,OUTER_WINDOW:1,GAP_TEXT:"&hellip;",PREV_TEXT:"&larr; Previous",NEXT_TEXT:"Next &rarr;",PAGE_EL:$("<a/>",{href:"#"}),CURRENT_EL:$("<span/>",{"class":"current"}),EL_ID:"#preview-search-form-pagination"};m.EL=$(m.EL_ID);m.GAP_EL=$("<span/>",{"class":"gap",html:m.GAP_TEXT});m.PREV_EL=$("<a/>",{href:"#",rel:"prev",html:m.PREV_TEXT});
m.NEXT_EL=$("<a/>",{href:"#",rel:"next",html:m.NEXT_TEXT});$(m.EL_ID+" a").live("click",function(i){i.preventDefault();i=$(this).data("page");c.search.setItemsByQuery(q.val(),i)});this.initialize=$.proxy(c.item_zone_sets,"load");g.submit(function(i){i.preventDefault();c.search.setItemsByQuery(q.val(),1)});r.click(function(i){i.preventDefault();q.val("");g.submit()});c.search.bind("startRequest",function(){d.delay(1E3).show("slow")});c.search.bind("updateItems",function(i){d.stop(true,true).hide();
p.setItems(i);if(c.search.request.query)i.length||f.show();else w.show()});c.search.bind("updateRequest",function(i){v.hide("fast");w.hide();f.hide();q.val(i.query||"");u.text(i.query);r.toggle(!!i.query)});c.search.bind("updatePagination",function(i,s){var b=i-m.INNER_WINDOW,a=i+m.INNER_WINDOW,e,h,o=1;if(a>s){b-=a-s;a=s}if(b<1){a+=1-b;b=1;if(a>s)a=s}b=[2+m.OUTER_WINDOW,b];a=[a+1,s-m.OUTER_WINDOW];e=b[1]-b[0]>1;h=a[1]-a[0]>1;m.EL.children().remove();for(i>1&&m.PREV_EL.clone().data("page",i-1).appendTo(m.EL);o<=
s;)if(e&&o>=b[0]&&o<b[1]){m.GAP_EL.clone().appendTo(m.EL);o=b[1]}else if(h&&o>=a[0]&&o<a[1]){m.GAP_EL.clone().appendTo(m.EL);o=a[1]}else{o==i?m.CURRENT_EL.clone().text(o).appendTo(m.EL):m.PAGE_EL.clone().text(o).data("page",o).appendTo(m.EL);o++}i<s&&m.NEXT_EL.clone().data("page",i+1).appendTo(m.EL)});c.search.bind("error",function(i){d.stop(true,true).hide();v.text(i).show("normal")});w.find("dt").each(function(){var i=$(this);i.children().length||i.wrapInner($("<a/>",{href:"#"}))}).children("span:not(.search-helper)").each(function(){var i=
$(this);i.replaceWith($("<a/>",{href:"#",text:i.text()}))});w.find("dt a").live("click",function(i){var s=$(this),b=s.parent().children();i.preventDefault();i=b.length>1?b.map(function(){var a=$(this);return a[a.is("select")?"val":"text"]()}).get().join(""):s.text();q.val(i);g.submit()});$("select.search-helper").live("change",function(){var i=$(this),s=i.attr("data-search-filter");$("select.search-helper[data-search-filter="+s+"]").val(i.val())});c.item_zone_sets.bind("update",n("type",function(i){return i}));
c.pet_attributes.bind("update",n("species",l));c.pet_attributes.bind("update",n("only",l))};View.Title=function(c){c.base_pet.bind("updateName",function(n){$("#title").text("Planning "+n+"'s outfit")})};$.ajaxSetup({error:function(){$.jGrowl("There was an error loading that last resource. Oops. Please try again!")}});main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();
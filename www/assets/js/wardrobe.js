var View={},main_wardrobe;window.log=window.SWFLog=$.noop;function arraysMatch(c,l){var h;if(!$.isArray(c)||!$.isArray(l))return c==l;h=[];if(!c[0]||!l[0])return false;if(c.length!=l.length)return false;for(var e=0;e<c.length;e++){key=typeof c[e]+"~"+c[e];if(h[key])h[key]++;else h[key]=1}for(e=0;e<l.length;e++){key=typeof l[e]+"~"+l[e];if(h[key])if(h[key]==0)return false;else h[key]--;else return false}return true}Array.prototype.map=function(c){return $.map(this,function(l){return l[c]})};
function DeepObject(){}DeepObject.prototype.deepGet=function(){var c=this;$.each(arguments,function(){c=c[this];if(typeof c=="undefined")return false});return c};DeepObject.prototype.deepSet=function(){var c=$.proxy(Array.prototype.pop,"apply"),l=c(arguments);c=c(arguments);var h=this;$.each(arguments,function(){if(typeof h[this]=="undefined")h[this]={};h=h[this]});h[c]=l};
function Wardrobe(){function c(){var a;for(this.restricted_zones=[];(a=this.zones_restrict.indexOf(1,a)+1)!=0;)this.restricted_zones.push(a)}function l(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b]}function h(a){l.apply(this,[a]);c.apply(this)}function e(a){l.apply(this,[a])}function k(a){var b=this;this.id=a;this.assets_by_body_id={};this.loaded=this.load_started=false;this.getAssetsFitting=function(g){return this.assets_by_body_id[g.body_id]||[]};this.hasAssetsFitting=function(g){return typeof b.assets_by_body_id[g.body_id]!=
"undefined"};this.update=function(g){for(var j in g)if(g.hasOwnProperty(j)&&j!="id")b[j]=g[j];c.apply(this);this.loaded=true};k.cache[a]=this}function p(){}function m(a){var b=this,g=false;this.id=a;this.assets=[];this.loadAssets=function(j){g?j(b):$.getJSON("/biology_assets.json?parent_id="+b.id,function(s){b.assets=$.map(s,function(u){return new h(u)});g=true;j(b)})};m.cache[a]=this}function q(){var a=this;this.loaded=false;this.pet_states=[];this.load=function(b,g){a.loaded?b(a):$.getJSON("/pet_types.json",
{"for":"wardrobe",color_id:a.color_id,species_id:a.species_id},function(j){if(j){for(var s in j)if(j.hasOwnProperty(s))a[s]=j[s];for(j=0;j<a.pet_state_ids.length;j++)a.pet_states.push(m.find(a.pet_state_ids[j]));q.cache_by_color_and_species.deepSet(a.color_id,a.species_id,a);a.loaded=true;b(a)}else g(a)})};this.loadItemAssets=function(b,g){for(var j=[],s=0;s<b.length;s++){var u=b[s];k.find(u).hasAssetsFitting(a)||j.push(u)}j.length?$.getJSON("/object_assets.json",{body_id:a.body_id,parent_ids:j},
function(t){$.each(t,function(){var o=k.find(this.parent_id),v=new e(this);if(typeof o.assets_by_body_id[a.body_id]=="undefined")o.assets_by_body_id[a.body_id]=[];o.assets_by_body_id[a.body_id].push(v)});g()}):g()};this.toString=function(){return"PetType{color_id: "+this.color_id+", species_id: "+this.species_id+"}"};this.ownsPetState=function(b){for(var g=0;g<this.pet_states.length;g++)if(this.pet_states[g]==b)return true;return false}}function n(){var a=this;this.events={};this.bind=function(b,
g){if(typeof this.events[b]=="undefined")this.events[b]=[];this.events[b].push(g)};this.events.trigger=function(b){var g;if(a.events[b]){g=Array.prototype.slice.apply(arguments,[1]);$.each(a.events[b],function(){this.apply(a,g)})}}}var d=this;k.find=function(a){var b=k.cache[a];b||(b=new k(a));return b};var f=[];k.loadByIds=function(a,b){var g=[],j=[],s=$.map(a,function(u){var t=k.find(u);if(!t.load_started){g.push(u);t.load_started=true}t.loaded||j.push(u);return t});if(g.length)$.getJSON("/objects.json",
{ids:g},function(u){var t,o,v,i=[];$.each(u,function(){i.push(+this.id);k.find(this.id).update(this)});for(var x=0;x<f.length;x++){t=f[x];u=t[0];o=t[1];t=t[2];v=true;for(var y=0;y<o.length;y++)if($.inArray(o[y],i)==-1){v=false;break}v&&t(u)}b(s)});else j.length?f.push([s,j,b]):b(s);return s};k.cache={};p.loadAll=function(a){$.getJSON("/pet_attributes.json",function(b){a(b)})};m.find=function(a){var b=m.cache[a];b||(b=new m(a));return b};m.cache={};q.cache_by_color_and_species=new DeepObject;q.findOrCreateByColorAndSpecies=
function(a,b){var g=q.cache_by_color_and_species.deepGet(a,b);if(!g){g=new q;g.color_id=a;g.species_id=b}return g};n.Outfit=function(){function a(){var i=[],x=o.items.concat(o.pet_state.assets);$.each(x,function(){i=i.concat(this.restricted_zones)});return i}function b(i){o.events.trigger("updateItemAssets",i)}function g(i){o.events.trigger("updateItems",i)}function j(i){o.events.trigger("updatePetState",i)}function s(i){if(!o.pet_state||!i.ownsPetState(o.pet_state))o.setPetStateById();o.events.trigger("petTypeLoaded",
i);t()}function u(i){o.events.trigger("petTypeNotFound",i)}function t(){o.pet_type&&o.pet_type.loaded&&v.length&&o.pet_type.loadItemAssets(v,b)}var o=this,v=[];this.items=[];this.addItem=function(i){this.items.push(i);v.push(i.id);t();o.events.trigger("updateItems",this.items)};this.getVisibleAssets=function(){for(var i=this.pet_state.assets,x=a(),y=[],z=0;z<o.items.length;z++)i=i.concat(o.items[z].getAssetsFitting(o.pet_type));$.each(i,function(){$.inArray(this.zone_id,x)==-1&&y.push(this)});return y};
this.removeItem=function(i){i=$.inArray(i,this.items);if(i!=-1){this.items.splice(i,1);o.events.trigger("updateItems",this.items)}};this.setPetStateById=function(i){if(!i&&this.pet_type)i=this.pet_type.pet_state_ids[0];if(i){this.pet_state=m.find(i);this.pet_state.loadAssets(j)}};this.setPetTypeByColorAndSpecies=function(i,x){this.pet_type=q.findOrCreateByColorAndSpecies(i,x);o.events.trigger("updatePetType",this.pet_type);this.pet_type.load(s,u)};this.setItemsByIds=function(i){if(i)v=i;if(i&&i.length)this.items=
k.loadByIds(i,g);else{this.items=[];g(this.items)}t()}};n.Closet=function(){function a(j){b.events.trigger("updateItems",j)}var b=this,g=[];this.items=[];this.setItemsByIds=function(j){if(j&&j.length){g=j;this.items=k.loadByIds(j,a)}else{g=j;this.items=[];a(this.items)}}};n.BasePet=function(){var a=this;this.setName=function(b){a.name=b;a.events.trigger("updateName",b)}};n.PetAttributes=function(){function a(g){b.events.trigger("update",g)}var b=this;this.load=function(){p.loadAll(a)}};var r;for(var w in n)if(n.hasOwnProperty(w)){r=
w.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase();d[r]=new n[w];n.apply(d[r])}this.initialize=function(){var a;for(var b in d.views)if(d.views.hasOwnProperty(b)){a=d.views[b];typeof a.initialize=="function"&&a.initialize()}};this.registerViews=function(a){d.views={};$.each(a,function(b){d.views[b]=new this(d)})}}
if(document.location.search.substr(0,6)=="?debug")View.Console=function(c){if(typeof console!="undefined"&&typeof console.log=="function")window.log=$.proxy(console,"log");this.initialize=function(){log("Welcome to the Wardrobe!")};for(var l=["updateItems","updateItemAssets","updatePetType","updatePetState"],h=0;h<l.length;h++)(function(e){c.outfit.bind(e,function(k){log(e,k)})})(l[h]);c.outfit.bind("petTypeNotFound",function(e){log(e.toString()+" not found")})};
View.Closet=function(c){function l(q){for(var n,d,f=c.closet.items,r=0;r<f.length;r++){n=f[r];d=$.inArray(n,q)!=-1;$("li.object-"+n.id).toggleClass("worn",d).data({item:n,worn:d}).children("a.control-set").remove().end().append(e[d].clone())}}for(var h=$("#closet ul"),e={},k,p,m=0;m<2;m++){k=m==0;p="control-set-"+(k?"worn":"unworn");e[k]=$("<a/>",{"class":"control-set "+p,href:"#",text:k?"Unwear":"Wear"});(function(q){$("a."+p).live("click",function(n){var d=$(this).parent().data("item");!q?c.outfit.addItem(d):
c.outfit.removeItem(d);n.preventDefault()})})(k)}c.closet.bind("updateItems",function(q){var n,d;h.children().remove();for(var f=0;f<q.length;f++){n=q[f];d=$("<li/>",{"class":"object object-"+n.id});img=$("<img/>",{src:n.thumbnail_url,alt:n.description,title:n.description});d.append(img).append(n.name).appendTo(h)}l(c.outfit.items)});c.outfit.bind("updateItems",l)};
View.Hash=function(c){function l(){var d=(document.location.hash||document.location.search).substr(1);if(d!=k){var f={},r=d.split("&");p=true;for(var w=0;w<r.length;w++){var a=r[w].split("="),b=decodeURIComponent(a[0]);if(a=decodeURIComponent(a[1]))if(q[b]==m.INTEGER)f[b]=+a;else if(q[b]==m.STRING)f[b]=a;else if(b.substr(b.length-2)=="[]"){b=b.substr(0,b.length-2);if(q[b]==m.INTEGER_ARRAY){if(typeof f[b]=="undefined")f[b]=[];f[b].push(+a)}}}if(f.color!==e.color||f.species!==e.species)c.outfit.setPetTypeByColorAndSpecies(f.color,
f.species);if(f.closet)arraysMatch(f.closet,e.closet)||c.closet.setItemsByIds(f.closet.slice(0));else arraysMatch(f.objects,e.closet)||c.closet.setItemsByIds(f.objects.slice(0));arraysMatch(f.objects,e.objects)||c.outfit.setItemsByIds(f.objects.slice(0));f.name!=e.name&&f.name&&c.base_pet.setName(f.name);f.state!=e.state&&c.outfit.setPetStateById(f.state);e=f;p=false;n();k=d}}function h(d){var f;if(!p){for(var r in d)if(d.hasOwnProperty(r)){f=d[r];if(f===undefined)delete e[r];else e[r]=d[r]}k=d=$.param(e).replace(/%5B%5D/g,
"[]");document.location.hash="#"+d;n()}}var e={},k,p=false,m={INTEGER:1,STRING:2,INTEGER_ARRAY:3},q={closet:m.INTEGER_ARRAY,color:m.INTEGER,name:m.STRING,objects:m.INTEGER_ARRAY,species:m.INTEGER,state:m.INTEGER},n;this.initialize=function(){l();setInterval(l,100)};c.outfit.bind("updateItems",function(d){d=d.map("id");var f={};if(!arraysMatch(d,e.objects))f.objects=d;f.closet=arraysMatch(d,e.closet)||arraysMatch(d,e.objects)?undefined:c.closet.items.map("id");if(f.objects||f.closet)h(f)});c.outfit.bind("updatePetType",
function(d){if(d.color_id!=e.color||d.species_id!=e.species)h({color:d.color_id,species:d.species_id,state:undefined})});c.outfit.bind("petTypeNotFound",function(){window.history.back()});c.outfit.bind("updatePetState",function(d){var f=c.outfit.pet_type;if(d.id!=e.state&&f&&(e.state||d.id!=f.pet_state_ids[0]))h({state:d.id})});(function(){ZeroClipboard.setMoviePath("/assets/swf/ZeroClipboard.swf");var d=$("#shorten-url-response"),f=$("#shorten-url-form"),r=$("#shorten-url-response-form"),w=$("#shorten-url-loading"),
a=new ZeroClipboard.Client,b=false;n=function(){f.show();w.hide();r.hide()};BitlyCB.wardrobeSelfShorten=function(g){var j;try{j=g.results[document.location.href].shortUrl}catch(s){log("shortener error: likely no longer same URL",s)}f.hide();r.show();if(!b){a.glue("shorten-url-copy-button","shorten-url-copy-button-wrapper");b=true}d.text(j);a.setText(j)};f.submit(function(g){BitlyClient.shorten(document.location.href,"BitlyCB.wardrobeSelfShorten");w.show();g.preventDefault()});r.submit(function(g){g.preventDefault()})})()};
View.Preview=function(c){function l(){var k;if(e)return false;if(h&&h.setAssets){k=c.outfit.getVisibleAssets();h.setAssets(k)}else e=true}$("#preview");var h,e=false;swfobject.embedSWF("/assets/swf/preview.swf?v=0.11","preview-swf","100%","100%","9","/assets/js/swfobject/expressInstall.swf",{swf_assets_path:"/assets"},{wmode:"transparent"});window.previewSWFIsReady=function(){h=document.getElementById("preview-swf");if(e){e=false;l()}};c.outfit.bind("updateItems",l);c.outfit.bind("updateItemAssets",
l);c.outfit.bind("updatePetState",l)};
View.PetStateForm=function(c){function l(p){if(p){e.children("li.selected").removeClass("selected");$(k+"[value="+p.id+"]").attr("checked","checked").parent().addClass("selected")}}var h=$("#pet-state-form"),e=h.children("ul"),k="#pet-state-form input[name=pet_state_id]";$(k).live("click",function(){c.outfit.setPetStateById(+this.value)});c.outfit.bind("petTypeLoaded",function(p){p=p.pet_state_ids;var m,q,n,d;e.children().remove();if(p.length==1)h.hide();else{h.show();for(m=0;m<p.length;m++){q="pet-state-radio-"+
m;n=$("<li/>");d=$("<input/>",{id:q,name:"pet_state_id",type:"radio",value:p[m]});q=$("<label/>",{"for":q,text:m+1});m==0&&d.attr("checked","checked");d.appendTo(n);q.appendTo(n);n.appendTo(e)}l(c.outfit.pet_state)}});c.outfit.bind("updatePetState",l)};
View.PetTypeForm=function(c){function l(k){e&&k&&$.each(h,function(p){h[p].val(k[p+"_id"])})}var h={},e=false;$("#pet-type-form").submit(function(k){k.preventDefault();c.outfit.setPetTypeByColorAndSpecies(+h.color.val(),+h.species.val())}).children("select").each(function(){h[this.name]=$(this)});this.initialize=function(){c.pet_attributes.load()};c.pet_attributes.bind("update",function(k){$.each(k,function(p){var m=h[p];$.each(this,function(){$("<option/>",{text:this.name,value:this.id}).appendTo(m)})});
e=true;l(c.outfit.pet_type)});c.outfit.bind("updatePetType",l)};View.Title=function(c){c.base_pet.bind("updateName",function(l){$("#title").text("Planning "+l+"'s outfit")})};main_wardrobe=new Wardrobe;main_wardrobe.registerViews(View);main_wardrobe.initialize();